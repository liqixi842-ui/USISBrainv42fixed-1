/**
 * Test Financial Data Broker + History Chart Engine Integration
 * 
 * Verifies that real financial data and historical charts are properly integrated
 * into v3-dev research reports, eliminating N/A fields and placeholder charts.
 */

const { buildResearchReport } = require('./services/reportService.js');

async function testFinancialIntegration() {
  console.log(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
  console.log(`â•‘  Financial Data Broker + History Chart Engine Test - NVDA     â•‘`);
  console.log(`â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
  
  try {
    const symbol = 'NVDA';
    const assetType = 'equity';
    
    console.log(`ğŸ§ª [Test] Generating research report for ${symbol}...`);
    console.log(`   â””â”€ Financial data should be populated from FinancialDataBroker`);
    console.log(`   â””â”€ Historical charts should be generated by HistoryChartEngine\n`);
    
    const startTime = Date.now();
    const report = await buildResearchReport(symbol, assetType);
    const totalTime = Date.now() - startTime;
    
    console.log(`\nâœ… [Test] Report generated successfully in ${totalTime}ms`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Test 1: Verify Financial Data Fields
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log(`\nğŸ“Š [Test 1] Financial Data Verification`);
    
    const priceOK = report.price.last !== null;
    const marketCapOK = report.valuation.market_cap !== null;
    const peOK = report.valuation.pe_ttm !== null;
    const revenue5yOK = report.fundamentals.revenue_5y && report.fundamentals.revenue_5y.length > 0;
    const eps5yOK = report.fundamentals.eps_5y && report.fundamentals.eps_5y.length > 0;
    const roeOK = report.fundamentals.roe !== null;
    const roaOK = report.fundamentals.roa !== null;
    const revCAGROK = report.growth.revenue_cagr_3y !== null;
    const epsCAGROK = report.growth.eps_cagr_3y !== null;
    
    console.log(`   â”œâ”€ Price: ${report.price.last || 'N/A'} ${priceOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ Market Cap: ${report.valuation.market_cap ? '$' + (report.valuation.market_cap / 1e9).toFixed(1) + 'B' : 'N/A'} ${marketCapOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ PE TTM: ${report.valuation.pe_ttm || 'N/A'} ${peOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ Revenue 5Y: ${revenue5yOK ? report.fundamentals.revenue_5y.length + ' periods' : 'N/A'} ${revenue5yOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ EPS 5Y: ${eps5yOK ? report.fundamentals.eps_5y.length + ' periods' : 'N/A'} ${eps5yOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ ROE: ${report.fundamentals.roe || 'N/A'} ${roeOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ ROA: ${report.fundamentals.roa || 'N/A'} ${roaOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ Revenue 3Y CAGR: ${revCAGROK ? report.growth.revenue_cagr_3y.toFixed(2) + '%' : 'N/A'} ${revCAGROK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â””â”€ EPS 3Y CAGR: ${epsCAGROK ? report.growth.eps_cagr_3y.toFixed(2) + '%' : 'N/A'} ${epsCAGROK ? 'âœ…' : 'âŒ'}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Test 2: Verify Historical Charts
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log(`\nğŸ“ˆ [Test 2] Historical Charts Verification`);
    
    const revenueChartOK = report.charts && report.charts.revenue_5y && 
                           report.charts.revenue_5y.startsWith('http');
    const epsChartOK = report.charts && report.charts.eps_5y && 
                       report.charts.eps_5y.startsWith('http');
    const financialTrendsOK = report.charts && report.charts.financial_trends && 
                              report.charts.financial_trends.startsWith('http');
    
    console.log(`   â”œâ”€ Revenue 5Y Chart: ${revenueChartOK ? report.charts.revenue_5y.substring(0, 60) + '...' : 'MISSING'} ${revenueChartOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â”œâ”€ EPS 5Y Chart: ${epsChartOK ? report.charts.eps_5y.substring(0, 60) + '...' : 'MISSING'} ${epsChartOK ? 'âœ…' : 'âŒ'}`);
    console.log(`   â””â”€ Financial Trends Chart: ${financialTrendsOK ? report.charts.financial_trends.substring(0, 60) + '...' : 'MISSING'} ${financialTrendsOK ? 'âœ…' : 'âŒ'}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Test 3: Check for N/A or Placeholder Content
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log(`\nğŸ” [Test 3] N/A and Placeholder Detection`);
    
    const reportJSON = JSON.stringify(report);
    
    // Count N/A occurrences (excluding expected places like segments)
    const naCount = (reportJSON.match(/"N\/A"/g) || []).length;
    const nullCount = (reportJSON.match(/:\s*null/g) || []).length;
    
    // Check for placeholder chart content
    const hasPlaceholder = /placeholder|Placeholder|PLACEHOLDER/i.test(reportJSON);
    
    console.log(`   â”œâ”€ "N/A" string occurrences: ${naCount} ${naCount === 0 ? 'âœ…' : 'âš ï¸'}`);
    console.log(`   â”œâ”€ null value occurrences: ${nullCount} ${nullCount < 50 ? 'âœ…' : 'âš ï¸ (many nulls)'}`);
    console.log(`   â””â”€ Placeholder content: ${hasPlaceholder ? 'âŒ FOUND' : 'âœ… NONE'}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Test 4: Detailed Historical Data Analysis
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log(`\nğŸ“‹ [Test 4] Historical Data Detail`);
    
    if (revenue5yOK) {
      console.log(`\n   Revenue 5Y Series:`);
      report.fundamentals.revenue_5y.forEach(entry => {
        console.log(`      ${entry.year}: $${(entry.value / 1e9).toFixed(2)}B`);
      });
    }
    
    if (eps5yOK) {
      console.log(`\n   EPS 5Y Series:`);
      report.fundamentals.eps_5y.forEach(entry => {
        console.log(`      ${entry.year}: $${entry.value.toFixed(2)}`);
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Final Score
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
    console.log(`â•‘  âœ… Financial Data Broker + History Chart Engine Test Complete â•‘`);
    console.log(`â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
    
    const allChecks = [
      priceOK,
      marketCapOK,
      peOK,
      revenue5yOK,
      eps5yOK,
      roeOK,
      roaOK,
      revCAGROK,
      epsCAGROK,
      revenueChartOK,
      epsChartOK,
      financialTrendsOK
    ];
    
    const passedChecks = allChecks.filter(check => check).length;
    const totalChecks = allChecks.length;
    
    console.log(`\nğŸ“Š Final Score: ${passedChecks}/${totalChecks} checks passed`);
    
    if (passedChecks >= totalChecks - 2) {
      console.log(`\nâœ… INTEGRATION SUCCESSFUL - Financial data and charts working!\n`);
    } else if (passedChecks >= totalChecks / 2) {
      console.log(`\nâš ï¸  PARTIAL SUCCESS - Some features working, review failures\n`);
    } else {
      console.log(`\nâŒ INTEGRATION FAILED - Review module configuration\n`);
    }
    
  } catch (error) {
    console.error(`\nâŒ [Test] Error: ${error.message}`);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run test
testFinancialIntegration();
