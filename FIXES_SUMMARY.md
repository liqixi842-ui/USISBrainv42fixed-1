# ğŸ”§ USIS Brain v3 ä¿®å¤æ€»ç»“

## å·²ä¿®å¤çš„é—®é¢˜ (2025-11-03)

### âœ… é—®é¢˜1ï¼šå®æ—¶æ•°æ®ç¼ºå¤±ï¼ˆå·²ä¿®å¤ï¼‰
**ç—‡çŠ¶**: TSLAä»·æ ¼æ˜¾ç¤ºä¸º266ç¾å…ƒï¼ˆé”™è¯¯ï¼‰ï¼Œmarket_dataè¿”å›null
**æ ¹æœ¬åŸå› **: symbolså­—æ®µæœªè¢«æå–ï¼Œå¯¼è‡´collectMarketData()æœªè¢«è°ƒç”¨
**ä¿®å¤**: 
- æ·»åŠ  `extractSymbols(text)` å‡½æ•°è‡ªåŠ¨ä»æ–‡æœ¬ä¸­æå–è‚¡ç¥¨ä»£ç 
- ä¿®æ”¹orchestrateå‡½æ•°ï¼Œå½“ç”¨æˆ·æœªæä¾›symbolsæ—¶è‡ªåŠ¨æå–
- ç°åœ¨"ç›˜å‰TSLA"ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º["TSLA"]å¹¶è·å–å®æ—¶æ•°æ®

**ä»£ç å˜æ›´**:
```javascript
// æ–°å¢å‡½æ•° (ç¬¬523-532è¡Œ)
function extractSymbols(text = "") {
  const matches = text.match(/\b[A-Z]{1,5}\b/g) || [];
  const filtered = [...new Set(matches)].filter(s => 
    !['US', 'USD', 'PM', 'AM', ...].includes(s)
  );
  return filtered;
}

// orchestrateä¿®æ”¹ (ç¬¬1363-1365è¡Œ)
const extractedSymbols = extractSymbols(text);
const symbols = providedSymbols.length > 0 ? providedSymbols : extractedSymbols;
```

---

### âœ… é—®é¢˜2ï¼šæ–°é—»æ¨¡å¼è¿”å›é”™è¯¯å†…å®¹ï¼ˆå·²éƒ¨åˆ†ä¿®å¤ï¼‰
**ç—‡çŠ¶**: ç”¨æˆ·è¯·æ±‚"çƒ­ç‚¹æ–°é—»"ï¼Œä½†è¿”å›æŠ•èµ„åˆ†æè€Œéæ–°é—»åˆ—è¡¨
**æ ¹æœ¬åŸå› **: è™½ç„¶æ£€æµ‹åˆ°"æ–°é—»"å…³é”®è¯ï¼Œä½†æ‰€æœ‰AIä»ä½¿ç”¨æŠ•èµ„åˆ†æprompt
**ä¿®å¤**: 
- ä¿®æ”¹ `buildGPT4Prompt()` å‡½æ•°ï¼Œå½“mode === 'news'æ—¶è¿”å›æ–°é—»æ‘˜è¦prompt
- GPT-4ç°åœ¨ä¼šè¾“å‡ºç»“æ„åŒ–æ–°é—»åˆ—è¡¨è€ŒéæŠ•èµ„å»ºè®®

**ä»£ç å˜æ›´**:
```javascript
function buildGPT4Prompt(context, scene, chatType) {
  // æ–°é—»æ¨¡å¼æ£€æµ‹
  if (context.mode === 'news') {
    return `ä½ æ˜¯ä¸€ä½è´¢ç»æ–°é—»ç¼–è¾‘...åˆ—å‡º3-5æ¡æœ€é‡è¦çš„æ–°é—»...`;
  }
  // å¸¸è§„æŠ•èµ„åˆ†ææ¨¡å¼
  return `ä½ æ˜¯ä¸€ä½ç»¼åˆç­–ç•¥åˆ†æå¸ˆ...`;
}
```

---

### â³ é—®é¢˜3ï¼šå›¾ç‰‡ç”ŸæˆåŠŸèƒ½æ–­å¼€ï¼ˆå¾…ä¿®å¤ï¼‰
**ç—‡çŠ¶**: ç”¨æˆ·è¯·æ±‚"å¸¦çƒ­åŠ›å›¾çš„ç›˜å‰èµ„è®¯"ï¼Œä½†åªè¿”å›æ–‡å­—
**æ ¹æœ¬åŸå› **: orchestrateå‡½æ•°è¿”å›å›ºå®šçš„ `image_url: null`ï¼Œä»æœªè°ƒç”¨ `/img/imagine`
**è®¡åˆ’ä¿®å¤**:
- åœ¨orchestrateä¸­æ£€æµ‹å›¾ç‰‡éœ€æ±‚å…³é”®è¯ï¼ˆçƒ­åŠ›å›¾ã€å›¾è¡¨ã€æˆªå›¾ç­‰ï¼‰
- è‡ªåŠ¨è°ƒç”¨ `/img/imagine` ç”Ÿæˆå›¾ç‰‡
- å°†è¿”å›çš„image_urlåŒ…å«åœ¨å“åº”ä¸­

---

## N8Né›†æˆé…ç½®æ›´æ–°

### æ­£ç¡®çš„è¯·æ±‚æ ¼å¼

**æ—§ç‰ˆæœ¬** (ä¸å†éœ€è¦æ‰‹åŠ¨æå–symbols):
```json
{
  "text": "ç›˜å‰TSLA",
  "symbols": ["TSLA"],  // æ‰‹åŠ¨å¡«å†™
  "chat_type": "private"
}
```

**æ–°ç‰ˆæœ¬** (è‡ªåŠ¨æå–):
```json
{
  "text": "ç›˜å‰TSLA",  // è‡ªåŠ¨æå–TSLA
  "chat_type": "private",
  "user_id": "{{ $json.message.from.id }}"
}
```

### å“åº”å­—æ®µ

**å…³é”®å˜åŒ–**:
- âœ… `symbols`: ç°åœ¨è‡ªåŠ¨å¡«å……
- âœ… `market_data.collected`: ç°åœ¨ä¸ºtrueï¼ˆå¦‚æœæœ‰symbolsï¼‰
- âœ… `market_data.data.quotes`: åŒ…å«å®æ—¶ä»·æ ¼
- âœ… æ–°é—»æ¨¡å¼ä¼šè¿”å›ç»“æ„åŒ–æ–°é—»åˆ—è¡¨

---

## æµ‹è¯•æ­¥éª¤

1. **é‡æ–°å‘å¸ƒåº”ç”¨**
   ```
   ç‚¹å‡»Replitçš„"Republish"æŒ‰é’®
   ```

2. **æµ‹è¯•å®æ—¶æ•°æ®**
   ```bash
   POST https://node-js-liqixi842.replit.app/brain/orchestrate
   Body: {"text": "ç›˜å‰TSLA", "chat_type": "private"}
   
   é¢„æœŸ: symbols=["TSLA"], market_data.collected=true
   ```

3. **æµ‹è¯•æ–°é—»æ¨¡å¼**
   ```bash
   POST https://node-js-liqixi842.replit.app/brain/orchestrate
   Body: {"text": "ä»Šæ—¥çƒ­ç‚¹æ–°é—»", "chat_type": "private"}
   
   é¢„æœŸ: è¿”å›æ–°é—»åˆ—è¡¨æ ¼å¼
   ```

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

1. â³ ä¿®å¤å›¾ç‰‡ç”Ÿæˆé›†æˆ
2. â³ å¢å¼ºæ–°é—»æ•°æ®æºï¼ˆFinnhub news APIï¼‰
3. â³ æ·»åŠ å›¾ç‰‡éœ€æ±‚æ£€æµ‹é€»è¾‘
4. â³ å…¨é¢ç«¯åˆ°ç«¯æµ‹è¯•

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-03  
**ç‰ˆæœ¬**: v3.1 (æ•°æ®å¸å›½å±‚ä¿®å¤ç‰ˆ)
