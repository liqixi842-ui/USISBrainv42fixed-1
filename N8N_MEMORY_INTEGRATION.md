# N8N Memory Integration Guide

## ğŸ¯ ç›®æ ‡
N8Nä¸å†ç®¡ç†è®°å¿†ï¼Œåªè½¬å‘è¯·æ±‚ä¸å‘é€ç»“æœï¼Œæ”¯æŒ"æ¸…ç©ºè®°å¿†"å‘½ä»¤ã€‚

---

## âœ… éœ€è¦çš„N8Nè°ƒæ•´ï¼ˆæœ€å°åŒ–æ”¹åŠ¨ï¼‰

### 1. **Call_Brain_Orchestrate èŠ‚ç‚¹è°ƒæ•´**

**å½“å‰Bodyå‚æ•°ï¼ˆä¿æŒä¸å˜ï¼‰ï¼š**
```json
{
  "text": "={{ $json.message?.text || $json.text || 'default' }}",
  "chat_type": "={{ $json.message?.chat?.type || $json.chat_type || 'group' }}",
  "user_id": "={{ $json.message?.from?.id || $json.user_id || 'system' }}"
}
```

**âœ… ç¡®è®¤äº‹é¡¹ï¼š**
- âœ… å·²ç»åªä¼ é€’ `text`, `chat_type`, `user_id` ä¸‰ä¸ªå­—æ®µ
- âœ… **ä¸éœ€è¦**ä¼ é€’ `memories` å­—æ®µï¼ˆBrainè‡ªå·±ä»PostgreSQLè¯»å–ï¼‰
- âœ… **ä¸éœ€è¦**ä¿®æ”¹æ­¤èŠ‚ç‚¹

---

### 2. **æ–°å¢æ¸…ç©ºè®°å¿†åˆ†æ”¯ï¼ˆIF_ClearMemoryï¼‰**

**åœ¨ Telegram_Trigger ä¹‹åæ·»åŠ ï¼š**

```
Telegram_Trigger â†’ IF_ClearMemory
```

**IF_ClearMemory æ¡ä»¶ï¼š**
```javascript
={{ /æ¸…ç©ºè®°å¿†|reset memory|forget memory/i.test($json.message?.text || '') }}
```

**True åˆ†æ”¯æµç¨‹ï¼š**

1. **HTTP Request** èŠ‚ç‚¹ï¼ˆCall_Clear_Memoryï¼‰ï¼š
   - Method: `POST`
   - URL: `https://node-js-liqixi842.replit.app/brain/memory/clear`
   - Body:
     ```json
     {
       "user_id": "={{ $node['Telegram_Trigger'].json.message.from.id }}"
     }
     ```

2. **Telegram Send Message** èŠ‚ç‚¹ï¼ˆSend_Clear_Confirmationï¼‰ï¼š
   - Chat ID: `={{ $node['Telegram_Trigger'].json.message.chat.id }}`
   - Text: `âœ… å·²æ¸…ç©ºä½ çš„å†å²è®°å¿†ï¼ˆä»…å½±å“ä¸ªæ€§åŒ–åˆ†æï¼Œä¸å½±å“å®æ—¶å¸‚åœºæ•°æ®ï¼‰`

3. **åœ¨æ­¤åˆ†æ”¯ç»ˆæ­¢**ï¼ˆä¸å†èµ° orchestrate ä¸»æµç¨‹ï¼‰

**False åˆ†æ”¯ï¼š**
- è¿æ¥åˆ°åŸæœ‰çš„ `Call_Brain_Orchestrate` èŠ‚ç‚¹

---

### 3. **å…¶ä½™èŠ‚ç‚¹ä¿æŒä¸å˜**

- âœ… Parse_Brain_Response
- âœ… IF_Needs_Heatmap
- âœ… Screenshot_Heatmap
- âœ… Merge_Screenshot
- âœ… Pack_Final_Message
- âœ… IF_Send_Photo
- âœ… Send_With_Photo / Send_Text_Only

**è¿™äº›èŠ‚ç‚¹éƒ½ä¸éœ€è¦ä¿®æ”¹ã€‚**

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
Telegram_Trigger
    â†“
IF_ClearMemory
    â”œâ”€ True â†’ Call_Clear_Memory â†’ Send_Clear_Confirmation â†’ [ç»ˆæ­¢]
    â””â”€ False â†’ Call_Brain_Orchestrate
                    â†“
               Parse_Brain_Response
                    â†“
               IF_Needs_Heatmap
                    â”œâ”€ True â†’ Screenshot_Heatmap â†’ Normalize_Screenshot
                    â””â”€ False â†’ [ç›´æ¥ä¼ é€’]
                    â†“
               Merge_Screenshot
                    â†“
               Pack_Final_Message
                    â†“
               IF_Send_Photo
                    â”œâ”€ True â†’ Send_With_Photo
                    â””â”€ False â†’ Send_Text_Only
```

---

## ğŸ§ª å›å½’æµ‹è¯•

### **æµ‹è¯•1ï¼šè®°å¿†åŠŸèƒ½**
```
1. å‘é€ï¼šç›˜å‰NVDA
2. å‘é€ï¼šç›˜ä¸­TSLA
3. å‘é€ï¼šä¸ªè‚¡AAPL
4. å‘é€ï¼šä½ èƒ½å­¦ä¹ å—ï¼Ÿ
```

**é¢„æœŸç»“æœï¼š**
- ç¬¬4æ¡å›å¤ä¸­åº”åŒ…å«"æˆ‘ä¼šè®°ä½ä½ æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæœ€è¿‘3æ¡ï¼‰"
- Brainçš„console logåº”æ˜¾ç¤ºï¼š`ğŸ’¾ ç”¨æˆ·å†å²è®°å¿†: æ‰¾åˆ°3æ¡è®°å½•`

---

### **æµ‹è¯•2ï¼šæ¸…ç©ºè®°å¿†**
```
1. å‘é€ï¼šæ¸…ç©ºè®°å¿†
2. å‘é€ï¼šä½ èƒ½å­¦ä¹ å—ï¼Ÿ
```

**é¢„æœŸç»“æœï¼š**
- ç¬¬1æ¡æ”¶åˆ°ï¼š`âœ… å·²æ¸…ç©ºä½ çš„å†å²è®°å¿†...`
- ç¬¬2æ¡Brainçš„console logåº”æ˜¾ç¤ºï¼š`ğŸ’¾ ç”¨æˆ·å†å²è®°å¿†: æ‰¾åˆ°0æ¡è®°å½•`

---

### **æµ‹è¯•3ï¼šé‡å¤æ¶ˆæ¯ä¿®å¤éªŒè¯**
```
å‘é€ï¼šè¥¿ç­ç‰™çƒ­åŠ›å›¾
```

**é¢„æœŸç»“æœï¼š**
- **åªæ”¶åˆ°1æ¡**å›¾æ–‡æ¶ˆæ¯ï¼ˆä¸æ˜¯2æ¡æˆ–3æ¡ï¼‰

---

## ğŸ“‹ N8Nè°ƒæ•´æ¸…å•

- [ ] æ·»åŠ  `IF_ClearMemory` èŠ‚ç‚¹ï¼ˆTelegram_Triggerä¹‹åï¼‰
- [ ] æ·»åŠ  `Call_Clear_Memory` èŠ‚ç‚¹ï¼ˆHTTP Requeståˆ° `/brain/memory/clear`ï¼‰
- [ ] æ·»åŠ  `Send_Clear_Confirmation` èŠ‚ç‚¹ï¼ˆTelegramå‘é€ç¡®è®¤ï¼‰
- [ ] ç¡®è®¤ `Call_Brain_Orchestrate` åªä¼ 3ä¸ªå­—æ®µï¼ˆtext, chat_type, user_idï¼‰
- [ ] ç¡®è®¤ `IF_Send_Photo` ä½¿ç”¨ä¸¥æ ¼å¸ƒå°”åˆ¤æ–­ï¼ˆé¿å…é‡å¤æ¶ˆæ¯ï¼‰
- [ ] æµ‹è¯•è®°å¿†åŠŸèƒ½ï¼ˆè¿ç»­3æ¬¡æé—® + "ä½ èƒ½å­¦ä¹ å—ï¼Ÿ"ï¼‰
- [ ] æµ‹è¯•æ¸…ç©ºè®°å¿†ï¼ˆ"æ¸…ç©ºè®°å¿†" + éªŒè¯æ¸…ç©ºï¼‰

---

## ğŸ‰ å®Œæˆåçš„ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Replit Brain (å¤§è„‘ + è®°å¿†ä¸€ä½“)        â”‚
â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  6 AIæ¨¡å‹   â”‚â”€â”€â”€â†’â”‚ PostgreSQL   â”‚  â”‚
â”‚   â”‚  æ™ºèƒ½åˆ†æ   â”‚    â”‚  ç”¨æˆ·è®°å¿†    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“                               â”‚
â”‚    è¿”å›final_analysis                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    N8N (æ‰§è¡Œå™¨å®˜)
    - åªè½¬å‘è¯·æ±‚ï¼ˆuser_idï¼‰
    - æ‰§è¡Œactionsï¼ˆçƒ­åŠ›å›¾ã€æ–°é—»ç­‰ï¼‰
    - å‘é€æœ€ç»ˆæ¶ˆæ¯
```

---

## ğŸ’¡ å…³é”®åŸåˆ™

1. **N8N = ç¬”è®°æœ¬ âŒ**  â†’  **N8N = æ‰§è¡Œå™¨å®˜ âœ…**
2. **è®°å¿†å½’å±ï¼šBrainçš„PostgreSQLæ•°æ®åº“**
3. **N8NèŒè´£ï¼šè½¬å‘è¯·æ±‚ + æ‰§è¡Œå™¨å®˜æŒ‡ä»¤ + å‘é€ç»“æœ**
4. **å•ä¸€æ•°æ®æºï¼šæ‰€æœ‰è®°å¿†ç”±Brainç®¡ç†ï¼Œæ°¸ä¹…ä¿å­˜ï¼ŒReplité‡å¯ä¸ä¸¢å¤±**
