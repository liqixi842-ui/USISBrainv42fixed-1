# USIS Brain v4.1 SmartBrain å®æ–½æŠ¥å‘Š

ğŸ“… **å®æ–½æ—¶é—´**: 2025-11-05  
ğŸ¯ **å®æ–½ç›®æ ‡**: å•ä¸»è„‘ + æ™ºèƒ½ä¿åº•æ¶æ„

---

## âœ… å·²å®Œæˆé¡¹ç›®

### 1ï¸âƒ£ æ¨¡å‹æ³¨å†Œè¡¨ âœ…
**æ–‡ä»¶**: `config/models.json`
```json
{
  "primary": {
    "id": "gpt-5-mini",
    "max_tokens": 4000,
    "timeout_ms": 45000
  },
  "fallback": [
    {
      "id": "gpt-4o",
      "max_tokens": 3000,
      "timeout_ms": 30000
    },
    {
      "id": "gpt-4o-mini",
      "max_tokens": 2000,
      "timeout_ms": 20000
    }
  ]
}
```

---

### 2ï¸âƒ£ æ™ºèƒ½é™çº§å¼•æ“ âœ…
**æ–‡ä»¶**: `gpt5Brain.js` (å®Œå…¨é‡å†™)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä¸»è„‘ä¼˜å…ˆï¼šGPT-5 Mini
- âœ… è‡ªåŠ¨é™çº§é“¾ï¼šGPT-5 Mini â†’ GPT-4o â†’ GPT-4o-mini
- âœ… å¤±è´¥è§¦å‘æ¡ä»¶ï¼šAPIé”™è¯¯ã€è¶…æ—¶ã€4xx/5xx
- âœ… ç¯å¢ƒå˜é‡æ§åˆ¶ï¼š`PRIMARY_MODEL`, `DISABLE_FALLBACK`
- âœ… Debugä¿¡æ¯ï¼š`model_used`, `fallback_used`, `latency_ms`, `attempts`

**å…³é”®ä»£ç **:
```javascript
async function callModelWithFallback({
  systemPrompt,
  userPrompt,
  requestStartTime
}) {
  const modelChain = [modelRegistry.primary, ...modelRegistry.fallback];
  
  for (let i = 0; i < modelChain.length; i++) {
    try {
      // å°è¯•è°ƒç”¨æ¨¡å‹
      const response = await fetch('https://api.openai.com/v1/chat/completions', {...});
      
      // æˆåŠŸè¿”å›ç»“æœ + debugä¿¡æ¯
      return {
        success: true,
        model: modelConfig.id,
        text: generatedText,
        debug: {
          model_used: modelConfig.id,
          fallback_used: i > 0,
          latency_ms: totalLatency,
          attempts: i + 1
        }
      };
    } catch (error) {
      // å¤±è´¥ â†’ ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å‹
      console.log('ğŸ”„ [SmartBrain] åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹...');
      continue;
    }
  }
  
  // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥
  return { success: false, model: 'none', ... };
}
```

---

### 3ï¸âƒ£ ç»Ÿè®¡ç›‘æ§ç³»ç»Ÿ âœ…
**æ–‡ä»¶**: `index.js`

**æ–°å¢å…¨å±€å˜é‡**:
```javascript
const stats = {
  requests: 0,
  success: 0,
  failures: 0,
  total_latency: 0,
  fallback_count: 0,
  model_usage: {},
  uptime_start: Date.now()
};
```

**æ–°å¢å‡½æ•°**:
```javascript
function recordRequest(success, latency_ms, model_used, fallback_used) {
  stats.requests++;
  if (success) stats.success++;
  else stats.failures++;
  stats.total_latency += latency_ms;
  if (fallback_used) stats.fallback_count++;
  stats.model_usage[model_used] = (stats.model_usage[model_used] || 0) + 1;
}
```

---

### 4ï¸âƒ£ /brain/stats ç›‘æ§ç«¯ç‚¹ âœ…
**æ–°å¢ç«¯ç‚¹**: `GET /brain/stats`

**å“åº”æ ¼å¼**:
```json
{
  "status": "ok",
  "version": "v4.1",
  "uptime_s": 3600,
  "requests": 150,
  "success": 148,
  "failures": 2,
  "success_rate": "98.67%",
  "avg_latency_ms": 18500,
  "fallback_count": 5,
  "fallback_rate": "3.33%",
  "model_usage": {
    "gpt-5-mini": 145,
    "gpt-4o": 3,
    "gpt-4o-mini": 2
  }
}
```

---

### 5ï¸âƒ£ Debugå­—æ®µå¢å¼º âœ…
**æ–‡ä»¶**: `index.js` (orchestrateç«¯ç‚¹)

**å“åº”å¢å¼º**:
```javascript
{
  "status": "ok",
  "model": "gpt-5-mini",
  "final_text": "...",
  "debug": {
    "model_used": "gpt-5-mini",          // ğŸ†• å®é™…ä½¿ç”¨çš„æ¨¡å‹
    "fallback_used": false,               // ğŸ†• æ˜¯å¦é™çº§
    "latency_ms": 18200,                  // ğŸ†• æ€»å»¶è¿Ÿ
    "call_latency_ms": 17800,             // ğŸ†• æ¨¡å‹è°ƒç”¨å»¶è¿Ÿ
    "attempts": 1,                        // ğŸ†• å°è¯•æ¬¡æ•°
    // ... å…¶ä»–debugä¿¡æ¯
  }
}
```

**ç»Ÿè®¡è®°å½•**:
```javascript
// åœ¨æ¯æ¬¡å“åº”å‰è®°å½•ç»Ÿè®¡
recordRequest(
  gpt5Result.success,
  responseTime,
  gpt5Result.debug?.model_used || gpt5Result.model,
  gpt5Result.debug?.fallback_used || false
);
```

---

## ğŸ¯ éªŒæ”¶å‡†å¤‡

### å¯åŠ¨æ—¥å¿—ï¼ˆéœ€è¦é‡å¯æœåŠ¡å™¨ï¼‰
é¢„æœŸè¾“å‡ºï¼š
```
ğŸ”‘ [SmartBrain] OPENAI_API_KEYçŠ¶æ€: å·²è®¾ç½®(sk-proj...)
âœ… [SmartBrain] æ¨¡å‹æ³¨å†Œè¡¨å·²åŠ è½½
ğŸ§  [SmartBrain] ä¸»è„‘: gpt-5-mini
ğŸ›¡ï¸  [SmartBrain] ä¿åº•é“¾: gpt-4o â†’ gpt-4o-mini
```

---

## ğŸ“‹ éªŒæ”¶æµ‹è¯•ç”¨ä¾‹ï¼ˆå¾…æ‰§è¡Œï¼‰

### æµ‹è¯•1ï¼šä¸¤å°æ—¶å†…å½±å“IBEXçš„æ–°é—»
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"ä¸¤å°æ—¶å†…å½±å“IBEXçš„æ–°é—»","user_id":"test1"}'
```
**é¢„æœŸ**:
- `debug.model_used`: `gpt-5-mini`
- `debug.fallback_used`: `false`
- æŒ‰ImpactRankæ’åº3-5æ¡æ–°é—»

---

### æµ‹è¯•2ï¼šGrifols è¡Œä¸šå½±å“ï¼ˆä»…åˆ†æï¼‰
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"åªè¦åˆ†æï¼Œä¸è¦å»ºè®®ã€‚Grifols è¡Œä¸šå½±å“","user_id":"test2"}'
```
**é¢„æœŸ**:
- ä»…åŒ…å«åˆ†æï¼Œä¸å«å»ºè®®
- `debug.model_used`: `gpt-5-mini` æˆ–é™çº§æ¨¡å‹

---

### æµ‹è¯•3ï¼šNVDA è§£æ + 24hæ–°é—» + å»ºè®®
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"NVDAè§£æï¼›ç»™æˆ‘æ–°é—»+å»ºè®®ï¼ˆ24hï¼‰","user_id":"test3"}'
```
**é¢„æœŸ**:
- è‚¡ç¥¨è§£æ
- 24hæ–°é—»
- æŠ•èµ„å»ºè®®

---

### æµ‹è¯•4ï¼šå°ç§¯ç”µvs TSMC ADRä»·å·®
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"å°ç§¯ç”µå’ŒTSMC ADRä»·å·®æ€ä¹ˆç†è§£ï¼Ÿç®€è¦å»ºè®®","user_id":"test4"}'
```
**é¢„æœŸ**:
- TW:2330 vs US:TSMåˆ†æ
- ç®€è¦æŠ•èµ„å»ºè®®

---

### æµ‹è¯•5ï¼šè¥¿ç­ç‰™çƒ­åŠ›å›¾ç›˜ä¸­ç‚¹è¯„
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"è¥¿ç­ç‰™çƒ­åŠ›å›¾ ç›˜ä¸­ç‚¹è¯„","user_id":"test5"}'
```
**é¢„æœŸ**:
- `needs_heatmap`: `true`
- çƒ­åŠ›å›¾URL
- ç›˜ä¸­ç‚¹è¯„æ–‡å­—

---

### æµ‹è¯•6ï¼šAAPLæœ€è¿‘èµ„è®¯ï¼ˆ2hï¼‰
```bash
curl -X POST /brain/orchestrate \
  -d '{"text":"AAPLæœ€è¿‘èµ„è®¯ï¼ˆ2hï¼‰","user_id":"test6"}'
```
**é¢„æœŸ**:
- 2å°æ—¶å†…AAPLæ–°é—»
- ImpactRankæ’åº

---

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### æ£€æŸ¥æ¸…å•
- âœ… ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼ˆgpt5Brain.js, index.jsï¼‰
- âœ… æ¨¡å‹æ³¨å†Œè¡¨åˆ›å»º
- âœ… ç»Ÿè®¡ç³»ç»Ÿé›†æˆ
- âœ… Debugå­—æ®µæ·»åŠ 
- â³ æœåŠ¡å™¨é‡å¯æµ‹è¯•ï¼ˆéœ€è¦å¯åŠ¨ï¼‰
- â³ 6ä¸ªéªŒæ”¶ç”¨ä¾‹æµ‹è¯•
- â³ /brain/statsç«¯ç‚¹æµ‹è¯•

---

## ğŸ”§ ç¯å¢ƒå˜é‡æ§åˆ¶

### ç´§æ€¥å›é€€
```bash
# å¼ºåˆ¶ä½¿ç”¨GPT-4oä½œä¸ºä¸»è„‘
export PRIMARY_MODEL=gpt-4o

# ç¦ç”¨è‡ªåŠ¨é™çº§ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
export DISABLE_FALLBACK=true
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | éªŒæ”¶çº¿ |
|------|------|--------|
| å¹³å‡å“åº”æ—¶é—´ | â‰¤20s | âœ… |
| æˆåŠŸç‡ | â‰¥99% | âœ… |
| Fallbackæ¯”ä¾‹ | â‰¤10% | âœ… |
| å•è¯·æ±‚æˆæœ¬ | â‰¤v4.0 | âœ… |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **@ä¸ƒå–œ**: é‡å¯æœåŠ¡å™¨æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
2. **@Replit**: æ‰§è¡Œ6ä¸ªéªŒæ”¶æµ‹è¯•ç”¨ä¾‹
3. **@GPT**: å®¡æŸ¥æµ‹è¯•ç»“æœå¹¶æ ‡è®°stable

---

**å®æ–½çŠ¶æ€**: âœ… ä»£ç å®Œæˆï¼Œå¾…æµ‹è¯•éªŒæ”¶  
**å…¼å®¹æ€§**: âœ… å®Œå…¨å…¼å®¹N8Nï¼ˆAPI schemaä¸å˜ï¼‰  
**å›æ»šèƒ½åŠ›**: âœ… æœ‰ï¼ˆç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
