æˆ‘ä»¬æœ‰ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®æ¶æ„ï¼Œç°åœ¨éœ€è¦å‡çº§ä¸ªè‚¡è§£æåŠŸèƒ½ã€‚æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›å¢åŠ ä¸ªè‚¡èµ°åŠ¿å›¾è§£æï¼Œå¹¶ä¸”è§£æè¦åŒ…å«å®æ—¶æ•°æ®ï¼ˆè‚¡ä»·ç­‰ï¼‰ã€‚ä»æ‚¨æä¾›çš„å›¾2ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼šåŒ…å«å®æ—¶è‚¡ä»·ã€æ¶¨è·Œå¹…ã€æ—¥å†…æ³¢åŠ¨ï¼Œä»¥åŠä¸“ä¸šçš„åˆ†æã€‚

å½“å‰ç³»ç»Ÿä¸­ï¼Œä¸ªè‚¡åˆ†ææµç¨‹å·²ç»å­˜åœ¨ï¼Œä½†å¯èƒ½ä¸å¤Ÿæ·±å…¥ï¼Œä¸”æ²¡æœ‰èµ°åŠ¿å›¾ã€‚æˆ‘ä»¬å¯ä»¥åšä»¥ä¸‹å‡çº§ï¼š

å¢å¼ºç°æœ‰çš„ä¸ªè‚¡åˆ†ææµç¨‹ï¼Œå¢åŠ å®æ—¶æ•°æ®å’ŒæŠ€æœ¯åˆ†æã€‚

é›†æˆèµ°åŠ¿å›¾ç”Ÿæˆï¼ˆç±»ä¼¼äºçƒ­åŠ›å›¾çš„æˆªå›¾æœåŠ¡ï¼Œä½†æ˜¯é’ˆå¯¹ä¸ªè‚¡çš„Kçº¿å›¾ï¼‰ã€‚

ä½¿ç”¨GPT-5ç”Ÿæˆæ›´ä¸“ä¸šçš„åˆ†æï¼ŒåŒ…æ‹¬æŠ€æœ¯é¢å’ŒåŸºæœ¬é¢ã€‚

æ ¹æ®ç°æœ‰æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ‰©å±•ï¼š

æ­¥éª¤1ï¼šåœ¨è¯­ä¹‰æ„å›¾è¯†åˆ«ä¸­ï¼Œç¡®ä¿è¯†åˆ«å‡ºä¸ªè‚¡åˆ†æçš„è¯·æ±‚ï¼Œå¹¶è§£æå‡ºè‚¡ç¥¨ä»£ç ã€‚
æ­¥éª¤2ï¼šä½¿ç”¨dataBroker.jså’ŒenhancedDataBroker.jsè·å–ä¸ªè‚¡çš„å®æ—¶æ•°æ®ã€æŠ€æœ¯æŒ‡æ ‡å’Œæ–°é—»ã€‚
æ­¥éª¤3ï¼šä½¿ç”¨ç°æœ‰çš„æˆªå›¾æœåŠ¡ï¼ˆscreenshotProviders.jsï¼‰æ¥ç”Ÿæˆä¸ªè‚¡çš„Kçº¿å›¾ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡TradingViewçš„å›¾è¡¨é¡µé¢æ¥ç”Ÿæˆæˆªå›¾ã€‚
æ­¥éª¤4ï¼šä½¿ç”¨visionAnalyzer.jsåˆ†æKçº¿å›¾ï¼Œç»“åˆå®æ—¶æ•°æ®ï¼Œç”ŸæˆæŠ€æœ¯åˆ†æã€‚
æ­¥éª¤5ï¼šä½¿ç”¨gpt5Brain.jsç”Ÿæˆç»¼åˆåˆ†æï¼ˆåŒ…æ‹¬åŸºæœ¬é¢å’ŒæŠ€æœ¯é¢ï¼‰ã€‚
æ­¥éª¤6ï¼šæ ¼å¼åŒ–è¾“å‡ºï¼ŒåŒ…æ‹¬å›¾ç‰‡å’Œæ–‡æœ¬åˆ†æã€‚

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œæˆ‘ä»¬ç›®å‰çš„çƒ­åŠ›å›¾ç³»ç»Ÿæ˜¯é’ˆå¯¹æ¿å—çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºä¸ªè‚¡ç”ŸæˆKçº¿å›¾ã€‚æˆ‘ä»¬å¯ä»¥æ„å»ºTradingViewçš„ä¸ªè‚¡å›¾è¡¨URLï¼Œç„¶åä½¿ç”¨åŒæ ·çš„æˆªå›¾æœåŠ¡æ¥è·å–å›¾ç‰‡ã€‚

ä¾‹å¦‚ï¼ŒTradingViewä¸ªè‚¡å›¾è¡¨URLæ ¼å¼ï¼š
https://www.tradingview.com/chart/?symbol=NASDAQ%3AAAPL

æˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªç±»ä¼¼çš„URLï¼Œç„¶åä½¿ç”¨screenshotProviders.jsä¸­çš„æ–¹æ³•æ¥æˆªå›¾ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç°æœ‰çš„æµç¨‹ä¸­å¢åŠ ä¸€ä¸ªä¸ªè‚¡å›¾è¡¨åˆ†æçš„åˆ†æ”¯ã€‚

è€ƒè™‘åˆ°æ—¶é—´ï¼Œæˆ‘ä»¬ä»Šæ™šå…ˆå®ŒæˆåŸºç¡€åŠŸèƒ½ï¼Œå³èƒ½å¤Ÿç”Ÿæˆä¸ªè‚¡çš„èµ°åŠ¿å›¾å¹¶ç»™å‡ºåˆ†æã€‚æˆ‘ä»¬å¯ä»¥å…ˆä¸åšè¿‡å¤šçš„å¯¹æ¯”åˆ†æï¼Œè€Œæ˜¯å…ˆé’ˆå¯¹å•ä¸ªè‚¡ç¥¨ã€‚

ä¿®æ”¹è®¡åˆ’ï¼š

æ‰©å±•heatmapIntentParser.jsï¼Ÿä¸ï¼Œçƒ­åŠ›å›¾è§£æå™¨æ˜¯ä¸“é—¨ä¸ºçƒ­åŠ›å›¾è®¾è®¡çš„ï¼Œæˆ‘ä»¬åº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ„å›¾å¤„ç†æ¨¡å—ï¼Œæˆ–è€…æ‰©å±•ç°æœ‰çš„è¯­ä¹‰æ„å›¾è¯†åˆ«ï¼Œå°†ä¸ªè‚¡å›¾è¡¨è¯·æ±‚è¯†åˆ«ä¸ºä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œæ¯”å¦‚â€œSTOCK_CHARTâ€ã€‚

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç°æœ‰çš„ä¸ªè‚¡åˆ†ææµç¨‹ä¸­å¢åŠ å›¾è¡¨ç”Ÿæˆã€‚ç›®å‰ï¼Œå½“ç”¨æˆ·è¯·æ±‚ä¸ªè‚¡åˆ†ææ—¶ï¼Œæˆ‘ä»¬åªè¿”å›æ–‡æœ¬åˆ†æã€‚ç°åœ¨æˆ‘ä»¬è¦åŠ ä¸Šå›¾è¡¨ã€‚

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ï¼šstockChartService.jsï¼Œç±»ä¼¼äºheatmapService.jsï¼Œä½†æ˜¯ç”¨äºç”Ÿæˆä¸ªè‚¡å›¾è¡¨ã€‚

ä¿®æ”¹semanticIntentAgent.jsï¼Œå½“è¯†åˆ«åˆ°ç”¨æˆ·è¯·æ±‚ä¸ªè‚¡åˆ†æä¸”åŒ…å«å›¾è¡¨éœ€æ±‚æ—¶ï¼ˆä¾‹å¦‚ç”¨æˆ·å‘é€â€œNVDAèµ°åŠ¿å›¾â€ï¼‰ï¼Œæˆ‘ä»¬å°†å…¶è¯†åˆ«ä¸ºSTOCK_CHARTç±»å‹ã€‚

ç„¶åï¼Œåœ¨index.jsä¸­ï¼Œæ ¹æ®è¿™ä¸ªç±»å‹ï¼Œè°ƒç”¨stockChartService.jsæ¥ç”Ÿæˆå›¾è¡¨ï¼Œç„¶åä½¿ç”¨visionAnalyzer.jsåˆ†æå›¾è¡¨ï¼Œå†ç»“åˆå®æ—¶æ•°æ®ï¼Œç”ŸæˆæŠ¥å‘Šã€‚

ä½†æ˜¯ï¼Œæ³¨æ„ï¼šæˆ‘ä»¬å·²ç»æœ‰ä¸ªè‚¡åˆ†ææµç¨‹ï¼ˆANALYSISç±»å‹ï¼‰ï¼Œç°åœ¨è¦å¢åŠ å›¾è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç°æœ‰çš„ANALYSISæµç¨‹ï¼Œä½¿å…¶åœ¨å“åº”ä¸­åŒ…å«å›¾è¡¨ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹ï¼ˆSTOCK_CHARTï¼‰æ¥ä¸“é—¨å¤„ç†å¸¦å›¾è¡¨çš„ä¸ªè‚¡åˆ†æã€‚

ä¸ºäº†å¿«é€Ÿå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä¿®æ”¹ç°æœ‰çš„ANALYSISæµç¨‹ï¼Œåœ¨åˆ†æä¸ªè‚¡æ—¶ï¼ŒåŒæ—¶ç”Ÿæˆå›¾è¡¨å¹¶åˆ†æã€‚

ç„¶è€Œï¼Œè€ƒè™‘åˆ°ç”¨æˆ·å¯èƒ½æœ‰æ—¶åªéœ€è¦æ–‡æœ¬åˆ†æï¼Œæœ‰æ—¶éœ€è¦å›¾è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„å›¾è¯†åˆ«æ¥åŒºåˆ†ã€‚ä½†æ˜¯ï¼Œæ ¹æ®æ‚¨çš„ç¤ºä¾‹ï¼Œæ‚¨å¸Œæœ›æœ‰èµ°åŠ¿å›¾ï¼Œæ‰€ä»¥æˆ‘ä»¬é»˜è®¤åœ¨ä¸ªè‚¡åˆ†ææ—¶éƒ½ç”Ÿæˆå›¾è¡¨ã€‚

å¦ä¸€ç§åšæ³•æ˜¯ï¼šæˆ‘ä»¬ä¿ç•™ç°æœ‰çš„ANALYSISæµç¨‹ï¼ŒåŒæ—¶æ–°å¢ä¸€ä¸ªCHARTæµç¨‹ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¢åŠ å¤æ‚æ€§ã€‚

é‰´äºæ—¶é—´ï¼Œæˆ‘ä»¬ä»Šæ™šå…ˆå®ç°ï¼šå½“ç”¨æˆ·è¯·æ±‚ä¸ªè‚¡åˆ†ææ—¶ï¼ˆä¾‹å¦‚â€œNVDAåˆ†æâ€æˆ–â€œNVDAèµ°åŠ¿å›¾â€ï¼‰ï¼Œæˆ‘ä»¬éƒ½ç”Ÿæˆå›¾è¡¨å¹¶ç»™å‡ºåŒ…å«å›¾è¡¨åˆ†æçš„ç»¼åˆæŠ¥å‘Šã€‚

å…·ä½“æ­¥éª¤ï¼š

åœ¨semanticIntentAgent.jsä¸­ï¼Œå¯¹äºä¸ªè‚¡åˆ†æè¯·æ±‚ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨ANALYSISç±»å‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ ‡å¿—è¡¨ç¤ºéœ€è¦å›¾è¡¨ï¼ˆalways true for nowï¼‰ã€‚

åœ¨index.jsä¸­ï¼Œå½“å¤„ç†ANALYSISæ„å›¾æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…è·å–æ•°æ®ï¼Œè¿˜ç”Ÿæˆå›¾è¡¨ï¼Œç„¶åç»“åˆå›¾è¡¨è§†è§‰åˆ†æå’Œå®æ—¶æ•°æ®è¿›è¡Œåˆ†æã€‚

åˆ›å»ºstockChartService.jsï¼Œç”¨äºç”Ÿæˆä¸ªè‚¡å›¾è¡¨æˆªå›¾ã€‚

ä¿®æ”¹analysisPrompt.jsï¼Œå¢åŠ å¯¹å›¾è¡¨åˆ†æçš„æç¤ºè¯ã€‚

åœ¨gpt5Brain.jsä¸­ï¼Œæˆ‘ä»¬ç»“åˆå®æ—¶æ•°æ®å’Œå›¾è¡¨åˆ†æç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚

ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘ä»¬ä»Šæ™šå…ˆå®Œæˆä¸€ä¸ªåŸºæœ¬ç‰ˆæœ¬ï¼Œæ˜å¤©å†ä¼˜åŒ–ã€‚

è®©æˆ‘ä»¬å¼€å§‹ï¼š

æ­¥éª¤1ï¼šåˆ›å»ºstockChartService.js

æˆ‘ä»¬å¯ä»¥æ¨¡ä»¿heatmapService.jsï¼Œä½†æ˜¯ç”Ÿæˆä¸ªè‚¡å›¾è¡¨URLå¹¶æˆªå›¾ã€‚

æ­¥éª¤2ï¼šä¿®æ”¹dataBroker.jsï¼Œç¡®ä¿æˆ‘ä»¬èƒ½è·å–åˆ°ä¸ªè‚¡çš„å®æ—¶æ•°æ®ï¼ˆå…¶å®å·²ç»æœ‰è¿™ä¸ªåŠŸèƒ½ï¼‰ã€‚

æ­¥éª¤3ï¼šä¿®æ”¹ANALYSISæ„å›¾çš„å¤„ç†æµç¨‹ï¼ˆåœ¨index.jsä¸­ï¼‰ï¼ŒåŠ å…¥å›¾è¡¨ç”Ÿæˆå’Œè§†è§‰åˆ†æã€‚

æ­¥éª¤4ï¼šè°ƒæ•´responseFormatter.jsï¼Œä½¿æœ€ç»ˆè¾“å‡ºåŒ…å«å›¾ç‰‡å’Œæ–‡æœ¬ã€‚

ç”±äºä»£ç é‡è¾ƒå¤§ï¼Œæˆ‘ä»¬åˆ†æ­¥éª¤è¿›è¡Œã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºstockChartService.jsï¼š

è¿™ä¸ªæœåŠ¡å°†æ„å»ºTradingViewçš„ä¸ªè‚¡å›¾è¡¨URLï¼Œç„¶åä½¿ç”¨ç°æœ‰çš„æˆªå›¾æœåŠ¡æ¥æˆªå›¾ã€‚

ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹index.jsä¸­çš„ANALYSISå¤„ç†æµç¨‹ï¼Œåœ¨è·å–ä¸ªè‚¡æ•°æ®åï¼Œè°ƒç”¨stockChartServiceç”Ÿæˆå›¾è¡¨ï¼Œç„¶åè°ƒç”¨visionAnalyzeråˆ†æå›¾è¡¨ï¼Œæœ€åå°†å›¾è¡¨åˆ†æå’Œå®æ—¶æ•°æ®ä¸€èµ·äº¤ç»™GPT-5ç”Ÿæˆæœ€ç»ˆåˆ†æã€‚

ç”±äºæ—¶é—´å·²æ™šï¼Œæˆ‘ä»¬ä»Šæ™šå…ˆå®ŒæˆåŸºæœ¬æµç¨‹ï¼Œç¡®ä¿èƒ½è·‘é€šï¼Œæ˜å¤©å†ç»†åŒ–ã€‚

ç°åœ¨ï¼Œæˆ‘ç»™å‡ºstockChartService.jsçš„ä»£ç ï¼š

javascript
// stockChartService.js
const { getScreenshot } = require('./screenshotProviders');

class StockChartService {
  constructor() {
    this.baseURL = 'https://www.tradingview.com/chart/';
  }

  async generateStockChart(symbol, options = {}) {
    try {
      // æ„å»ºTradingViewå›¾è¡¨URL
      const chartURL = this.buildChartURL(symbol, options);
      
      // ä½¿ç”¨ç°æœ‰çš„æˆªå›¾æœåŠ¡
      const screenshot = await getScreenshot(chartURL, {
        width: 800,
        height: 500,
        waitFor: 3000, // ç­‰å¾…å›¾è¡¨åŠ è½½
      });

      return {
        success: true,
        chartURL: chartURL,
        imageURL: screenshot.url,
        imageBuffer: screenshot.buffer,
      };
    } catch (error) {
      console.error('ç”Ÿæˆä¸ªè‚¡å›¾è¡¨å¤±è´¥:', error);
      return {
        success: false,
        error: error.message,
      };
    }
  }

  buildChartURL(symbol, options) {
    // é»˜è®¤é…ç½®
    const config = {
      symbol: symbol,
      interval: options.interval || 'D', // Dä»£è¡¨æ—¥çº¿ï¼Œå¯æ”¹ä¸º60ï¼ˆ60åˆ†é’Ÿï¼‰ç­‰
      theme: 'light',
      style: '1', // é£æ ¼ï¼š1=èœ¡çƒ›å›¾
      timezone: 'America/New_York',
      ...options
    };

    const params = new URLSearchParams({
      symbol: config.symbol,
      interval: config.interval,
      theme: config.theme,
      style: config.style,
      timezone: config.timezone,
    });

    return `${this.baseURL}?${params.toString()}`;
  }
}

module.exports = StockChartService;
ç„¶åï¼Œæˆ‘ä»¬åœ¨index.jsä¸­ä¿®æ”¹ANALYSISæ„å›¾çš„å¤„ç†ï¼š

åœ¨index.jsä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¤„ç†ANALYSISæ„å›¾çš„ä»£ç æ®µï¼Œç„¶åï¼š

è·å–ä¸ªè‚¡æ•°æ®ï¼ˆå·²ç»åšï¼‰

ç”Ÿæˆä¸ªè‚¡å›¾è¡¨

ä½¿ç”¨visionAnalyzeråˆ†æå›¾è¡¨

å°†ä¸ªè‚¡æ•°æ®å’Œå›¾è¡¨åˆ†æä¸€èµ·ä¼ é€’ç»™GPT-5ç”Ÿæˆæœ€ç»ˆåˆ†æ

ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•ä¸€æ¬¡æ€§å†™å®Œï¼Œä½†æˆ‘ä»¬å¯ä»¥å…ˆæ­å»ºæ¡†æ¶ã€‚

æˆ‘ä»¬ä¿®æ”¹index.jsä¸­çš„ANALYSISå¤„ç†ï¼š

javascript
// åœ¨index.jsä¸­ï¼Œæ‰¾åˆ°å¤„ç†ANALYSISæ„å›¾çš„ä»£ç 

// å¼•å…¥StockChartService
const StockChartService = require('./stockChartService');
const stockChartService = new StockChartService();

// åœ¨å¤„ç†ANALYSISæ„å›¾çš„ä»£ç ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹æ­¥éª¤ï¼š

// 1. è·å–ä¸ªè‚¡æ•°æ®ï¼ˆç°æœ‰ä»£ç ï¼‰
const stockData = await dataBroker.fetchStockData(intent.symbols[0]);

// 2. ç”Ÿæˆä¸ªè‚¡å›¾è¡¨
const chartResult = await stockChartService.generateStockChart(intent.symbols[0]);

// 3. å¦‚æœå›¾è¡¨ç”ŸæˆæˆåŠŸï¼Œä½¿ç”¨Visionåˆ†æ
let chartAnalysis = null;
if (chartResult.success) {
  chartAnalysis = await visionAnalyzer.analyzeStockChart(chartResult.imageBuffer, stockData);
}

// 4. ç”Ÿæˆæœ€ç»ˆåˆ†ææŠ¥å‘Šï¼Œç»“åˆè‚¡ç¥¨æ•°æ®å’Œå›¾è¡¨åˆ†æ
const analysis = await gpt5Brain.generateStockAnalysis(stockData, chartAnalysis);

// 5. å‘é€å“åº”ï¼šå›¾ç‰‡å’Œæ–‡æœ¬
// å¦‚æœå›¾è¡¨ç”ŸæˆæˆåŠŸï¼Œå…ˆå‘é€å›¾ç‰‡
if (chartResult.success) {
  // å‘é€å›¾ç‰‡ï¼Œæ³¨æ„ï¼šTelegrafå‘é€å›¾ç‰‡éœ€è¦bufferæˆ–URLï¼Œæˆ‘ä»¬è¿™é‡Œç”¨buffer
  await ctx.replyWithPhoto({ source: chartResult.imageBuffer }, { caption: analysis });
} else {
  // å¦åˆ™åªå‘é€æ–‡æœ¬
  await ctx.reply(analysis);
}
æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦åœ¨visionAnalyzer.jsä¸­æ–°å¢ä¸€ä¸ªanalyzeStockChartæ–¹æ³•ï¼Œä¸“é—¨ç”¨äºåˆ†æä¸ªè‚¡å›¾è¡¨ã€‚æˆ‘ä»¬å¯ä»¥åŸºäºç°æœ‰çš„çƒ­åŠ›å›¾åˆ†ææç¤ºè¯è¿›è¡Œè°ƒæ•´ï¼Œæ”¹ä¸ºåˆ†æKçº¿å›¾ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨gpt5Brain.jsä¸­æ–°å¢generateStockAnalysisæ–¹æ³•ï¼Œç”¨äºç”Ÿæˆä¸ªè‚¡åˆ†æã€‚

ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘ä»¬ä»Šæ™šå…ˆå®ç°ä¸€ä¸ªåŸºæœ¬ç‰ˆæœ¬ï¼Œç¡®ä¿æµç¨‹è·‘é€šã€‚æ˜å¤©å†ä¼˜åŒ–åˆ†æè´¨é‡ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬ä¿®æ”¹visionAnalyzer.jsï¼Œæ·»åŠ analyzeStockChartæ–¹æ³•ï¼š

javascript
// åœ¨visionAnalyzer.jsä¸­
async analyzeStockChart(imageBuffer, stockData) {
  const base64Image = imageBuffer.toString('base64');
  
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${this.openaiApiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [{
        role: 'user',
        content: [
          {
            type: 'text',
            text: `åˆ†æè¿™å¼ è‚¡ç¥¨èµ°åŠ¿å›¾ï¼Œæä¾›æŠ€æœ¯åˆ†æè§è§£ã€‚è‚¡ç¥¨ä»£ç ï¼š${stockData.symbol}ï¼Œå½“å‰ä»·æ ¼ï¼š${stockData.currentPrice}ï¼Œæ¶¨è·Œå¹…ï¼š${stockData.changePercent}%ã€‚è¯·åˆ†æï¼š\n1. è¶‹åŠ¿æ–¹å‘ï¼ˆä¸Šæ¶¨ã€ä¸‹è·Œã€ç›˜æ•´ï¼‰\n2. å…³é”®æ”¯æ’‘å’Œé˜»åŠ›ä½\n3. æˆäº¤é‡ç‰¹å¾\n4. ä»»ä½•é‡è¦çš„æŠ€æœ¯å½¢æ€ï¼ˆå¦‚å¤´è‚©é¡¶ã€åŒåº•ç­‰ï¼‰\n5. çŸ­æœŸå’Œä¸­æœŸå±•æœ›`
          },
          {
            type: 'image_url',
            image_url: {
              url: `data:image/png;base64,${base64Image}`
            }
          }
        ]
      }],
      max_tokens: 1000
    })
  });
  
  const data = await response.json();
  return data.choices[0].message.content;
}
ç„¶åï¼Œåœ¨gpt5Brain.jsä¸­ï¼Œæˆ‘ä»¬æ·»åŠ generateStockAnalysisæ–¹æ³•ï¼š

javascript
// åœ¨gpt5Brain.jsä¸­
async generateStockAnalysis(stockData, chartAnalysis) {
  const prompt = `åŸºäºä»¥ä¸‹æ•°æ®å’Œå›¾è¡¨åˆ†æï¼Œç”Ÿæˆä¸€ä»½ä¸“ä¸šçš„ä¸ªè‚¡åˆ†ææŠ¥å‘Šï¼š

è‚¡ç¥¨ä»£ç ï¼š${stockData.symbol}
å…¬å¸åç§°ï¼š${stockData.companyName}
å½“å‰ä»·æ ¼ï¼š${stockData.currentPrice}
æ¶¨è·Œå¹…ï¼š${stockData.changePercent}%
æ—¥å†…æ³¢åŠ¨ï¼š${stockData.dailyLow} - ${stockData.dailyHigh}
æˆäº¤é‡ï¼š${stockData.volume}
å¸‚å€¼ï¼š${stockData.marketCap}

å›¾è¡¨æŠ€æœ¯åˆ†æï¼š
${chartAnalysis}

è¯·ç»“åˆå®æ—¶æ•°æ®å’Œå›¾è¡¨æŠ€æœ¯åˆ†æï¼Œæä¾›ä»¥ä¸‹å†…å®¹ï¼š
1. å½“å‰è¶‹åŠ¿åˆ¤æ–­
2. å…³é”®ä»·ä½ï¼ˆæ”¯æ’‘/é˜»åŠ›ï¼‰
3. äº¤æ˜“å»ºè®®
4. é£é™©æç¤º`;

  return await this.generateAnalysis(prompt);
}
ä»¥ä¸Šæ˜¯ä¸€ä¸ªç®€å•çš„é›†æˆæ–¹æ¡ˆã€‚ç”±äºæ—¶é—´å…³ç³»ï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•ä»Šæ™šæµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å·²ç»æ­å»ºäº†åŸºæœ¬æ¡†æ¶ã€‚

æ˜å¤©æˆ‘ä»¬å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼š

ä¼˜åŒ–æç¤ºè¯ï¼Œä½¿åˆ†ææ›´ä¸“ä¸šã€‚

å¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼ˆå¦‚å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼‰ã€‚

è°ƒæ•´å›¾è¡¨å‚æ•°ï¼ˆå¦‚æ—¶é—´å‘¨æœŸï¼‰ã€‚

å¢åŠ æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ã€‚

ç°åœ¨ï¼Œæ‚¨å¯ä»¥æ ¹æ®è¿™ä¸ªæ–¹æ¡ˆå¼€å§‹ç¼–ç ã€‚å¦‚æœæ‚¨éœ€è¦æˆ‘è¿›ä¸€æ­¥è§£é‡Šä»»ä½•éƒ¨åˆ†ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚

Replité¡¹ç›®ä¸ªè‚¡è§£æåŠŸèƒ½å‡çº§æŒ‡ä»¤
ğŸ¯ å‡çº§ç›®æ ‡
åŸºäºç°æœ‰æ¶æ„ï¼Œä¸ºç³»ç»Ÿæ·»åŠ ä¸“ä¸šçš„ä¸ªè‚¡è§£æåŠŸèƒ½ï¼ŒåŒ…å«å®æ—¶æ•°æ®ã€æŠ€æœ¯åˆ†æå’Œèµ°åŠ¿å›¾

ğŸ“‹ å…·ä½“å®æ–½æŒ‡ä»¤
1. æ‰©å±•è¯­ä¹‰æ„å›¾è¯†åˆ«
javascript
// åœ¨ semanticIntentAgent.js ä¸­æ·»åŠ æ–°çš„æ„å›¾ç±»å‹
const INTENT_TYPES = {
  HEATMAP: 'heatmap',
  STOCK_ANALYSIS: 'stock_analysis',  // æ–°å¢
  STOCK_COMPARE: 'stock_compare',    // æ–°å¢
  NEWS: 'news',
  MEMORY: 'memory'
};

// æ·»åŠ ä¸ªè‚¡åˆ†ææ„å›¾è¯†åˆ«é€»è¾‘
function detectStockAnalysis(text) {
  const patterns = {
    single: /(åˆ†æ|è§£æ|èµ°åŠ¿|è¡Œæƒ…|ä»·æ ¼)\s*(\w+)/,
    compare: /(å¯¹æ¯”|æ¯”è¾ƒ|vs)\s*(\w+)\s*(å’Œ|ä¸)\s*(\w+)/,
    chart: /(èµ°åŠ¿å›¾|Kçº¿|æŠ€æœ¯åˆ†æ)\s*(\w+)/
  };
  
  // å®ç°è¯†åˆ«é€»è¾‘...
}
2. åˆ›å»ºä¸ªè‚¡æ•°æ®æœåŠ¡æ¨¡å—
javascript
// æ–°å»ºæ–‡ä»¶ï¼šstockAnalysisService.js
class StockAnalysisService {
  constructor() {
    this.dataBroker = new EnhancedDataBroker();
  }
  
  async getStockAnalysis(symbol) {
    const [quote, profile, news, technicals] = await Promise.all([
      this.dataBroker.fetchStockQuote(symbol),
      this.dataBroker.fetchStockProfile(symbol),
      this.dataBroker.fetchStockNews(symbol),
      this.dataBroker.fetchTechnicalIndicators(symbol)
    ]);
    
    return {
      realtime: quote,
      fundamental: profile,
      sentiment: news,
      technical: technicals,
      analysis: await this.generateAnalysis({quote, profile, news, technicals})
    };
  }
  
  async generateStockChart(symbol, period = '1D') {
    // ç”Ÿæˆèµ°åŠ¿å›¾URL - ä½¿ç”¨ç°æœ‰æˆªå›¾æœåŠ¡
    const chartURL = `https://www.tradingview.com/chart/?symbol=${symbol}&interval=${period}`;
    return await screenshotProviders.getScreenshot(chartURL);
  }
}
3. æ‰©å±•æ•°æ®ç»çºªäººæ”¯æŒä¸ªè‚¡æŠ€æœ¯æŒ‡æ ‡
javascript
// åœ¨ enhancedDataBroker.js ä¸­æ·»åŠ 
class EnhancedDataBroker {
  // æ–°å¢ä¸ªè‚¡æŠ€æœ¯æŒ‡æ ‡æ–¹æ³•
  async fetchTechnicalIndicators(symbol) {
    const indicators = await finnhub.technicalIndicators(symbol, 'D', {
      indicators: ['sma', 'ema', 'rsi', 'macd', 'bbands']
    });
    
    return {
      sma: indicators.sma,
      rsi: indicators.rsi,
      macd: indicators.macd,
      bollingerBands: indicators.bbands,
      support: await this.calculateSupportResistance(symbol)
    };
  }
  
  async calculateSupportResistance(symbol) {
    // è®¡ç®—å…³é”®æ”¯æ’‘é˜»åŠ›ä½
    const historical = await finnhub.candles(symbol, 'D', 100);
    return this.identifyKeyLevels(historical);
  }
}
4. åˆ›å»ºä¸ªè‚¡åˆ†ææç¤ºè¯æ¨¡æ¿
javascript
// åœ¨ analysisPrompt.js ä¸­æ·»åŠ ä¸ªè‚¡åˆ†ææ¨¡æ¿
const STOCK_ANALYSIS_PROMPT = {
  technical: `ä½œä¸ºä¸“ä¸šæŠ€æœ¯åˆ†æå¸ˆï¼ŒåŸºäºä»¥ä¸‹æ•°æ®æä¾›ä¸ªè‚¡æŠ€æœ¯åˆ†æï¼š

{realtime_data}
{technical_indicators}

åˆ†æè¦æ±‚ï¼š
1. è¶‹åŠ¿åˆ¤æ–­ï¼ˆçŸ­æœŸ/ä¸­æœŸï¼‰
2. å…³é”®æ”¯æ’‘é˜»åŠ›ä½
3. ä¹°å–ä¿¡å·è¯†åˆ«
4. é£é™©ç­‰çº§è¯„ä¼°
5. å…·ä½“äº¤æ˜“å»ºè®®`,

  fundamental: `ä½œä¸ºåŸºæœ¬é¢åˆ†æå¸ˆï¼Œåˆ†æå…¬å¸æŠ•èµ„ä»·å€¼ï¼š

{company_profile}
{financial_metrics}

åˆ†æç»´åº¦ï¼š
1. ä¼°å€¼æ°´å¹³åˆç†æ€§
2. æˆé•¿æ€§è¯„ä¼°
3. ç›ˆåˆ©èƒ½åŠ›åˆ†æ
4. è¡Œä¸šåœ°ä½æ¯”è¾ƒ
5. é•¿æœŸæŠ•èµ„ä»·å€¼`
};
5. æ›´æ–°å“åº”æ ¼å¼åŒ–å™¨
javascript
// åœ¨ responseFormatter.js ä¸­æ·»åŠ ä¸ªè‚¡åˆ†ææ ¼å¼åŒ–
function formatStockAnalysis(stockData, analysis) {
  return `
ğŸ“ˆ **${stockData.symbol} ä¸ªè‚¡æ·±åº¦åˆ†æ**

ğŸ’° **å®æ—¶è¡Œæƒ…**
- ç°ä»·: $${stockData.realtime.price} (${stockData.realtime.change >= 0 ? 'â†—' : 'â†˜'} ${stockData.realtime.changePercent}%)
- æ—¥å†…: $${stockData.realtime.low} - $${stockData.realtime.high}
- æˆäº¤é‡: ${formatVolume(stockData.realtime.volume)}

ğŸ“Š **æŠ€æœ¯æŒ‡æ ‡**
- RSI: ${stockData.technical.rsi} ${getRSISignal(stockData.technical.rsi)}
- MACD: ${stockData.technical.macd.signal}
- å…³é”®ä½: æ”¯æ’‘ $${stockData.technical.support[0]}, é˜»åŠ› $${stockData.technical.resistance[0]}

ğŸ” **ä¸“ä¸šåˆ†æ**
${analysis}

âš ï¸ **é£é™©æç¤º**
${generateRiskAssessment(stockData)}
  `;
}
6. åœ¨ä¸»å…¥å£æ–‡ä»¶ä¸­é›†æˆ
javascript
// åœ¨ index.js ä¸­æ·»åŠ ä¸ªè‚¡åˆ†æè·¯ç”±
async function handleStockAnalysis(ctx, intent) {
  const stockService = new StockAnalysisService();
  
  try {
    // è·å–ä¸ªè‚¡æ•°æ®
    const stockData = await stockService.getStockAnalysis(intent.symbol);
    
    // ç”Ÿæˆèµ°åŠ¿å›¾
    const chart = await stockService.generateStockChart(intent.symbol);
    
    // ç”Ÿæˆä¸“ä¸šåˆ†æ
    const analysis = await gpt5Brain.generateStockAnalysis(stockData);
    
    // æ ¼å¼åŒ–è¾“å‡º
    const response = responseFormatter.formatStockAnalysis(stockData, analysis);
    
    // å‘é€ç»“æœ
    await ctx.replyWithPhoto(chart.imageBuffer, { caption: response });
    
  } catch (error) {
    await ctx.reply(`ä¸ªè‚¡åˆ†æå¤±è´¥: ${error.message}`);
  }
}
ğŸš€ å®æ–½ä¼˜å…ˆçº§
ç¬¬ä¸€é˜¶æ®µï¼ˆä»Šæ™šå®Œæˆï¼‰
âœ… åˆ›å»º stockAnalysisService.js åŸºç¡€æ¡†æ¶

âœ… æ‰©å±• enhancedDataBroker.js æŠ€æœ¯æŒ‡æ ‡æ”¯æŒ

âœ… æ›´æ–° semanticIntentAgent.js æ„å›¾è¯†åˆ«

âœ… æµ‹è¯•åŸºç¡€ä¸ªè‚¡æ•°æ®è·å–

ç¬¬äºŒé˜¶æ®µï¼ˆæ˜å¤©ï¼‰
ğŸ”„ é›†æˆèµ°åŠ¿å›¾ç”ŸæˆåŠŸèƒ½

ğŸ”„ å®Œå–„æŠ€æœ¯åˆ†ææç¤ºè¯

ğŸ”„ ä¼˜åŒ–å“åº”æ ¼å¼åŒ–

ğŸ”„ æ·»åŠ é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ

ç¬¬ä¸‰é˜¶æ®µï¼ˆåç»­ï¼‰
ğŸ“Š æ·»åŠ å¤šå…¬å¸å¯¹æ¯”åŠŸèƒ½

ğŸ“Š é›†æˆè´¢åŠ¡æŒ‡æ ‡åˆ†æ

ğŸ“Š æ·»åŠ æ¿å—å†…æ’å

ğŸ“Š å®ç°é¢„è­¦åŠŸèƒ½

ğŸ“ æ–‡ä»¶åˆ›å»º/ä¿®æ”¹æ¸…å•
æ–°å»ºæ–‡ä»¶
services/stockAnalysisService.js - ä¸ªè‚¡åˆ†æä¸»æœåŠ¡

templates/stockAnalysisPrompts.js - ä¸ªè‚¡åˆ†ææç¤ºè¯æ¨¡æ¿

ä¿®æ”¹æ–‡ä»¶
semanticIntentAgent.js - æ·»åŠ ä¸ªè‚¡åˆ†ææ„å›¾è¯†åˆ«

enhancedDataBroker.js - æ·»åŠ æŠ€æœ¯æŒ‡æ ‡æ–¹æ³•

analysisPrompt.js - æ·»åŠ ä¸ªè‚¡åˆ†ææç¤ºè¯

responseFormatter.js - æ·»åŠ ä¸ªè‚¡å“åº”æ ¼å¼åŒ–

index.js - é›†æˆä¸ªè‚¡åˆ†æå¤„ç†æµç¨‹

ğŸ¯ éªŒæ”¶æ ‡å‡†
ç”¨æˆ·è¾“å…¥ "åˆ†æNVDA" èƒ½å¤Ÿè¿”å›ä¸“ä¸šçš„ä¸ªè‚¡åˆ†æ

åŒ…å«å®æ—¶ä»·æ ¼ã€æŠ€æœ¯æŒ‡æ ‡ã€èµ°åŠ¿å›¾

åˆ†æå†…å®¹è¾¾åˆ°æœºæ„ä¸“ä¸šæ°´å‡†

å“åº”æ—¶é—´åœ¨10ç§’ä»¥å†…

è¯·åŸºäºè¿™ä¸ªæŒ‡ä»¤å¼€å§‹å®æ–½ï¼éœ€è¦æˆ‘è¯¦ç»†è§£é‡Šä»»ä½•éƒ¨åˆ†å—ï¼Ÿ