任务：清理 screenshotProviders.js，恢复为单一 Screenshot SaaS 路径（删除三层回退与 Browserless）

目标

删除（或移入 legacy 文件夹）Browserless、QuickChart、三层回退等旧逻辑。

保留且仅启用 Screenshot API（如 ScreenshotOne 或 ScreenshotAPI）方案。

清理依赖、去掉 Puppeteer/Playwright，保证 Replit 构建轻量、稳定。

修改说明

在项目根目录 .env（或 Replit Secrets）中添加：

SCREENSHOT_API_ENDPOINT=https://api.screenshotone.com/take     # 按实际截图服务填写
SCREENSHOT_API_KEY=<你的密钥>
HEATMAP_ENABLE_SCREENSHOT_SAAS=true
HEATMAP_ENABLE_BROWSERLESS=false
HEATMAP_ENABLE_QUICKCHART=false


新建或覆盖 src/screenshotProviders.js 为以下内容：

const fetch = require('node-fetch');
const ENABLE_SAAS = process.env.HEATMAP_ENABLE_SCREENSHOT_SAAS === 'true';

function qs(obj){ return new URLSearchParams(obj).toString(); }

async function captureViaScreenshotSaaS({ url }) {
  const start = Date.now();
  const endpoint = process.env.SCREENSHOT_API_ENDPOINT;
  const key = process.env.SCREENSHOT_API_KEY;
  if (!endpoint || !key) throw new Error('screenshot_api_not_configured');

  const params = {
    access_key: key,
    url,
    full_page: 'true',
    viewport_width: '1920',
    viewport_height: '1080',
    device_scale_factor: '2',
    block_ads: 'true',
    block_cookie_banners: 'true',
    element: '.tv-heatmap,.heatmap,.treemap,[data-name*=\"heatmap\"]',
    delay: '7000',
    ttl: '600'
  };

  const res = await fetch(`${endpoint}?${qs(params)}`, { timeout: 25000 });
  if (!res.ok) throw new Error(`screenshot_http_${res.status}`);
  const buffer = await res.buffer();
  if (!buffer || buffer.length < 60000) throw new Error('screenshot_too_small');

  return { provider:'screenshot', validation:'saas', elapsed_ms: Date.now()-start, buffer };
}

async function captureHeatmapSmart({ tradingViewUrl }) {
  if (!ENABLE_SAAS) throw new Error('screenshot_saas_disabled');
  return captureViaScreenshotSaaS({ url: tradingViewUrl });
}

module.exports = { captureHeatmapSmart };


把旧文件迁移至 src/legacy/screenshotProviders.legacy.js：

将 captureViaBrowserless、ensureDataset、hardCleanAndGoto、captureViaQuickChart 及旧的多层回退 captureHeatmapSmart 整体复制进去；

文件开头写明注释：

/**
 * DEPRECATED / LEGACY
 * 旧版三层回退与 Browserless 实现，默认不再导出、不再被使用。
 * 如需恢复，请手动从此文件复制回主文件，并打开 .env 开关。
 */


全局调用点统一为：

const { captureHeatmapSmart } = require('./src/screenshotProviders');


移除重量依赖（可选）：

npm remove puppeteer playwright


测试命令：

node -e "const { captureHeatmapSmart } = require('./src/screenshotProviders');
(async () => {
  const url = 'https://www.tradingview.com/heatmap/stock/?color=change&dataset=NIKKEI225&group=sector&blockSize=market_cap';
  try {
    const r = await captureHeatmapSmart({ tradingViewUrl: url });
    console.log('✅', r.provider, r.validation, r.elapsed_ms+'ms', r.buffer.length+'B');
  } catch(e) {
    console.error('❌', e.message);
  }
})();"

结果预期

项目仅使用 Screenshot SaaS 方案；

不再出现 Browserless 超时或 QuickChart 降级逻辑；

构建体积更小、截图更稳定；

旧逻辑安全保留在 legacy 目录，后续如需回滚可快速恢复。