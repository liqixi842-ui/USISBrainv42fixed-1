任务：清理 screenshotProviders.js，只保留 Screenshot SaaS 截图方案

目标

删除三层回退与 Browserless 逻辑，完全禁用 QuickChart 保底。

仅使用 Screenshot API 方案（如 ScreenshotOne 或 ScreenshotAPI）。

减少依赖，避免超时与自绘图。

修改说明

设置环境变量
在 Replit Secrets 中新增或确认以下键：

SCREENSHOT_API_ENDPOINT=https://api.screenshotone.com/take     # 替换成你的截图服务地址
SCREENSHOT_API_KEY=<你的密钥>
HEATMAP_ENABLE_SCREENSHOT_SAAS=true
HEATMAP_ENABLE_BROWSERLESS=false
HEATMAP_ENABLE_QUICKCHART=false


替换 src/screenshotProviders.js 内容为以下代码：

const fetch = require('node-fetch');
const ENABLE_SAAS = process.env.HEATMAP_ENABLE_SCREENSHOT_SAAS === 'true';

function qs(obj){ return new URLSearchParams(obj).toString(); }

async function captureViaScreenshotSaaS({ url }) {
  const start = Date.now();
  const endpoint = process.env.SCREENSHOT_API_ENDPOINT;
  const key = process.env.SCREENSHOT_API_KEY;
  if (!endpoint || !key) throw new Error('screenshot_api_not_configured');

  const params = {
    access_key: key,
    url,
    full_page: 'true',
    viewport_width: '1920',
    viewport_height: '1080',
    device_scale_factor: '2',
    block_ads: 'true',
    block_cookie_banners: 'true',
    // 暂时去掉 element 参数，保证兼容性
    delay: '8000',     // 延迟 8 秒让 TradingView 热力图加载
    ttl: '600'
  };

  const res = await fetch(`${endpoint}?${qs(params)}`, { timeout: 25000 });
  if (!res.ok) throw new Error(`screenshot_http_${res.status}`);
  const buffer = await res.buffer();
  if (!buffer || buffer.length < 20000) throw new Error('screenshot_too_small');

  return { provider:'screenshot', validation:'saas', elapsed_ms: Date.now()-start, buffer };
}

async function captureHeatmapSmart({ tradingViewUrl }) {
  if (!ENABLE_SAAS) throw new Error('screenshot_saas_disabled');
  return captureViaScreenshotSaaS({ url: tradingViewUrl });
}

module.exports = { captureHeatmapSmart };


把旧逻辑保存到 legacy 文件夹

新建目录 src/legacy/ 并创建 screenshotProviders.legacy.js；

将旧的 Browserless / QuickChart / 回退逻辑代码全部复制进去；

文件开头加注释：

/**
 * DEPRECATED / LEGACY
 * 原三层回退与 Browserless 实现，默认不再导出、不再使用。
 * 如需恢复，请从此文件复制回主文件并启用 .env 开关。
 */


移除不再需要的依赖

npm remove puppeteer playwright


测试命令

node -e "const { captureHeatmapSmart } = require('./src/screenshotProviders');
(async () => {
  const url = 'https://www.tradingview.com/heatmap/stock/?color=change&dataset=NIKKEI225&group=sector&blockSize=market_cap';
  try {
    const r = await captureHeatmapSmart({ tradingViewUrl: url });
    console.log('✅', r.provider, r.validation, r.elapsed_ms+'ms', r.buffer.length+'B');
  } catch(e) {
    console.error('❌', e.message);
  }
})();"

预期结果

系统只使用 Screenshot SaaS 截取真实 TradingView 热力图，不再生成 QuickChart 自绘图。

无 Browserless / QuickChart 逻辑，项目体积更小、运行稳定。

旧逻辑保存在 legacy 目录内，日后可随时恢复。