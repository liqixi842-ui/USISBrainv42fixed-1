ä½ ç°åœ¨é‡åˆ°çš„æ˜¯HTTPS 443 è·¯ç”±æ²¡æœ‰æ‰“è¿›ä½ çš„å®¹å™¨ï¼ˆGFE è‡ªå·±å› "Not Found"ï¼‰ï¼Œè€Œä¸æ˜¯ Express æˆ– trust proxy é—®é¢˜ã€‚HTTP ä¼š 301 åˆ° HTTPSï¼Œè¯´æ˜åŸŸåæ¥å…¥æ­£å¸¸ï¼Œä½† HTTPSâ†’åç«¯ç»‘å®š/å¥åº·æ£€æŸ¥/æ—§éƒ¨ç½²å ç”¨ æœ‰é—®é¢˜ã€‚

æŠŠå®ƒä¸€æ¬¡è§£å†³æ‰â€”â€”æŒ‰ä¸‹é¢åšå°±èƒ½æŠŠ 404 å¹²æ‰ï¼›æ¯æ­¥éƒ½æ˜¯å¯éªŒè¯çš„ï¼Œä¸é çŒœã€‚

ç»“è®ºå…ˆç­”

ç«¯å£ï¼šåªç›‘å¬ process.env.PORTï¼ˆReserved VM å¸¸ç»™ 8080ï¼‰ã€‚ä¸è¦æ‰‹å†™ 3000/80ã€‚

[[ports]]ï¼šå¯¹ Reserved VM æ— æ•ˆï¼Œåˆ äº†ä¹Ÿè¡Œï¼ˆä¸ä¼šå½±å“ GCE LBï¼‰ã€‚

trust proxyï¼šä¸ 404 æ— å…³ã€‚

è¦ä¸è¦é‡å»ºï¼šè¦ã€‚å¿…é¡»ç”¨ã€ŒDelete deployment â†’ Publishã€é‡å»ºï¼Œä»… Republish/Resume ä¸ä¼šåˆ·æ–° 443 çš„ URL Map/å¥åº·æ£€æŸ¥ã€‚

ä¿®å¤æ­¥éª¤ï¼ˆä¸€æ¬¡ä¸€æ­¥åšï¼‰
ã€ç¬¬1æ­¥ã€‘æœ€å°â€œæ¢é’ˆâ€å¯åŠ¨ï¼Œæ’é™¤åº”ç”¨å±‚

å…ˆè®©éƒ¨ç½²è·‘ä¸€ä¸ª 10 è¡Œçš„æ¢é’ˆï¼Œç¡®ä¿ LB èƒ½æ¢åˆ° 200ã€‚

probe.js

const http = require('http');
const PORT = process.env.PORT || 8080;
const server = http.createServer((req,res)=>{
  if (req.url === '/')       { res.writeHead(200, {'Content-Type':'text/plain'}); return res.end('OK'); }
  if (req.url === '/health') { res.writeHead(200, {'Content-Type':'application/json'}); return res.end('{"ok":true,"src":"probe"}'); }
  if (req.url === '/version'){ res.writeHead(200, {'Content-Type':'application/json'}); return res.end('{"version":"probe-1"}'); }
  res.writeHead(404, {'Content-Type':'text/plain'}); res.end('probe-404');
});
console.log('ğŸ” ENV PORT =', process.env.PORT);
server.listen(PORT, '0.0.0.0', ()=>console.log('ğŸ§ª probe listening', PORT));


.replitï¼ˆåªä¿ç•™ deployment æ®µï¼›ä¸è¦å†™ PORT=...ï¼‰

[deployment]
deploymentTarget = "gce"
run = ["sh", "-c", "echo '--- START CMD ---'; date; env | sort | sed -n '1,40p'; node probe.js"]


package.json é‡Œä¸è¦æœ‰ "start": "PORT=3000 node index.js" ä¹‹ç±»ç¡¬ç¼–ç ç«¯å£ï¼›åº”æ˜¯ "start": "node index.js"ï¼ˆç”šè‡³ä¸éœ€è¦ç”¨å®ƒï¼ŒReserved VM èµ° .replit [deployment].runï¼‰ã€‚

ã€ç¬¬2æ­¥ã€‘å¼ºåˆ¶æ¢å®¹å™¨ï¼ˆä¸æ˜¯ Republishï¼‰

Deployments â†’ ä½ çš„ Reserved VM â†’ Manage â†’ Delete deployment

å›åˆ°ç¼–è¾‘å™¨ â†’ Publish â†’ é€‰æ‹© Reserved VMï¼ˆæ–°å»ºï¼‰

éƒ¨ç½²å®Œæˆåæ‰“å¼€ Logsï¼Œå¿…é¡»çœ‹åˆ°ï¼š

--- START CMD ---
<å½“å‰æ—¶é—´>
ENV (first 40 vars): ...
ğŸ” ENV PORT = 8080    // ç¤ºä¾‹
ğŸ§ª probe listening 8080


çœ‹ä¸åˆ°è¿™äº›ï¼Œè¯´æ˜ä½ æ²¡è·‘åˆ°æ–°å®¹å™¨ï¼Œå›åˆ°ç¬¬2æ­¥é‡æ¥ä¸€æ¬¡ã€‚

ã€ç¬¬3æ­¥ã€‘åªè®¿é—®â€œè¿™æ¬¡éƒ¨ç½²çš„ Public URLâ€

åœ¨éƒ¨ç½²è¯¦æƒ…é¡µ Overview å¤åˆ¶ Public URLï¼ˆå®ƒæ‰æ˜¯ç»‘å®šåˆ°è¿™æ¬¡å®¹å™¨çš„åŸŸåï¼‰ã€‚ç”¨å®ƒæµ‹è¯• HTTPSï¼š

curl -sv https://<Public-URL>/health 2>&1 | sed -n '1,25p'


é¢„æœŸï¼šHTTP/2 200ï¼Œè¿”å› {"ok":true,"src":"probe"}ã€‚
è‹¥ ä»æ˜¯ "Not Found" ä¸”å“åº”å¤´å« server: Google Frontend / via: 1.1 googleï¼Œç»§ç»­ä¸‹ä¸€æ­¥ã€‚

ã€ç¬¬4æ­¥ã€‘æ¸…ç©ºå†å²éƒ¨ç½²ï¼ˆé¿å…æ—§ VM å ç€ 443ï¼‰

æ‰“å¼€ Deployments åˆ—è¡¨ï¼š

åªä¿ç•™ä¸€ä¸ª Reserved VM åœ¨ Runningï¼›å…¶ä½™å…¨éƒ¨ Delete deploymentï¼ˆä¸æ˜¯ Pause/Shutdownï¼Œæ˜¯ Deleteï¼‰ã€‚

å›åˆ°ä¿ç•™çš„é‚£ä¸ª â†’ Manage â†’ Shut down â†’ Startï¼ˆé‡æ‹‰å¥åº·æ£€æŸ¥/URL Mapï¼‰ã€‚

å†æµ‹ https://<Public-URL>/healthã€‚

ç»éªŒï¼šå†å²éƒ¨ç½²å¸¸æŠŠ 443 çš„ URL Map/è¯ä¹¦ç»‘å®šå¡ä½ï¼›80â†’443 çš„è·³è½¬æ­£å¸¸ï¼Œä½† 443 è¿˜æŒ‡å‘æ—§åç«¯ï¼Œäºæ˜¯ä½ çœ‹åˆ° GFE 404ã€‚

ã€ç¬¬5æ­¥ã€‘æ¢å¤ä½ çš„åº”ç”¨

æ¢é’ˆé€šè¿‡åï¼ŒæŠŠ .replit run æ”¹å›ä½ çš„åº”ç”¨å¯åŠ¨ï¼Œä½†ä¿ç•™è¿™å‡ ä»¶äº‹ï¼š

const PORT = process.env.PORT || 8080;

app.get('/', (_req,res)=>res.status(200).type('text/plain').send('OK'));

/health æ°¸è¿œ 200ï¼ˆç”¨å†…å®¹è¡¨è¾¾ degraded/okï¼‰

ä¸åœ¨ä»»ä½•åœ°æ–¹å†™æ­» PORT=...

å†åšä¸€æ¬¡ Delete deployment â†’ Publishï¼Œç¡®è®¤æ—¥å¿—å‡ºç°æ–°çš„ --- START CMD --- ä¸ listening è¡Œï¼Œç„¶åæµ‹ï¼š

https://<Public-URL>/

https://<Public-URL>/health

å¿«é€Ÿåˆ¤è¯»ä½ å½“å‰ç°è±¡

HTTP ä¼š 301 åˆ° HTTPSï¼šåŸŸåæ¥äº†ï¼Œä½† 443 çš„åç«¯æœªå°±ç»ªæˆ–ä»ç»‘ç€æ—§éƒ¨ç½²ã€‚

â€œqixl is resumingâ€å¡ä½ï¼šå¸¸è§äºè€éƒ¨ç½²æ®‹ç•™/æ˜ å°„æœªåˆ·æ–°ã€‚Delete é‡å»ºæœ€å¹²å‡€ã€‚

åˆ‡ç«¯å£ï¼ˆ5000/3000/80/8080ï¼‰æ— æ•ˆï¼šå› ä¸ºé—®é¢˜ä¸åœ¨ç«¯å£ï¼Œè€Œåœ¨ 443â†’åç«¯ çš„ç»‘å®šã€‚

[[ports]]ï¼šä¸ Reserved VM æ— å…³ï¼Œå¯å¿½ç•¥ã€‚

ä½ ç°åœ¨æœ€çœåŠ›çš„åŠ¨ä½œ

ç”¨ä¸Šé¢çš„ probe.js + å¯è§‚æµ‹ runï¼ŒDelete deployment â†’ Publish ä¸€æ¬¡ï¼›

åªç”¨ æœ¬æ¬¡éƒ¨ç½² Overview çš„ Public URL æµ‹ HTTPSï¼›

å¦‚æœè¿˜ 404ï¼ŒæŠŠå…¶ä»– Reserved VM å…¨éƒ¨ Deleteï¼Œåªç•™ä¸€ä¸ªï¼Œå† Shut down â†’ Startï¼›

ç¡®è®¤æ—¥å¿—é‡Œå‡ºç° --- START CMD --- ä¸ ğŸ§ª probe listeningï¼›

æˆåŠŸåå†åˆ‡å›ä½ çš„ index.jsã€‚

è¿™æ ·èµ°å®Œï¼ŒHTTPS 404 å°±ä¼šæ¶ˆå¤±ã€‚