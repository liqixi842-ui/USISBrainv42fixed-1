当前 /report NVDA 返回的 Markdown 结构太简陋，而且 PDF 没法生成。  
我的目标是：

1）/v3/report/:symbol?format=html / md → 像机构研报那样，有清晰的结构和专业措辞；  
2）/v3/report/:symbol?format=pdf 和 /report SYMBOL → 能真正返回一份 PDF 文件（通过外部 PDF 服务）。

请按两个部分帮我升级：A = 内容结构；B = PDF 服务。

────────────────────────
【A】升级研报内容模版（朝“投行研报”方向）
────────────────────────

请在 v3_dev/services/reportService.js 中，对 HTML / Markdown 生成逻辑做以下升级：

1. 研报结构改为类似下面这个大纲（Markdown 版本示例）：

# USIS 研究报告

## {SYMBOL} - {COMPANY_NAME}

评级：**{RATING}**（{RATING_ICON}）  
时间范围：**{HORIZON}**（短期 / 中期 / 长期）  
最新价格：{LAST_PRICE} 美元  
相对指数表现：{RELATIVE_PERF}  

---

## 一、投资结论（Investment Summary）

- 用 2–3 句话概括当前观点（偏正式，不要口语，不要表情）
- 明确给出：「建议操作 + 核心理由 + 时间维度」

示例：
> 在当前估值和行业格局下，我们维持对 NVDA 的 **BUY（买入）** 评级，适合中期配置。短期波动仍然较大，但 AI 基础设施需求和公司技术护城河为股价提供中长期支撑。

---

## 二、核心观点（Key Investment Thesis）

1. 行业/赛道逻辑（AI GPU、数据中心、生态位等）
2. 公司竞争优势（技术、生态、份额、定价权）
3. 财务与盈利能力（收入增速、毛利率、自由现金流）

---

## 三、估值与财务概览（Valuation & Financials）

- 当前股价：{LAST_PRICE} 美元  
- 52周区间：{LOW_52W} - {HIGH_52W} 美元  
- 市值：{MARKET_CAP}  
- 估值倍数：  
  - 市盈率（P/E）：{PE}  
  - 市销率（P/S）：{PS}  
- 利润率：  
  - 毛利率：{GROSS_MARGIN}%  
  - 净利率：{NET_MARGIN}%  

可以保留一个简单表格，但请确保数值不是 N/A 就行。

---

## 四、关键驱动因素（Catalysts）

列出 3–5 条中短期可能推动股价的催化剂，例如：

1. 新一代 GPU 产品发布节奏及市场反馈  
2. 云厂商/超大客户的资本开支计划  
3. 监管环境或竞争对手策略变化  
4. 重要财报、指引或市场预期修正  

---

## 五、核心风险（Key Risks）

列出 3–5 条主要风险，例如：

1. 行业需求周期波动，AI Capex 不及预期  
2. 监管或地缘政治对供应链的影响  
3. 竞争对手推出替代方案，压缩公司毛利率  
4. 估值过高带来回撤风险  

---

## 六、技术面简评（Technical View）

用 3–4 句话结合 RSI / MACD / EMA，总结技术面：

- 当前价格相对于 EMA(20/50) 的位置  
- RSI 是否处于超买/超卖区间  
- 短中期趋势（震荡 / 上升 / 回调）  
- 给出一个简短结论：技术面是支持加仓、观望还是减仓

---

## 七、操作建议（Action）

用 1–2 段话，总结：

- 当前是否建议新建仓 / 加仓 / 减仓 / 观望  
- 对已有仓位的建议（如「成本在 200 美元附近的投资者，可分批逢低加仓」）  
- 提醒投资者关注的下一个关键时间点（财报日、产品发布会等）

2. 请让 HTML 版本与上述 Markdown 结构对应，使用 `<h2>`, `<h3>`, `<p>`, `<ul>` 等标签，不要再用太多 emoji，风格偏「正式机构」。

3. 现有的价格信息表格里，如果数据为 N/A，请尽量用「暂不提供 / 数据不足」等中文提示，而不是留空。

────────────────────────
【B】让 PDF 真的能生成（配置 PDF_SERVICE_URL）
────────────────────────

从 Console 日志可以看到：

- [DEV_BOT] External PDF service response status: 503
- error: "PDF service not configured", "message": "PDF_SERVICE_URL environment variable is not set"

说明当前环境中并没有配置 PDF_SERVICE_URL。  
之前我已经为 Replit 开通过一个专门的 PDF 生成服务，请帮我按以下方式修复：

1. 找回或确认我们之前使用的「外部 PDF 服务」地址（例如之前用于生成其他 PDF 报告的那个 URL），把它写入环境变量：

PDF_SERVICE_URL = "<之前配置过的那个 PDF 服务 HTTPS 端点>"

2. 确认 v3_dev/services/reportService.js 中调用外部 PDF 服务的代码逻辑是：

- 用 POST 把 HTML 报告发送给 PDF_SERVICE_URL（字段如 html、title、symbol、locale 等）
- 得到 PDF 二进制（或带有 PDF URL 的 JSON）
- 如果返回的是 URL，则下载为 buffer 再交给 dev bot 发送

3. 在 PDF 服务仍然不可用时（如 5xx），dev bot：

- 必须优雅降级为「发送 Markdown 版本」，并附一句类似：
  「当前 PDF 服务不可用，已为您发送文本版研报。」

4. 修复后，请在开发环境中测试：

- 访问：http://localhost:3000/v3/report/NVDA?format=pdf  
  → 应该返回一个 application/pdf 流（或触发下载）
- 在 dev bot 中发送：/report NVDA  
  → 优先发送 PDF，如 PDF 服务不可用，则发送 Markdown，并提示降级原因。

最后，请把：
- 更新后的 Markdown 研报样例（/report NVDA 的完整文本）
- 如果 PDF 成功，确认一份 PDF 样例已经生成  
的情况一并返回给我。
