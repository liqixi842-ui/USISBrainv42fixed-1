âœ… ç»™ Replit Agent çš„æ¶ˆæ¯ï¼ˆä¸­æ–‡ï¼‰

ä¸»é¢˜ï¼šå°†æƒé™æ£€æŸ¥ä» n8n ç§»è‡³ Brain APIï¼Œè§£å†³ â€œBad Request: chat not foundâ€ çš„ç¡®å®šæ€§æ–¹æ¡ˆ

ä½ å¥½ï¼Œæˆ‘æ˜¯ Replit Agent å¯¹æ¥æ–¹ã€‚ç”¨æˆ·åœ¨ n8n å·¥ä½œæµä¸­æŒç»­é‡åˆ°æŠ¥é”™ï¼šSend_No_Permission_Warning â†’ â€œBad Request: chat not foundâ€ã€‚æˆ‘ä»¬å·²ç»å°è¯•å¤šç§ chatId å¼•ç”¨ï¼ˆ$json.CHAT_ID / $node["Set_Context"]â€¦ / $node["Telegram_Trigger"]â€¦ï¼‰ä¸èŠ‚ç‚¹é‡è¿ï¼Œä½†ä»ä¼šå› æ•°æ®æ¥è‡ªä¸åŒåˆ†æ”¯æˆ–é¢‘é“æƒé™å¯¼è‡´å¤±è´¥ã€‚ç”¨æˆ·éœ€è¦ç¡®å®šæ€§è§£å†³æ–¹æ¡ˆï¼Œä¸å†ç»§ç»­è¯•é”™ã€‚

æˆ‘æ–¹å»ºè®®ï¼ˆé¦–é€‰æ–¹æ¡ˆï¼‰

æŠŠæƒé™æ£€æŸ¥ä» n8n ç§»åˆ° Brain APIï¼ˆReplit åç«¯ï¼‰ï¼ŒæŠŠ n8n ç®€åŒ–ä¸ºï¼š

Telegram Trigger â†’ è°ƒç”¨ POST /brain/permission â†’ æ ¹æ®è¿”å› {allowed: true|false} å†³å®šæ˜¯å¦ç»§ç»­ä¸šåŠ¡é€»è¾‘/ç›´æ¥å›æ— æƒé™æç¤ºã€‚

ç†ç”±ï¼š

n8n çš„æ•°æ®æµï¼ˆTrigger â†’ Set_Context â†’ Set_Admin â†’ IF_IsAdminCommand â†’ IF_CheckAdmin â†’ IF_WhitelistCheck â†’ Send_*ï¼‰ç©¿è¶Š 6â€“8 ä¸ªèŠ‚ç‚¹ï¼Œå˜é‡ä½œç”¨åŸŸæ˜“å˜åŒ–ï¼Œç¨æœ‰åˆ†æ”¯ä¸åŒæ¥æºå°±å‡ºç°â€œchat ä¸å­˜åœ¨/æƒé™ä¸è¶³â€ç­‰éä¸šåŠ¡é”™è¯¯ã€‚

å°†æƒé™åˆ¤å®šä¸‹æ²‰åˆ° Replit åªéœ€ä¸€æ¬¡åˆ¤æ–­ï¼ˆadmin/whitelist/noneï¼‰ï¼Œç¡®å®šæ€§å¼ºï¼Œå¯¹ n8n å®Œå…¨é€æ˜ï¼›åç»­è¦åŠ é»‘åå•/é™æµ/å®¡è®¡ä¹Ÿé›†ä¸­åœ¨ Replit æ”¹ã€‚

ç”¨æˆ·å·²ç»å¤šæ¬¡å°è¯• n8n å†…éƒ¨ä¿®å¤è€Œå¤±è´¥ï¼Œè¿ç§»åˆ° Replit èƒ½ä¸€æ¬¡æ€§ç»ˆç»“é—®é¢˜ã€‚

æˆ‘å¸Œæœ›ä½ ä»¬åšçš„æ”¹åŠ¨
1ï¼‰æ–°å¢æƒé™æ¥å£ï¼ˆæˆ–å¹¶å…¥ orchestrate å¼€å¤´ä¹Ÿå¯ï¼‰

åœ¨ index.js å¢åŠ ï¼š

app.post('/brain/permission', async (req, res) => {
  const { text = '', user_id = '', chat_id = '' } = req.body || {};
  const ADMIN_ID = '7561303850';

  // å¯æ›¿æ¢ä¸ºæŒä¹…åŒ–ï¼šDB/Sheetã€‚è¿™é‡Œç”¨å†…å­˜é›†åˆæ¼”ç¤ºã€‚
  global.__WL__ = global.__WL__ || new Set();

  const msg = String(text).trim();
  const uid = String(user_id);
  const isAdmin = uid === ADMIN_ID;
  const isWhitelist = isAdmin || global.__WL__.has(uid);

  // ç®¡ç†å‘½ä»¤ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
  if (isAdmin && /^\/auth(\s+.+)?/i.test(msg)) {
    const target = (msg.split(/\s+/)[1] || uid).trim();
    global.__WL__.add(String(target));
    return res.json({ allowed: true, role: 'admin', tip: `âœ… å·²æˆæƒï¼š${target}` });
  }
  if (isAdmin && /^\/unauth(\s+.+)?/i.test(msg)) {
    const target = (msg.split(/\s+/)[1] || uid).trim();
    global.__WL__.delete(String(target));
    return res.json({ allowed: true, role: 'admin', tip: `ğŸ§¹ å·²å–æ¶ˆæˆæƒï¼š${target}` });
  }
  if (isAdmin && /^\/listauth/i.test(msg)) {
    return res.json({ allowed: true, role: 'admin', tip: `å½“å‰æˆæƒï¼š\n${[...global.__WL__].join('\n') || '(ç©º)'}` });
  }

  // æ™®é€šåˆ¤å®š
  if (isWhitelist) return res.json({ allowed: true, role: isAdmin ? 'admin' : 'whitelist' });

  return res.json({ allowed: false, role: 'none', message: 'âš ï¸ æŠ±æ­‰ï¼Œä½ æ²¡æœ‰ä½¿ç”¨æƒé™ã€‚è¯·è”ç³»ç®¡ç†å‘˜ã€‚' });
});


å¦‚æœä½ ä»¬æ›´å€¾å‘ä¸æ–°å¢è·¯ç”±ï¼Œä¹Ÿå¯æŠŠä»¥ä¸Šé€»è¾‘ç›´æ¥æ”¾åœ¨ /brain/orchestrate å¼€å¤´ï¼šè‹¥ allowed=false å°±ç«‹å³è¿”å› {allowed:false, message:...}ï¼Œn8n ç›´æ¥æŠŠ message å‘å›å»ã€‚

2ï¼‰è¿”å›æ ¼å¼ï¼ˆå¥‘çº¦ï¼‰

å…è®¸ï¼š{ "allowed": true, "role": "admin|whitelist", "tip": "å¯é€‰æç¤º" }

æ‹’ç»ï¼š{ "allowed": false, "role": "none", "message": "âš ï¸ æ— æƒé™..." }

ç®¡ç†å‘½ä»¤å›æ‰§ï¼ˆ/auth /unauth /listauthï¼‰ï¼š{ "allowed": true, "role":"admin", "tip":"âœ… å·²æˆæƒï¼š..." }

3ï¼‰n8n ä¾§æ¥æ³•ï¼ˆ3èŠ‚ç‚¹ï¼‰

Telegram Trigger

HTTP Request â†’ POST /brain/permission
Body JSON:

{
  "text": "={{ $json.message.text }}",
  "user_id": "={{ $json.message.from.id }}",
  "chat_id": "={{ $json.message.chat.id }}"
}


IFï¼ˆAllowed?ï¼‰å·¦å€¼ï¼š{{ $json.allowed === true }} â†’ Trueï¼šèµ°ç°æœ‰ä¸»é€»è¾‘ï¼›Falseï¼šTelegram å‘ $json.messageï¼ˆchatId ä» Trigger å–ï¼š{{ $node["Telegram_Trigger"].json.message.chat.id }}ï¼‰

éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰

åœ¨ä»»æ„ç¾¤/ç§èŠä¸­ï¼Œç”¨éç™½åå•ç”¨æˆ·å‘æ¶ˆæ¯ â†’ å¿…å®šæ”¶åˆ°â€œæ— æƒé™â€æç¤ºï¼Œæ—  400/403/â€œchat not foundâ€ã€‚

ç®¡ç†å‘˜åœ¨åŒä¸€ä¼šè¯å†…å‘é€ï¼š/auth <id>ã€/unauth <id>ã€/listauth â†’ å¿…å®šæ”¶åˆ°æˆåŠŸå›æ‰§ï¼›éšåéç™½åå•/è¢«å–æ¶ˆæˆæƒçš„è´¦å·è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚

n8n ä¾§ä¸å†å‡ºç° chat_id is empty æˆ– Bad Request: chat not foundï¼›æ§åˆ¶å°å“åº”ç  200ã€‚

åç»­è¦æŠŠç™½åå•ä»å†…å­˜è¿ç§»åˆ°æŒä¹…åŒ–ï¼ˆGoogle Sheet/DBï¼‰ï¼Œåªæ”¹ Replitï¼Œä¸æ”¹ n8nã€‚

å¦‚æœä½ ä»¬åšæŒåœ¨ n8n å†…éƒ¨è§£å†³ï¼Œè¯·ä¸€æ¬¡æ€§æä¾›å¯å·¥ä½œçš„æœ€å°é…ç½®ï¼ˆå…·ä½“è¡¨è¾¾å¼ä¸èŠ‚ç‚¹è®¾ç½®ï¼‰ï¼Œè€Œéç»§ç»­å»ºè®®åœ¨ $json ä¸ $node[...] ä¹‹é—´åˆ‡æ¢â€”â€”ç”¨æˆ·å·²å°è¯•æ•°å°æ—¶ä¸”å¤±è´¥ã€‚

è°¢è°¢ï¼