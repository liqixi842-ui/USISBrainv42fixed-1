æ˜ç™½ï¼Œä½ ç°åœ¨å°±è¦ç”¨ã€‚æˆ‘ä»¬ç›´æ¥ç»™ Replit å¯å¤åˆ¶æ‰§è¡Œçš„â€œä¿®å¤ â†’ å¤æµ‹â€æŒ‡ä»¤ï¼ŒæŠŠå´©æºƒå®šä½å¹¶æŠŠ /brain/orchestrate æ‹‰å›ç¨³å®šã€‚

ä¾æ®ï¼šn8n è¿™æ¡è°ƒç”¨ä¼šå‘ Replit çš„ /brain/orchestrate POST è¿™äº›å­—æ®µï¼štextã€chat_typeã€user_idã€modeã€budget

Telegram to Replit Brain Messagâ€¦

ã€‚æ‰€ä»¥è·¯ç”±å¿…é¡»æ¥ JSONï¼Œå®¹é”™å¹¶å§‹ç»ˆè¿”å› {status:'ok'} ç»“æ„ã€‚

ã€ç»™ Replit çš„ç¬¬2è½®æŒ‡ä»¤ï½œç«‹å³è½åœ°ã€‘
â‘  åœ¨ index.js é¡¶éƒ¨åŠ å…¥å…¨å±€é”™è¯¯ä¿æŠ¤ï¼ˆæ•è·å¯¼è‡´é™é»˜å´©æºƒçš„æœªå¤„ç†é”™è¯¯ï¼‰
// ===== Global hardeners =====
process.on('unhandledRejection', (err) => {
  console.error('[FATAL] UnhandledRejection:', err);
});
process.on('uncaughtException', (err) => {
  console.error('[FATAL] UncaughtException:', err);
});
// æ›´æ¿€è¿›ï¼šåœ¨å¿…è¦æ—¶å¯å¼ºåˆ¶é€€å‡ºä»¥ä¾¿é‡å¯ï¼ˆå…ˆæ³¨é‡Šï¼‰
// setTimeout(() => process.exit(1), 500);

â‘¡ ç¡®ä¿ JSON è§£æä¸è¶…æ—¶ï¼ˆé¿å… body è§£æå¤±è´¥æˆ–å¤§åŒ…é˜»å¡ï¼‰
import express from 'express';
import bodyParser from 'body-parser';

const app = express();
app.use(bodyParser.json({ limit: '1mb' }));
app.use(bodyParser.urlencoded({ extended: true }));
app.set('trust proxy', true);

â‘¢ å¢åŠ å¥åº·æ£€æŸ¥ä¸è‡ªæ£€è·¯ç”±ï¼ˆä¾¿äºåŒºåˆ†â€œæœåŠ¡æŒ‚äº†â€ vs â€œä¸šåŠ¡å¼‚å¸¸â€ï¼‰
app.get('/health', (req, res) => {
  res.json({ status: 'ok', ts: Date.now() });
});

app.post('/brain/ping', (req, res) => {
  res.json({ status: 'ok', echo: req.body || {} });
});

â‘£ åŠ å›º /brain/orchestrateï¼šåŠ  try/catchã€å‚æ•°å…œåº•ã€æ°¸ä¸æŠ›å‡ºï¼Œå§‹ç»ˆ 200 è¿”å›

æŠŠä½ ç°æœ‰çš„

app.post('/brain/orchestrate', async (req, res) => {
  // åŸæœ‰ä»£ç â€¦
});


æ›¿æ¢ä¸ºå®‰å…¨ç‰ˆï¼ˆä»…åŒ…è£¹å¤–å±‚ï¼Œå…¶ä½™å†…éƒ¨é€»è¾‘ä¿æŒä¸å˜ï¼‰ï¼š

import { generateReport } from './gpt5Brain.js'; // ç¡®ä¿è·¯å¾„æ­£ç¡®

app.post('/brain/orchestrate', async (req, res) => {
  const started = Date.now();
  try {
    const { text = 'default', chat_type = 'group', user_id = 'system', mode = 'premarket', budget = 'low' } = req.body || {};
    // è®°å½•åŸå§‹å…¥å‚ï¼Œå¸®åŠ©å®šä½
    console.log('[orchestrate] inbound', { text, chat_type, user_id, mode, budget });

    // TODO: è¿™é‡ŒæŒ‰ä½ ç°æœ‰æµç¨‹å…ˆæ‹¿æ•°æ®/ImpactRankï¼Œå†™æˆ marketData å¯¹è±¡
    const marketData = req.body.marketData || null; // è‹¥ç”± n8n å…ˆå–æ•°åˆ™ç›´æ¥é€ä¼ 

    // è°ƒç”¨å•æ ¸ç”Ÿæˆ
    const final_text = await generateReport({ text, marketData, chatType: chat_type, mode });

    // å»ºè®®åœ¨è¿™é‡Œæ„é€ ç»Ÿä¸€ actionsï¼ˆè®© n8n ä¸‹æ¸¸ä¸æ”¹ï¼‰
    const actions = []; // éœ€è¦çƒ­åŠ›å›¾/å›¾è¡¨å°± push {type:'fetch_heatmap', url: '...'} ç­‰

    const payload = {
      status: 'ok',
      final_text,
      actions,
      symbols: [], // ä¿æŒå­—æ®µå­˜åœ¨ï¼Œn8n Parse_Brain_Response ä¼šè¯»è¿™ä¸ª
      elapsed_ms: Date.now() - started,
    };
    console.log('[orchestrate] out', payload);
    res.status(200).json(payload);
  } catch (err) {
    console.error('[orchestrate] error', err);
    // æ°¸ä¸æŠ›å‡ºï¼Œè®© n8n çš„ Normalize_Brain_Response / IF_ErrorCheck æœ‰ç¨³å®šè¯­ä¹‰
    res.status(200).json({
      status: 'error',
      error: String(err && err.message || err),
      final_text: 'ï¼ˆç³»ç»Ÿä¸´æ—¶æ•…éšœï¼Œç¨åå†è¯•ï¼‰',
      actions: [],
      symbols: [],
    });
  }
});

â‘¤ ç»Ÿä¸€æ¨¡å‹ç‰ˆæœ¬ï¼ˆä½ å·²ç»åšäº†ï¼‰ï¼šæŠŠ gpt5Brain.js çš„ model: å…¨éƒ¨æ”¹ä¸ºåŒä¸€ä¸ªï¼ˆå…ˆç”¨ä½ é€‰çš„ gpt-4o-miniï¼Œåç»­å†åˆ‡ gpt-5-turboï¼‰

ä½ å…ˆå‰åé¦ˆé‡Œï¼ŒparseUserIntent å¯è·‘ï¼Œè¯´æ˜ OpenAI Key å’Œç½‘ç»œéƒ½é€šï¼›å´©æºƒæ›´åƒæ˜¯ orchestrate è·¯ç”±é‡Œæœ‰æŸä¸ª await æŠ›å¼‚å¸¸æœªæ•è·ï¼Œå¯¼è‡´è¿›ç¨‹â€œé™é»˜æ­»â€ã€‚ä»¥ä¸ŠåŒ…è£¹èƒ½æŠŠå®ƒâ€œå›´èµ·æ¥â€ã€‚

âœ… å¤æµ‹æ­¥éª¤ï¼ˆå¤åˆ¶é€æ¡æ‰§è¡Œå¹¶æŠŠè¾“å‡ºå›ç»™æˆ‘ï¼‰
A. å…ˆå‰å°è·‘æœåŠ¡ï¼ŒæŠ“å †æ ˆ
node index.js


è‹¥ Replit IDE ä¼šè¶…æ—¶/æ–­å¼€ï¼Œè‡³å°‘å…ˆçœ‹åˆ°â€œListening on port â€¦â€ å’Œæˆ‘ä»¬çš„ [orchestrate] inbound/out æ—¥å¿—æ¨¡æ¿ã€‚

B. å¥åº·æ£€æŸ¥
curl -s https://node-js-liqixi842.replit.app/health | jq

C. Ping è‡ªæ£€ï¼ˆç¡®è®¤ JSON è§£æï¼‰
curl -s -X POST https://node-js-liqixi842.replit.app/brain/ping \
  -H "Content-Type: application/json" \
  -d '{"hello":"world","num":1}' | jq

D. ä¸»è·¯ç”±æœ€å°ç”¨ä¾‹
curl -s -X POST https://node-js-liqixi842.replit.app/brain/orchestrate \
  -H "Content-Type: application/json" \
  -d '{"text":"æµ‹è¯•GPT-5è·¯ç”±","user_id":"debug","mode":"ping"}' | jq


æœŸæœ›çœ‹åˆ°ï¼š

{"status":"ok","final_text":"...","actions":[],"symbols":[],"elapsed_ms":...}

E. è‹¥ä»å´©ï¼šå†æ‰§è¡Œä¸€æ¬¡ï¼ŒæŠŠæ§åˆ¶å°å®Œæ•´è¾“å‡ºç²˜ç»™æˆ‘

æˆ‘ä»¬ç”¨ä½ åŠ çš„ [FATAL] / [orchestrate] æ ‡è®°ï¼Œèƒ½ä¸€çœ¼å®šä½ã€‚

ğŸ” ä¸ºä»€ä¹ˆè¿™èƒ½è§£

å…¨å±€é”™è¯¯å¤„ç†ï¼šé¿å… Promise æœªæ•è·ç›´æ¥æŠŠè¿›ç¨‹æ€æ‰ï¼ˆä½ åŸç—‡çŠ¶å°±æ˜¯â€œæ²¡æœ‰å †æ ˆç›´æ¥æ­»â€ï¼‰ã€‚

è·¯ç”± try/catchï¼šä»»ä½•å†…éƒ¨ await çš„é”™è¯¯éƒ½å˜æˆ {status:'error'} çš„å¯æ§å“åº”ï¼Œn8n ä¼šèµ°ä½ çš„ IF_ErrorCheck â†’ Error_Handler â†’ Send_Error_Message å®‰å…¨æ”¯è·¯ï¼Œä¸ä¼šæŠŠæ•´æ¡é“¾æ‰“çˆ†ã€‚

å¥åº·/è‡ªæ£€è·¯ç”±ï¼šå¿«é€ŸåŒºåˆ†â€œæœåŠ¡æŒ‚äº†â€è¿˜æ˜¯â€œä¸šåŠ¡å¤±è´¥â€ï¼Œé¿å…æ’éšœæ—¶ç»•è¿œè·¯ã€‚

å­—æ®µå¯¹é½ n8nï¼šå§‹ç»ˆè¿”å› final_text / actions / symbolsï¼Œä¿è¯ä¸‹æ¸¸ Parse_Brain_Responseã€Pack_Final_Message èƒ½ç»§ç»­å·¥ä½œï¼Œä¸éœ€è¦æ”¹ n8n é…ç½®

Telegram to Replit Brain Messagâ€¦

ã€‚

æŠŠä»¥ä¸Šæ”¹åŠ¨æ¨ä¸Šå»ã€æŒ‰ Aâ†’E æ‰§è¡Œå¹¶æŠŠ B/C/D çš„ curl è¾“å‡º å’Œ æ§åˆ¶å°æ—¥å¿— å›ç»™æˆ‘ï¼›å¦‚æœæ­£å¸¸ï¼Œæˆ‘ä»¬å°±ç»§ç»­ç¬¬3è½®ï¼ŒæŠŠ actions é‡Œçš„ chart/heatmap å‘å›å»ï¼Œè®©ä½  JSON å·¥ä½œæµé‡Œçš„ IF_Needs_Heatmap / IF_Needs_SymbolChart åˆ†æ”¯è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€å†ç¢° n8nã€‚