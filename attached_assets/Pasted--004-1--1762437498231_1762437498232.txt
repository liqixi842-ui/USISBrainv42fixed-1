ã€æŠ€æœ¯æ–¹æ¡ˆ#004 - æ‰©å±•çƒ­åŠ›å›¾æ˜ å°„ä½“ç³»ã€‘

**é—®é¢˜**ï¼šå½“å‰æ˜ å°„å¤ªå°‘ï¼Œéœ€è¦å®Œæ•´çš„å¸‚åœº+æ¿å—æ˜ å°„ç³»ç»Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šå»ºç«‹å¤šå±‚æ¬¡æ˜ å°„ä½“ç³»

**å…·ä½“ä¿®æ”¹è¦æ±‚**ï¼š

1. **æ‰©å±•å¸‚åœºæ˜ å°„**ï¼š
```javascript
function extractHeatmapQueryRulesOnly(text) {
  const norm = text.normalize("NFKC").toLowerCase();
  
  // 1. åœ°åŒºå¸‚åœºæ˜ å°„
  const marketMap = {
    // ç¾æ´²
    'us': { index: 'SPX500', name: 'æ ‡æ™®500' },
    'nasdaq': { index: 'NAS100', name: 'çº³æ–¯è¾¾å…‹' },
    'dow': { index: 'DJI', name: 'é“ç¼æ–¯' },
    'sp500': { index: 'SPX500', name: 'æ ‡æ™®500' },
    'russell': { index: 'RUT', name: 'ç½—ç´ 2000' },
    'tsx': { index: 'TSX', name: 'åŠ æ‹¿å¤§TSX' },
    'brazil': { index: 'IBOV', name: 'å·´è¥¿IBOV' },
    'mexico': { index: 'MEXBOL', name: 'å¢¨è¥¿å“¥MEXBOL' },
    
    // æ¬§æ´²
    'spain': { index: 'IBEX35', name: 'è¥¿ç­ç‰™IBEX35' },
    'germany': { index: 'DAX', name: 'å¾·å›½DAX' },
    'france': { index: 'CAC40', name: 'æ³•å›½CAC40' },
    'uk': { index: 'FTSE', name: 'è‹±å›½å¯Œæ—¶' },
    'italy': { index: 'FTSEMIB', name: 'æ„å¤§åˆ©FTSEMIB' },
    'netherlands': { index: 'AEX', name: 'è·å…°AEX' },
    'switzerland': { index: 'SMI', name: 'ç‘å£«SMI' },
    
    // äºšæ´²
    'japan': { index: 'NIKKEI225', name: 'æ—¥ç»225' },
    'hk': { index: 'HSI', name: 'æ’ç”ŸæŒ‡æ•°' },
    'china': { index: 'SSE50', name: 'ä¸Šè¯50' },
    'shenzhen': { index: 'SZI', name: 'æ·±è¯æˆæŒ‡' },
    'korea': { index: 'KOSPI', name: 'éŸ©å›½KOSPI' },
    'taiwan': { index: 'TWII', name: 'å°æ¹¾åŠ æƒ' },
    'india': { index: 'NIFTY', name: 'å°åº¦NIFTY' },
    'australia': { index: 'AS51', name: 'æ¾³æ´²AS51' },
    
    // å…¶ä»–
    'russia': { index: 'IMOEX', name: 'ä¿„ç½—æ–¯IMOEX' },
    'singapore': { index: 'STI', name: 'æ–°åŠ å¡STI' }
  };

  // 2. æ¿å—æ˜ å°„
  const sectorMap = {
    'ç§‘æŠ€': 'technology',
    'é‡‘è': 'financial',
    'åŒ»ç–—': 'healthcare', 
    'èƒ½æº': 'energy',
    'åŸææ–™': 'basic_materials',
    'å·¥ä¸š': 'industrials',
    'æ¶ˆè´¹': 'consumer_cyclical',
    'é˜²å¾¡': 'consumer_defensive',
    'å…¬ç”¨äº‹ä¸š': 'utilities',
    'æˆ¿åœ°äº§': 'real_estate',
    'ç”µä¿¡': 'telecommunications'
  };

  // 3. æ™ºèƒ½åŒ¹é…é€»è¾‘
  let detectedMarket = 'SPX500'; // é»˜è®¤
  let detectedSector = 'AUTO';
  
  // åŒ¹é…å¸‚åœº
  for (const [key, value] of Object.entries(marketMap)) {
    if (norm.includes(key) || text.includes(value.name)) {
      detectedMarket = value.index;
      break;
    }
  }
  
  // åŒ¹é…æ¿å—
  for (const [key, value] of Object.entries(sectorMap)) {
    if (norm.includes(key)) {
      detectedSector = value;
      break;
    }
  }

  // 4. ç‰¹æ®Šç»„åˆé€»è¾‘
  // ç¾è‚¡+ç§‘æŠ€æ¿å—
  if ((norm.includes('nasdaq') || norm.includes('ç§‘æŠ€')) && detectedMarket === 'SPX500') {
    detectedMarket = 'NAS100';
  }
  
  // Aè‚¡ç‰¹å®šé€»è¾‘
  if (norm.includes('aè‚¡') || norm.includes('æ²ªæ·±')) {
    detectedMarket = norm.includes('æ·±åœ³') ? 'SZI' : 'SSE50';
  }

  console.log(`ğŸ¯ è§£æç»“æœ: å¸‚åœº=${detectedMarket}, æ¿å—=${detectedSector}`);
  
  return {
    region: getRegionFromIndex(detectedMarket),
    index: detectedMarket,
    sector: detectedSector
  };
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æŒ‡æ•°è·å–åœ°åŒº
function getRegionFromIndex(index) {
  const regionMap = {
    'SPX500': 'US', 'NAS100': 'US', 'DJI': 'US', 'RUT': 'US',
    'IBEX35': 'ES', 'DAX': 'DE', 'CAC40': 'FR', 'FTSE': 'UK',
    'NIKKEI225': 'JP', 'HSI': 'HK', 'SSE50': 'CN', 'SZI': 'CN'
  };
  return regionMap[index] || 'US';
}