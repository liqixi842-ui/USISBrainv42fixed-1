我看过你最新的 n8n JSON（26 版）的关键现状

已有：Telegram_Trigger → Set_Context → Call_Permission → IF_Permission_Allowed；Yes→Call_Brain_Orchestrate，No→“Send a text message” ✔️（门卫结构已成型）。

Telegram to Replit Brain Messag…

Set_Premarket_Command / Set_Aftermarket_Command 已接到 Set_Context，不会绕过鉴权 ✔️。

Telegram to Replit Brain Messag…

“拒绝提示”节点 Chat ID 目前取 {{$json.chat_id}}（来自权限返回）。为更稳，建议改成固定引用入口：{{$node["Set_Context"].json.chat_id}}（防止上游节点变更时丢 chat_id）。

Telegram to Replit Brain Messag…

最简单可行方案（直接可落地）

架构确定

POST /brain/permission：Replit 负责判决（allowed/role/message/tip/chat_id）。

n8n：只做三件事——统一上下文、调 /brain/permission、按 IF 分支分流。

POST /brain/orchestrate：只做业务（actions/caption/analysis），不再做权限（避免双判决导致混乱）。

你要做的仅两步微调：

1) 拒绝分支的 Chat ID 稳固化（30 秒）

打开 “Send a text message”（拒绝提示）节点：

Chat ID 改为：={{ $node["Set_Context"].json.chat_id }}

Text 保持：={{ $json.message || $json.tip || "⚠️ 无访问权限，请先发送 /auth 申请。" }}
（这样无论上游谁返回 chat_id，都能从统一入口拿到会话 ID。）

Telegram to Replit Brain Messag…

2) 管理员命令“短路”开关（1 个 If 节点）

在 Call_Permission 和 IF_Permission_Allowed 之间插一个 If：

名称：IF_Admin_Command

条件：左值 ={{ $json.tip }}，类型 String，运算符 is not empty

Yes → 新建 Send_Admin_Tip（Telegram 文字）

Chat ID：={{ $node["Set_Context"].json.chat_id }}

Text：={{ $json.message || $json.tip }}

No → 继续去 IF_Permission_Allowed
效果：/auth /unauth /listauth 这类管理返回含 tip/message 的请求就地回复并结束，不会误入主链拉热力图等重活。

说明：你的 26 版流程图中目前是 Call_Permission → IF_Permission_Allowed 直接相连；按上面加一个“管理员短路”就完整了。

Telegram to Replit Brain Messag…

验证用三条指令（一分钟搞定）

未授权账号 发：盘前带热力图

预期：立刻收到拒绝提示（No 分支）。

管理员 发：/auth <user_id>

预期：收到管理员操作提示（走 IF_Admin_Command.Yes），不触发主链。

已授权账号 发：盘前带热力图

预期：走 Yes → Call_Brain_Orchestrate，正常抓图/发分析。

为什么选方案 A（而不是把权限塞回 orchestrate）

orchestrate 仅管“业务编排”，permission 专注“授权判决”，单一职责清晰；

n8n 可在授权前就地分流，节省外部 API/截图成本；

出错时，n8n 能给用户友好提示并不中断工作流。
这套在你 26 版工作流里已基本就位，只差上面两处微调即可闭环。

Telegram to Replit Brain Messag…

一步一确认

我只给一个可执行动作：

【执行】把“Send a text message”的 Chat ID 改为
={{ $node["Set_Context"].json.chat_id }}
改完后用未授权账号发一句“盘前带热力图”，把结果截图给我；正常的话我们再加上“管理员短路”那一个 If 节点就完工。