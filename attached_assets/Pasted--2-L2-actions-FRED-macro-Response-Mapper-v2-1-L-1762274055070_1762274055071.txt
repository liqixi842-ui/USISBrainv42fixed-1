ç¬¬2æ­¥ï½œåœ¨ L2 å‡ºå£æ¥å…¥å¯è§†åŒ–å†³ç­– + ç”Ÿæˆå•å›¾ + å†™å…¥ actionsã€‘

ä½ç½®ï¼šå®Œæˆ FRED å®è§‚æ•°æ® macro æ‹‰å–ä¹‹åã€Response Mapper(v2) ä¹‹å‰ã€‚

1) è¯»å– L1 æ„å›¾ä¸æ–‡æœ¬ï¼Œåšæœ€å°åˆ¤å®š
// L2: decide minimal visualization (single only)
const l1Intent = levels?.l1?.intent || { mode: intent?.mode, lang: intent?.lang };
const visualIntent = detectVisualizationNeedSimple(l1Intent, text);

2) å¦‚éœ€è¦å›¾è¡¨ï¼šç”Ÿæˆå•å›¾ URL
let chartUrls = [];
if (visualIntent.needChart && visualIntent.style === 'single' && visualIntent.metrics?.length === 1) {
  const metric = visualIntent.metrics[0];      // 'CPIAUCSL' | 'UNRATE' | 'GDPC1' | 'FEDFUNDS'
  try {
    const url = await generateSmartChartSingle(macro, metric);
    if (url) chartUrls.push({ metric, url });
  } catch (e) {
    console.error('[viz-single] fail:', e.message);
  }
}

3) å°†å¯è§†åŒ–è®¡åˆ’å†™å…¥è®¡åˆ’ä¸åŠ¨ä½œï¼ˆä¾› n8n è¿­ä»£å‘é€ï¼‰
// å†™å…¥ L2 è®¡åˆ’ï¼ˆå‹å¥½åŒ–æ˜ å°„ä¼šåœ¨ Response Mapper ä¸­å¤„ç†ï¼‰
if (chartUrls.length > 0) {
  l2_plan.push('viz_single');  // è®©å‹å¥½æ˜ å°„æŠŠå®ƒå˜æˆâ€œå•æŒ‡æ ‡å›¾è¡¨â€
}

// å†™å…¥ actions ä¾› n8n æ¶ˆè´¹ï¼ˆè„‘-ä½“åˆ†ç¦»ï¼šBrainä¸ç›´æ¥å‘å›¾ï¼‰
if (!Array.isArray(actions_v2)) actions_v2 = [];
for (const { metric, url } of chartUrls) {
  actions_v2.push({
    type: 'send_chart',
    metric,                   // 'CPIAUCSL' / 'UNRATE' / 'GDPC1' / 'FEDFUNDS'
    url,
    caption: `ğŸ“ˆ ${metric} æœ€è¿‘èµ°åŠ¿ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰`  // å¯åç»­æ¥å…¥æ›´èªæ˜çš„AIçŸ­è¯„
  });
}

// å¯é€‰ï¼šæŠŠå†³ç­–æš´éœ²åˆ° levelsï¼Œä¾¿äºè°ƒè¯•ä¸åŸ‹ç‚¹
levels = levels || {};
levels.l2 = { ...(levels.l2 || {}), visualIntent };


è¯´æ˜ï¼š

è¿™ä¸ä¼šé˜»å¡ä½ çš„ä¸»é€»è¾‘ï¼›åªåœ¨éœ€è¦æ—¶ç”Ÿæˆä¸€å¼ å›¾ã€‚

åç»­è‹¥æ‰©å±• comparison/gridï¼Œåªåœ¨è¿™ä¸€å—æ‹“å±•ï¼Œä¸æ”¹å…¶å®ƒå¤„ã€‚

4) Response Mapper(v2) å°è¡¥å……ï¼ˆè‹¥å°šæœªæ³¨å…¥ï¼‰

ç¡®ä¿æŠŠ actions_v2 å’Œ visualIntent å¸¦åˆ°å“åº”é‡Œï¼ˆå¦‚æœä½ æŒ‰æˆ‘ä¹‹å‰çš„ Mapper å†™æ³•ï¼Œå·²åŒ…å«ï¼›è‹¥æ²¡æœ‰å°±åŠ ä¸Šè¿™ä¸¤è¡Œï¼‰ï¼š

responseV2.levels.l2.visualIntent = visualIntent;
responseV2.actions = actions_v2;        // n8n éå†å‘é€
responseV2.media = { charts: chartUrls }; // ï¼ˆå¯é€‰ï¼‰å…¼å®¹å­—æ®µ

ğŸ” è‡ªæµ‹ï¼ˆTelegram ä¸‰å¥è¯ï¼‰

æœåŠ¡å™¨é‡å¯åï¼Œåœ¨ Telegram é‡Œä¾æ¬¡å‘ï¼š

å•æŒ‡æ ‡åœºæ™¯ï¼ˆåº”æ”¶åˆ° 1 å¼ å›¾ + æ–‡æœ¬ï¼‰

CPI æœ€è¿‘è¶‹åŠ¿


çº¯æ–‡å­—åœºæ™¯ï¼ˆä¸å‘å›¾ï¼‰

é¢„è§ˆä¸‹å®è§‚æ•°æ®


å¦ä¸€ä¸ªå•æŒ‡æ ‡ï¼ˆå¤±ä¸šç‡ï¼‰

å¤±ä¸šç‡ä¸Šå‡äº†å—ï¼Ÿ


æœŸæœ›ï¼š

ç¬¬1ã€ç¬¬3æ¡ï¼šæ¶ˆæ¯åè·Ÿä¸€å¼ å›¾ï¼ˆn8n éœ€è¿­ä»£ actions å‘é€ï¼Œè§ä¸‹ï¼‰ã€‚

ç¬¬2æ¡ï¼šåªæœ‰æ–‡å­—æ€»ç»“ï¼Œæ— å›¾è¡¨ã€‚

ï¼ˆå…ˆæ”¶è—ï¼‰n8n ä¾§â€œè¿­ä»£å‘é€â€æœ€å°ä»£ç ï¼ˆç­‰ä½ éªŒè¯ Brain è¾“å‡ºåå†æ¥ï¼‰

åœ¨ Parse_Brain_Response ä¹‹ååŠ ä¸€ä¸ª Code èŠ‚ç‚¹ï¼ˆEmit_Chart_Actionsï¼‰ï¼ŒæŠŠ actions å±•å¹³æˆå¤šæ¡ï¼š

const acts = $json.actions || [];
const out = [];
for (const a of acts) {
  if (a.type === 'send_chart' && a.url) {
    out.push({ json: { chat_id: $node["Telegram_Trigger"].json.message.chat.id, url: a.url, caption: a.caption || '' }});
  }
}
return out.length ? out : [{ json: { skip: true }}];


å†æ¥ä¸€ä¸ª Telegram â†’ Send Photoï¼š

Chat ID: ={{ $json.chat_id }}

Photo: ={{ $json.url }}

Caption: ={{ $json.caption }}

è¿™æ®µç­‰ä½ ç¡®è®¤ Brain å“åº”é‡Œ actions å·²ç»åŒ…å« send_chart åï¼Œå†è®©æˆ‘å¸¦ä½ æ¥å…¥ã€‚