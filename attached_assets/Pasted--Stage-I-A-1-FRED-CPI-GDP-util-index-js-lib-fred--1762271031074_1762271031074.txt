âœ… Stage I æ”¶å°¾æ¸…å•ï¼ˆå¯ç›´æ¥è½åœ°ï¼‰
A) å…è´¹æ•°æ®æºæœ€å°æ¥å…¥æ¨¡æ¿
1) FREDï¼ˆå®è§‚ï¼šCPI/å¤±ä¸šç‡/GDP ç­‰ï¼‰

æ–°å¢ utilï¼šï¼ˆæ”¾åœ¨ index.js é¡¶éƒ¨é™„è¿‘æˆ– lib/fred.jsï¼‰

const FRED_BASE = 'https://api.stlouisfed.org/fred';
const FRED_KEY  = process.env.FRED_API_KEY || ''; // å¯å…ˆç•™ç©ºï¼Œéƒ¨åˆ†å…¬å…±ç³»åˆ—å¯åŒ¿åè®¿é—®

async function fetchFREDSeries(seriesId, { limit = 12 } = {}) {
  const url = new URL(`${FRED_BASE}/series/observations`);
  url.searchParams.set('series_id', seriesId);
  if (FRED_KEY) url.searchParams.set('api_key', FRED_KEY);
  url.searchParams.set('file_type', 'json');
  url.searchParams.set('sort_order', 'desc');
  url.searchParams.set('limit', String(limit));
  const r = await fetch(url, { timeout: 12000 });
  if (!r.ok) throw new Error(`FRED ${seriesId} HTTP ${r.status}`);
  const j = await r.json();
  const obs = (j.observations || [])
    .map(o => ({ date: o.date, value: Number(o.value || 'NaN') }))
    .filter(o => Number.isFinite(o.value));
  return { seriesId, latest: obs[0] || null, observations: obs.reverse() }; // ä»æ—§åˆ°æ–°
}


åœ¨æ•°æ®æ”¶é›†æµç¨‹æŒ‚é’©ï¼š

async function collectMacroData({ needMacro = false } = {}) {
  if (!needMacro) return null;
  const seriesWanted = [
    'CPIAUCSL',       // CPI
    'UNRATE',         // å¤±ä¸šç‡
    'GDPC1',          // å®é™…GDP
    'FEDFUNDS',       // è”é‚¦åŸºé‡‘åˆ©ç‡
  ];
  const out = {};
  for (const id of seriesWanted) {
    try { out[id] = await fetchFREDSeries(id, { limit: 12 }); }
    catch (e) { out[id] = { seriesId: id, error: e.message }; }
  }
  return out;
}


åœ¨ orchestrate é‡ŒæŒ‰åœºæ™¯è§¦å‘ï¼ˆç¤ºä¾‹ï¼‰ï¼š

const needMacro = (levels?.l1?.intent?.mode === 'premarket') || /å®è§‚|CPI|å¤±ä¸š|GDP/.test(text || '');
const macro = await collectMacroData({ needMacro });


æ˜ å°„åˆ° v2 å“åº”ï¼š

market_data.macro = macro || null;
if (macro) l2_plan.push('fetch_macro_fred');

2) Reddit / WallStreetBetsï¼ˆå…è´¹ tierï¼šçƒ­åº¦ + ç®€æ˜“æƒ…ç»ªï¼‰

æœ€å°å®ç°ï¼ˆæ— éœ€ OAuthï¼Œå…¬å…± JSONï¼‰ï¼š

async function fetchRedditWSBHot({ limit = 10 } = {}) {
  const url = `https://www.reddit.com/r/wallstreetbets/hot.json?limit=${limit}`;
  const r = await fetch(url, { headers: { 'User-Agent': 'USIS/1.0 (+reddit)' }, timeout: 12000 });
  if (!r.ok) throw new Error(`Reddit HTTP ${r.status}`);
  const j = await r.json();
  const posts = (j.data?.children || []).map(c => c.data).map(p => ({
    id: p.id,
    title: p.title,
    ups: p.ups || 0,
    num_comments: p.num_comments || 0,
    created_utc: p.created_utc,
    selftext: p.selftext || '',
  }));
  // ç®€æ˜“æƒ…ç»ª(æç®€è¯å…¸/è¡¨æƒ…)ï¼šæ­£å‘è¯ +1ï¼Œè´Ÿå‘è¯ -1
  const pos = [/call/i, /bull/i, /to the moon/i, /ğŸš€/];
  const neg = [/put/i, /bear/i, /dump/i, /âš ï¸|ğŸ”»/];
  function score(t) {
    let s = 0;
    for (const r of pos) if (r.test(t)) s++;
    for (const r of neg) if (r.test(t)) s--;
    return s;
  }
  const scored = posts.map(p => ({ ...p, sentiment: score(`${p.title} ${p.selftext}`) }));
  const sentimentIndex = scored.reduce((a,b)=>a+b.sentiment,0) / Math.max(scored.length,1);
  return { posts: scored.slice(0, limit), sentimentIndex };
}


åœ¨ orchestrate ä¸­æŒ‰éœ€è§¦å‘ï¼š

const needWSB = /æƒ…ç»ª|WSB|reddit|æ•£æˆ·|ç¤¾äº¤/.test(text || '') || (levels?.l1?.intent?.mode === 'insight' /* ä½ å®šä¹‰çš„èµ„è®¯åœºæ™¯ */);
let wsb = null;
try {
  if (needWSB) { wsb = await fetchRedditWSBHot({ limit: 15 }); l2_plan.push('fetch_reddit_wsb'); }
} catch(e) {
  wsb = { error: e.message };
}


æ˜ å°„åˆ° v2 å“åº”ï¼š

market_data.social = { reddit_wsb: wsb };

B) å¥åº·åº¦æŒ‡æ ‡åŸ‹ç‚¹ï¼ˆæœ€å°å¯ç”¨ï¼‰

å»ºè®®è¡¨ï¼šorchestrator_metrics

CREATE TABLE IF NOT EXISTS orchestrator_metrics (
  id SERIAL PRIMARY KEY,
  request_id TEXT NOT NULL,
  intent_mode TEXT,
  l1_ms INTEGER,
  l2_ms INTEGER,
  l3_ms INTEGER,
  total_ms INTEGER,
  models_used JSONB,
  cost_estimated NUMERIC(18,6),
  cost_total NUMERIC(18,6),
  l3_triggered BOOLEAN,
  created_at TIMESTAMP DEFAULT NOW()
);


Node ç«¯åŸ‹ç‚¹ï¼ˆé€€å‡ºå‰å†™å…¥ï¼‰ï¼š

const t0 = performance.now();
// ... L1/L2/L3 å„å¤„è®°å½• tL1, tL2, tL3 ç»“æŸç‚¹
const total_ms = Math.round(performance.now() - t0);

try {
  await db.query(
    `CREATE TABLE IF NOT EXISTS orchestrator_metrics (
      id SERIAL PRIMARY KEY,
      request_id TEXT NOT NULL,
      intent_mode TEXT,
      l1_ms INTEGER, l2_ms INTEGER, l3_ms INTEGER, total_ms INTEGER,
      models_used JSONB,
      cost_estimated NUMERIC(18,6),
      cost_total NUMERIC(18,6),
      l3_triggered BOOLEAN,
      created_at TIMESTAMP DEFAULT NOW()
    );`
  );
  await db.query(
    `INSERT INTO orchestrator_metrics
      (request_id, intent_mode, l1_ms, l2_ms, l3_ms, total_ms, models_used, cost_estimated, cost_total, l3_triggered)
     VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)`,
    [
      requestId,
      (levels?.l1?.intent?.mode || null),
      Math.round((tL1_end - t0) || 0),
      Math.round((tL2_end - tL1_end) || 0),
      Math.round((tL3_end - tL2_end) || 0),
      total_ms,
      JSON.stringify(l2_models || []),
      Number(estCost ?? 0),
      Number(totalCost ?? 0),
      !!l3_triggered
    ]
  );
} catch (e) {
  console.error('[metrics]', e.message);
}


å…³é”® KPIï¼ˆåé¢ç”¨äºé¢æ¿ï¼‰ï¼š

p50/p95 å“åº”æ—¶é—´ï¼ˆtotal_msï¼‰

L3 è§¦å‘ç‡ï¼ˆå¤æ‚åœºæ™¯å æ¯”ï¼‰

æˆæœ¬ï¼šestimated vs totalï¼ˆå·®å€¼ï¼‰

æ•°æ®æºå‘½ä¸­ç‡ & é”™è¯¯ç‡ï¼ˆSEC/FRED/WSBï¼‰

æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒï¼ˆl2_modelsï¼‰

C) éªŒæ”¶è‡ªæµ‹ç”¨ä¾‹ï¼ˆ3 æ¡ï¼‰

å®è§‚è§¦å‘

curl -sX POST http://localhost:5000/brain/orchestrate \
 -H 'Content-Type: application/json' \
 -d '{"text": "é¢„è§ˆä¸‹å®è§‚ï¼šCPIä¸å¤±ä¸šç‡èµ°åŠ¿", "mode":"premarket", "user_id":"u1", "budget":"low"}' | jq '.levels,.market_data.macro'


WSB æƒ…ç»ªè§¦å‘

curl -sX POST http://localhost:5000/brain/orchestrate \
 -H 'Content-Type: application/json' \
 -d '{"text": "çœ‹çœ‹WSBæ•£æˆ·æƒ…ç»ª", "mode":"insight", "user_id":"u2"}' | jq '.levels,.market_data.social.reddit_wsb.sentimentIndex'


è´¦æœ¬/æŒ‡æ ‡æ£€æŸ¥

SELECT COUNT(*) sec_ok FROM orchestrate_logs WHERE sec_financials IS NOT NULL; -- è‹¥æœ‰
SELECT * FROM orchestrator_metrics ORDER BY id DESC LIMIT 5;

â–¶ï¸ åªç»™ä¸€ä¸ªä¸‹ä¸€æ­¥ï¼ˆä¸€æ­¥ä¸€ç¡®è®¤ï¼‰

ã€ä¸‹ä¸€æ­¥ã€‘ å…ˆæŠŠ FRED æœ€å°æ¥å…¥è½è¿› orchestrateï¼š

åŠ  fetchFREDSeries & collectMacroData ä¸¤æ®µï¼›

åœ¨ orchestrate åˆ¤å®š needMacro å¹¶è°ƒç”¨ï¼›

æŠŠ market_data.macro = macroï¼›

l2_plan.push('fetch_macro_fred')ï¼›

è·‘â€œå®è§‚è§¦å‘â€é‚£æ¡ curlï¼Œçœ‹å“åº”é‡Œ market_data.macro æ˜¯å¦å‡ºç° CPI/UNRATE/GDPC1/FEDFUNDS çš„ latest å€¼ã€‚

å®Œæˆåå›æˆ‘ï¼šâ€œFRED OKï¼ˆé™„ä¸€è¡Œ CPI latest å€¼ï¼‰â€ã€‚
æˆ‘å†ç»™ä½  Reddit/WSB çš„æœ€å°è”è°ƒæ£€æŸ¥è¦ç‚¹ï¼ˆä»¥åŠ 3 æ¡å¸¸è§è¶…æ—¶/429 çš„å®¹é”™è¡¥ä¸ï¼‰ã€‚