{
  "name": "Capture TradingView Heatmap via Browserless",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "capture_heatmap",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "005207c9-d2ef-4a32-a7c5-404570674eab",
      "name": "Receive Heatmap Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "webhookId": "capture_heatmap"
    },
    {
      "parameters": {
        "respondWith": "binary",
        "options": {}
      },
      "id": "f1042ebb-28fb-4837-a035-efa8142e4964",
      "name": "Return Image to Replit",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        448,
        0
      ]
    },
    {
      "parameters": {
        "url": "https://shot.screenshotapi.net/screenshot",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "HHBYB5H-4CT4970-MVZEKM2-EMEWEXX"
            },
            {
              "name": "url",
              "value": "={{ $json.body.url }}"
            },
            {
              "name": "fresh",
              "value": "true"
            },
            {
              "name": "output",
              "value": "json"
            },
            {
              "name": "width",
              "value": "1920"
            },
            {
              "name": "height",
              "value": "1080"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        0
      ],
      "id": "74193017-c515-4039-81b0-1113819276aa",
      "name": "ScreenshotAPI 截图服务"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{$json.needs_symbol_chart || ($json.actions && $json.actions.includes('symbol_chart'))}}\n",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "6dab9317-cc7c-45ab-9ad3-aa3010a2fce1",
      "name": "IF_Needs_SymbolChart",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        224,
        320
      ]
    },
    {
      "parameters": {
        "url": "https://shot.screenshotapi.net/screenshot",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "={{ \"https://www.tradingview.com/chart/?symbol=\" + ($json.symbols[0].includes(\":\") ? $json.symbols[0] : \"NASDAQ:\" + $json.symbols[0]) + \"&interval=D\" }}"
            },
            {
              "name": "full_page",
              "value": "false"
            },
            {
              "name": "timeout",
              "value": "30000"
            },
            {
              "name": "width",
              "value": "1200"
            },
            {
              "name": "height",
              "value": "800"
            }
          ]
        },
        "options": {
          "timeout": 90000
        }
      },
      "id": "615fe74d-a22e-4e71-a22d-b2a0e0ccbccd",
      "name": "Screenshot_SymbolChart",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        448,
        224
      ]
    },
    {
      "parameters": {
        "url": "https://www.alphavantage.co/query",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "function",
              "value": "GLOBAL_QUOTE"
            },
            {
              "name": "symbol",
              "value": "={{ $json.symbols[0] }}"
            },
            {
              "name": "apikey",
              "value": "01M0ZKMJW0TIJ6BG"
            }
          ]
        },
        "options": {
          "response": {
            "response": {}
          },
          "timeout": 10000
        }
      },
      "id": "4f92c774-15e6-4871-97b9-03d755d8b6f2",
      "name": "Fetch_Quote_Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        448,
        416
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    screenshot: $json.screenshot || $json.screenshotUrl || $json.image_url || null\n  }\n}];\n"
      },
      "id": "f90667f5-76ca-4de3-99f5-692aa7746119",
      "name": "Normalize_SymbolChart",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        224
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json || {};\n\nreturn [{\n  json: {\n    final_text: data.final_analysis || data.final_text || data.answer || \"未收到分析结果\",\n    symbols: data.symbols || [],\n    chat_id: (() => {\n      try {\n        return $node[\"Telegram_Trigger\"].json.message.chat.id;\n      } catch (e) {\n        return data.chat_id || null;\n      }\n    })(),\n    needs_heatmap: Array.isArray(data.actions) && data.actions.some(a => a.type === 'fetch_heatmap'),\n    heatmap_url: Array.isArray(data.actions)\n      ? (data.actions.find(a => a.type === 'fetch_heatmap')?.url || null)\n      : null,\n    needs_charts: Array.isArray(data.actions) && data.actions.some(a => a.type === 'send_chart'),\n    charts: Array.isArray(data.actions) \n      ? data.actions.filter(a => a.type === 'send_chart')\n      : [],\n    actions: data.actions || []\n  }\n}];"
      },
      "id": "50a34760-6d28-4560-9823-b211cbe235c8",
      "name": "Parse_Brain_Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format quote data from Alpha Vantage Global Quote response\nconst quoteData = $json['Global Quote'] || {};\n\nconst price = quoteData['05. price'] || '';\nconst changePercent = quoteData['10. change percent'] || '';\nconst high = quoteData['03. high'] || '';\nconst low = quoteData['04. low'] || '';\n\nif (!price) {\n  return [{\n    json: {\n      quote_line: ''\n    }\n  }];\n}\n\n// Remove % sign from change percent if present\nconst cleanChangePercent = typeof changePercent === 'string' ? changePercent.replace('%', '') : changePercent;\n\nconst quoteLine = `现价 $${price} (${cleanChangePercent}%), 日内波动 ${high}-${low}`;\n\nreturn [{\n  json: {\n    quote_line: quoteLine\n  }\n}];"
      },
      "id": "81855b81-585c-48dd-b1cc-3f6e843787b2",
      "name": "Format_Quote",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        416
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "id": "1ac5df81-d877-4234-9691-eaee3657ba92",
      "name": "Merge_Quote",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        896,
        320
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Receive Heatmap Request": {
      "main": [
        [
          {
            "node": "ScreenshotAPI 截图服务",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ScreenshotAPI 截图服务": {
      "main": [
        [
          {
            "node": "Return Image to Replit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse_Brain_Response": {
      "main": [
        [
          {
            "node": "IF_Needs_SymbolChart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Needs_SymbolChart": {
      "main": [
        [
          {
            "node": "Screenshot_SymbolChart",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch_Quote_Data",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Screenshot_SymbolChart": {
      "main": [
        [
          {
            "node": "Normalize_SymbolChart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch_Quote_Data": {
      "main": [
        [
          {
            "node": "Format_Quote",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format_Quote": {
      "main": [
        [
          {
            "node": "Merge_Quote",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Normalize_SymbolChart": {
      "main": [
        [
          {
            "node": "Merge_Quote",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "25e5e692-6b1a-4ac1-bf1e-73d76f80bed8",
  "meta": {
    "instanceId": "e55566bfe54f88b404d502841707ce3b88351798d04a45b88b4e50f6ca391fb1"
  },
  "id": "94XFa6PjmmbNI3a6",
  "tags": []
}