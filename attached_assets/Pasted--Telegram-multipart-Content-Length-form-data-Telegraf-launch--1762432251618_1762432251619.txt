ç»™ä½ ç›´æ¥ä¸Šæœ€å°å¯ç”¨è¡¥ä¸ï¼šå®‰å…¨ä¸Šä¼  Telegram æ–‡æ¡£ï¼ˆmultipartï¼‰ã€‚å®ƒé¿å¼€ Content-Length é™·é˜±ï¼ˆè®© form-data è‡ªå·±ç®—ï¼‰ï¼Œä¸èµ° Telegraf çš„ launch()ï¼Œåªç”¨ Telegram HTTP APIï¼Œé€‚é…ä½ ç°åœ¨çš„â€œæ‰‹åŠ¨è½®è¯¢ + Express:5000â€ æ¶æ„ã€‚
æŠŠä¸‹é¢ä¸¤æ®µå¡è¿› index.jsï¼ˆæˆ–æ‹†åˆ° telegramSender.js å†å¼•å…¥ï¼‰ã€‚

1) é€šç”¨å‘é€å™¨ï¼šsendDocumentBuffer()ï¼ˆåŸºäº node-fetch v2 + form-dataï¼‰
// ===== Telegram Document Sender (safe multipart) =====
const FormData = require('form-data');
const fetch = require('node-fetch'); // v2.6.7

async function sendDocumentBuffer(token, chatId, buffer, filename, caption = '') {
  if (!Buffer.isBuffer(buffer)) {
    throw new Error('sendDocumentBuffer: buffer must be a Buffer');
  }
  // ä¿é™©ï¼šTelegram å•æ–‡ä»¶ä¸Šé™ 50MBï¼ˆæ›´å¤§çš„è¦ sendDocument åˆ° Telegram æ–‡ä»¶IDæµç¨‹ï¼Œè¿™é‡Œä¸éœ€è¦ï¼‰
  if (buffer.length > 45 * 1024 * 1024) {
    throw new Error(`file too large: ${(buffer.length/1024/1024).toFixed(2)}MB`);
  }

  const form = new FormData();
  form.append('chat_id', String(chatId));
  form.append('caption', caption.slice(0, 1000)); // Telegram caption æœ€é•¿ 1024
  // æ˜¾å¼ç»™å‡º filename å’Œ contentTypeï¼Œé¿å…æ¢æµ‹å‡ºé”™å¯¼è‡´å´©æºƒ
  form.append('document', buffer, { filename: filename || 'heatmap.png', contentType: 'image/png' });

  // âš ï¸ åˆ‡è®°ï¼šä¸è¦æ‰‹å·¥è®¾ç½® Content-Lengthï¼Œè®© form-data è‡ªå·±ç®—å¹¶åŠ  boundary
  const res = await fetch(`https://api.telegram.org/bot${token}/sendDocument`, {
    method: 'POST',
    headers: form.getHeaders(), // è‡ªåŠ¨å¸¦ boundary
    body: form,
    // å¯é€‰ï¼šé•¿å›¾æ—¶ç»™æ›´å®½æ¾è¶…æ—¶
    timeout: 45000,
  });

  const text = await res.text(); // æ°¸è¿œå…ˆ textï¼Œå†å°è¯• JSON
  if (!res.ok) {
    throw new Error(`sendDocument failed ${res.status}: ${text}`);
  }
  // å°è¯•è§£æ JSON ç»“æœ
  try {
    const json = JSON.parse(text);
    if (!json.ok) throw new Error(json.description || 'telegram ok=false');
    return json;
  } catch (e) {
    // Telegram è¿”å›äº†é JSONï¼ˆæå°‘è§ï¼‰ï¼Œè®°å½•æ–‡æœ¬
    throw new Error(`sendDocument non-json: ${text.slice(0, 200)}`);
  }
}


2) åœ¨ä½ çš„æ¶ˆæ¯å¤„ç†é‡Œè°ƒç”¨ï¼ˆæ›¿æ¢åŸæ¥çš„å‘é€é€»è¾‘ï¼‰
// å‡è®¾ä½ å·²æœ‰ TELEGRAM_TOKENã€handleTelegramMessage ç­‰
async function handleTelegramMessage(message) {
  const chatId = message.chat.id;
  const text = message.text || '';

  // ç®€å•åˆ†æµï¼šçƒ­åŠ›å›¾
  if (text.includes('çƒ­åŠ›å›¾') || text.toLowerCase().includes('heatmap')) {
    // å…ˆå¿«é€Ÿåé¦ˆï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºå¡æ­»
    await telegramAPI('sendMessage', { chat_id: chatId, text: 'ğŸ¨ æ­£åœ¨ç”Ÿæˆçƒ­åŠ›å›¾...' });

    // ç”Ÿæˆçƒ­åŠ›å›¾ï¼ˆä½ ç°æœ‰çš„é€»è¾‘ï¼‰
    const result = await generateSmartHeatmap(text);
    // result.buffer: PNG Buffer (~365KB)
    // result.caption: æ–‡æ¡ˆ
    // å…³é”®ï¼šå‘é€ç”¨â€œæ–‡æ¡£é€šé“â€ï¼Œæ›´ç¨³ï¼Œä¸èµ°ç…§ç‰‡å‹ç¼©/æ¢æµ‹
    await sendDocumentBuffer(TELEGRAM_TOKEN, chatId, result.buffer, 'heatmap.png', result.caption || '');

    // å¦‚æœä½ è¿˜æƒ³å‘ summary æ–‡æœ¬ï¼š
    if (result.summary) {
      await telegramAPI('sendMessage', { chat_id: chatId, text: result.summary.slice(0, 4000) });
    }
    return;
  }

  // å¸¸è§„åˆ†æè·¯å¾„ï¼ˆç•¥ï¼‰
  await telegramAPI('sendMessage', { chat_id: chatId, text: 'ğŸ‘Œ å·²æ”¶åˆ°' });
}


3) ä¸¤ä¸ªå…³é”®æ³¨æ„ç‚¹ï¼ˆä½ å½“å‰ç¯å¢ƒçš„â€œæ˜“è¸©å‘â€ï¼‰


ä¸è¦ç»™ multipart æ‰‹åŠ¨è®¾ç½® Content-Lengthã€‚
ä½ å·²ç»ä¿®å¥½äº† JSON æƒ…å†µä¸‹çš„ Buffer.byteLengthï¼›ä½† multipart é‡Œ boundary é•¿åº¦æ˜¯å¯å˜çš„ï¼Œæ‰‹åŠ¨å†™é”™å°±ä¼šè§¦å‘åº•å±‚è¿æ¥è¢«å¯¹ç«¯å…³é—­ï¼ŒReplit å¯èƒ½ç›´æ¥æŠŠè¿›ç¨‹æ•´æ­»è€Œä¸ä¼šæŠ›åˆ°ä½ çš„ JS å±‚ã€‚äº¤ç»™ form-data è‡ªåŠ¨ç®—æœ€å®‰å…¨ã€‚


ä¼˜å…ˆç”¨ sendDocumentï¼Œåˆ«å…ˆç”¨ sendPhotoã€‚
sendPhoto ä¼šèµ°å›¾åƒæ¢æµ‹/å‹ç¼©é€šé“ï¼Œå†å²ä¸Šåœ¨æŸäº› Buffer/ç¼–ç ç»„åˆä¸‹æ›´å®¹æ˜“è§¦å‘ä¸å¯é¢„æœŸè¡Œä¸ºï¼›sendDocument æ˜¯â€œå‚»ä¼ æ–‡ä»¶â€ï¼Œé²æ£’æ€§æ›´å¼ºã€‚ç­‰ç³»ç»Ÿå®Œå…¨ç¨³å®šåå†åˆ‡å› sendPhoto ä¹Ÿè¡Œã€‚



4) å¦‚æœä»ç„¶â€œå‘å®Œå³æ­»â€ï¼ŒåŠ ä¸¤æ¡å®šä½ä¿é™©


åœ¨ sendDocumentBuffer é‡Œæ‰“å° è¿”å›é•¿åº¦ ä¸ HTTP çŠ¶æ€ï¼ˆä¸è¦æ‰“å°å¤§ Bufferï¼‰ï¼š
console.log('[TG] sendDocument status:', res.status, 'len:', text.length);


åŒæ­¥é»‘åŒ£å­è½ç›˜ /tmp/usis-brain.logï¼ˆä½ ä¹‹å‰å·²ç»åœ¨åšï¼‰ï¼Œå…³æ³¨æ˜¯å¦å‡ºç° SIGTERMï¼›è‹¥æ˜¯ï¼Œè€ƒè™‘æŠŠ document å‘é€æ”¾å…¥ setImmediate ä¹‹åæ‰§è¡Œï¼Œé¿å…åœ¨åŒä¸€ tick å†…å’Œè½®è¯¢é‡å é€ æˆçŸ­æ—¶é˜»å¡ã€‚



5) æ¸…ç†å»ºè®®ï¼ˆä½ è®¡åˆ’é‡Œçš„ï¼‰
å¯ä»¥æ”¾å¿ƒåˆ ï¼š


test-telegram-only.js


manual-polling-bot.js


http-with-bot.js


production-bot.js



6) è¿›ä¸€æ­¥ç¨³å›ºï¼ˆå¯é€‰ï¼Œä½†å¼ºçƒˆå»ºè®®ï¼‰


é˜Ÿåˆ—åŒ–â€œç”Ÿæˆâ†’å‘é€â€ï¼Œä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªçƒ­åŠ›å›¾ä»»åŠ¡ï¼ˆä½ æ™šç‚¹æˆ‘ç»™ä½  20 è¡Œå†…å­˜é˜Ÿåˆ—æ¨¡æ¿ï¼‰ã€‚


n8n è¿”å› URL æ›´ä½³ï¼šä½ ç›´æ¥ sendDocument ä¼  URLï¼ˆdocument: 'https://...'ï¼‰ï¼ŒNode ä¾§ä¸è½ Bufferï¼Œå†…å­˜æ›´ç¨³ã€‚


Keep-Aliveï¼šç»™ node-fetch é… https.Agent({ keepAlive:true })ï¼Œé™ä½çŸ­æ—¶é—´å†…çš„ socket æŠ–åŠ¨ã€‚



æŠŠè¿™æ®µä¸Šåˆ°çº¿ï¼Œå†è·‘ä½ é‚£ä¸ªâ€œæ—¥æœ¬å¤§ç›˜çƒ­åŠ›å›¾â€æµç¨‹ã€‚è‹¥ä»å´©ï¼ŒæŠŠ /tmp/usis-brain.log æœ€å 50 è¡Œ + ä½ çœ‹åˆ°çš„ sendDocument failed ... æˆ– HTTP çŠ¶æ€è´´æˆ‘ï¼›æˆ‘ä¼šæ®æ­¤å†³å®šæ˜¯ å¯¹ç«¯æ‹’ç»ã€æœ¬åœ°è¢«æ€ è¿˜æ˜¯ è¾¹ç•Œ caseï¼Œå†ç»™ä½ ç²¾å‡†ä¸‹ä¸€åˆ€ã€‚