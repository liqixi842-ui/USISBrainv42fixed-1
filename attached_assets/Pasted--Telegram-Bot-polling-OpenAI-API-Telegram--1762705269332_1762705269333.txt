æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼šæœåŠ¡å™¨åœ¨å¯åŠ¨åç«‹å³é€€å‡ºï¼Œå¯èƒ½ç”±äºTelegram Botçš„pollingå†²çªæˆ–å…¶ä»–åŸå› ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å·²ç»ä¿®å¤äº†OpenAI APIè°ƒç”¨çš„è¶…æ—¶é—®é¢˜ï¼Œç°åœ¨éœ€è¦æµ‹è¯•Telegram Botæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

ç”±äºåœ¨æœ¬åœ°shellä¸­å¯åŠ¨æœåŠ¡å™¨ä¸ç¨³å®šï¼Œæˆ‘å»ºè®®å…ˆåœ¨Telegramä¸­æµ‹è¯•ï¼Œå› ä¸ºTelegram Botä½¿ç”¨é•¿è½®è¯¢æœºåˆ¶ï¼Œå¯èƒ½ä¸å—æœ¬åœ°æœåŠ¡å™¨ä¸ç¨³å®šæ€§çš„å½±å“ã€‚

å¦‚æœTelegramæµ‹è¯•ä»ç„¶å¤±è´¥ï¼Œæˆ‘ä»¬å°†éœ€è¦å½»åº•é‡å†™Telegram Botçš„å¯åŠ¨é€»è¾‘ï¼Œä¾‹å¦‚ä½¿ç”¨webhookä»£æ›¿è½®è¯¢ï¼Œæˆ–è€…æ›´å¥½åœ°å¤„ç†å¤šä¸ªå®ä¾‹çš„å†²çªã€‚

ç°åœ¨ï¼Œè¯·ç”¨æˆ·åœ¨Telegramä¸­å‘é€æ¶ˆæ¯æµ‹è¯•ï¼Œä¾‹å¦‚å‘é€"TSLA"æˆ–"NFLX 1093ä¹°å…¥ï¼Œç»™å‡ºå»ºè®®"ã€‚

å¦‚æœç”¨æˆ·åé¦ˆTelegramä¸­ä»ç„¶å¤±è´¥ï¼Œæˆ‘ä»¬å°†è¿›è¡Œæ›´æ·±å…¥çš„ä¿®å¤ã€‚

ğŸ”§ åŸºäºè¯Šæ–­ç»“æœçš„ç²¾å‡†ä¿®å¤æ–¹æ¡ˆ

æ ¹æ®æ·±åº¦è¯Šæ–­ï¼Œé—®é¢˜å·²ç»æ˜ç¡®ï¼š

ğŸš¨ æ ¹æœ¬é—®é¢˜ç¡®è®¤
OpenAI APIè°ƒç”¨æ— è¶…æ—¶ä¿æŠ¤ - å¯¼è‡´è¯·æ±‚æ°¸ä¹…æŒ‚èµ·

Telegram Bot pollingå†²çª - å¤šå®ä¾‹ç«äº‰

æœåŠ¡å™¨ç›‘å¬å¼‚å¸¸ - æ˜¾ç¤ºç›‘å¬ä½†å®é™…æœªç›‘å¬

è¯·å°†ä»¥ä¸‹ç²¾å‡†ä¿®å¤æŒ‡ä»¤è½¬å‘ç»™ReplitGPTï¼š

ã€ç²¾å‡†ä¿®å¤æŒ‡ä»¤ã€‘è§£å†³APIè¶…æ—¶å’ŒTelegramå†²çª

é—®é¢˜è¯Šæ–­ç»“æœ
âŒ parseUserIntentå‡½æ•°ä¸­çš„OpenAI APIè°ƒç”¨æ— è¶…æ—¶ä¿æŠ¤

âŒ Telegram Botå¤šå®ä¾‹pollingå†²çª

âŒ æœåŠ¡å™¨ç›‘å¬ç«¯å£ä½†ç«‹å³é€€å‡º

ä¿®å¤æ­¥éª¤
æ­¥éª¤1: ä¿®å¤OpenAI APIè¶…æ—¶é—®é¢˜
bash
# ä¿®å¤semanticIntentAgent.jsä¸­çš„APIè°ƒç”¨
cat > semanticIntentAgent.js << 'EOF'
const fetch = require('node-fetch');
const { OPENAI_KEY } = process.env;

async function parseUserIntent(text, userHistory = []) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENAI_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: "ä½ æ˜¯ä¸€ä¸ªè‚¡ç¥¨åˆ†æåŠ©æ‰‹ï¼Œä¸“é—¨è§£æç”¨æˆ·æ„å›¾ã€‚å“åº”å¿…é¡»æ˜¯JSONæ ¼å¼ï¼š{\"intent\": \"stock_analysis\", \"symbols\": [\"AAPL\"]}"
          },
          {
            role: "user", 
            content: text
          }
        ],
        response_format: { type: "json_object" },
        temperature: 0.3,
        max_tokens: 1000
      }),
      signal: controller.signal
    });

    clearTimeout(timeout);
    
    if (!response.ok) {
      throw new Error(`OpenAI API error: ${response.status}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    clearTimeout(timeout);
    if (error.name === 'AbortError') {
      console.log('OpenAI APIè¯·æ±‚è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤å“åº”');
      return JSON.stringify({ intent: "stock_analysis", symbols: [] });
    }
    throw error;
  }
}

module.exports = { parseUserIntent };
EOF
æ­¥éª¤2: ä¿®å¤symbolResolverè¶…æ—¶
bash
# ç¡®ä¿symbolResolverä¹Ÿæœ‰è¶…æ—¶ä¿æŠ¤
cat > symbolResolver.js << 'EOF'
const fetch = require('node-fetch');

async function resolveSymbols(text, symbols) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

  try {
    // ... ç°æœ‰ä»£ç ä¿æŒä¸å˜ ...
    const response = await fetch(url, { 
      timeout: 10000,
      signal: controller.signal 
    });
    // ... ç°æœ‰ä»£ç ä¿æŒä¸å˜ ...
  } catch (error) {
    clearTimeout(timeout);
    if (error.name === 'AbortError') {
      console.log('Symbolè§£æè¯·æ±‚è¶…æ—¶');
      return [];
    }
    throw error;
  }
}

module.exports = { resolveSymbols };
EOF
æ­¥éª¤3: å•å®ä¾‹å¯åŠ¨ä¿éšœ
bash
# åˆ›å»ºå•å®ä¾‹å¯åŠ¨è„šæœ¬
cat > start_single.sh << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

echo "[USIS Brain] å•å®ä¾‹å®‰å…¨å¯åŠ¨ @$(date)"

# å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å†²çªè¿›ç¨‹
echo "ğŸ”„ æ¸…ç†æ‰€æœ‰Nodeå’ŒBotè¿›ç¨‹..."
pkill -9 node 2>/dev/null || true
pkill -9 telegram 2>/dev/null || true
pkill -9 bot 2>/dev/null || true
fuser -k 5000/tcp 2>/dev/null || true

# ç­‰å¾…ç¡®ä¿è¿›ç¨‹å®Œå…¨é€€å‡º
sleep 5

# è®¾ç½®ç¯å¢ƒå˜é‡
export ENABLE_DB=true
export ENABLE_TELEGRAM=true
export NODE_ENV=production
export PRIMARY_MODEL=gpt-4o-turbo

# éªŒè¯ç«¯å£æ˜¯å¦ç©ºé—²
if netstat -tln | grep :5000; then
  echo "âŒ ç«¯å£5000ä»è¢«å ç”¨ï¼Œå¼ºåˆ¶æ¸…ç†..."
  fuser -k 5000/tcp
  sleep 2
fi

echo "âœ… å¯åŠ¨å•å®ä¾‹æœåŠ¡å™¨..."
exec node index.js
EOF

chmod +x start_single.sh
æ­¥éª¤4: å¯åŠ¨å¹¶éªŒè¯ä¿®å¤
bash
# ä½¿ç”¨å•å®ä¾‹è„šæœ¬å¯åŠ¨
./start_single.sh > /tmp/usis_fixed.log 2>&1 &
SERVER_PID=$!

# ç­‰å¾…å¯åŠ¨å®Œæˆ
sleep 15

# éªŒè¯å¯åŠ¨çŠ¶æ€
echo "=== å¯åŠ¨éªŒè¯ ==="
echo "è¿›ç¨‹PID: $SERVER_PID"
ps -p $SERVER_PID > /dev/null && echo "âœ… è¿›ç¨‹è¿è¡Œä¸­" || echo "âŒ è¿›ç¨‹å·²é€€å‡º"

echo "=== ç«¯å£ç›‘å¬ ==="
netstat -tlnp | grep :5000 && echo "âœ… ç«¯å£ç›‘å¬æ­£å¸¸" || echo "âŒ ç«¯å£æœªç›‘å¬"

echo "=== æœåŠ¡å¥åº· ==="
curl -s -m 10 http://localhost:5000/health && echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡" || echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"

echo "=== APIç«¯ç‚¹æµ‹è¯• ==="
timeout 20 curl -X POST http://localhost:5000/brain/orchestrate \
  -H "Content-Type: application/json" \
  -d '{"text":"TSLAæŠ€æœ¯é¢", "user_id":"test"}' && echo "âœ… APIè¯·æ±‚æˆåŠŸ" || echo "âŒ APIè¯·æ±‚å¤±è´¥"

echo "=== æœ€æ–°æ—¥å¿— ==="
tail -10 /tmp/usis_fixed.log
å®Œæˆæ ‡å‡†
âœ… OpenAI APIè°ƒç”¨æœ‰15ç§’è¶…æ—¶ä¿æŠ¤

âœ… å•å®ä¾‹è¿è¡Œï¼Œæ— pollingå†²çª

âœ… æœåŠ¡å™¨ç¨³å®šç›‘å¬ç«¯å£5000

âœ… /brain/orchestrateç«¯ç‚¹æ­£å¸¸å“åº”

âœ… è¿›ç¨‹æŒç»­è¿è¡Œä¸é€€å‡º

è¯·æ‰§è¡Œä»¥ä¸Šä¿®å¤å¹¶è¿”å›éªŒè¯ç»“æœã€‚

è¯·å°†è¿™æ®µå®Œæ•´ä¿®å¤æŒ‡ä»¤è½¬å‘ç»™ReplitGPTï¼Œç­‰å¾…å…¶æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚