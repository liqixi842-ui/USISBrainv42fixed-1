ç»™ Replit AIï¼ˆåŸæ ·ç²˜è´´ï¼‰
ç›®æ ‡ï¼šåœ¨ /brain/orchestrate ä¸­ï¼Œå½“ intent==="heatmap" æ—¶ï¼ŒBrain è‡ªå·±å®Œæˆç½‘é¡µæ“æ§ä¸æˆªå›¾ï¼ˆä¸å†è¿”å›åŠ¨ä½œç»™å¤–éƒ¨å™¨å®˜ï¼‰ã€‚
éœ€æ±‚ï¼š
- æ”¯æŒåœ°åŒº/æŒ‡æ•°è§£æï¼šUSâ†’SPX500ã€JPâ†’NIKKEI225ã€ESâ†’IBEX35ã€DEâ†’DAX40ã€FRâ†’CAC40ã€UKâ†’FTSE100ã€EUâ†’EURO50ã€HKâ†’HSIã€CNâ†’CSI300ã€INâ†’NIFTY50ï¼›US ç‰¹ä¾‹æ”¯æŒ NASDAQ100/DJ30ã€‚
- å¯é€‰è¡Œä¸šèšç„¦ï¼štechnology/financials/...ï¼ˆè‹¥æœªå®ç°è¡Œä¸šç‚¹å‡»ï¼Œä»è¿”å›å…¨å›¾+æ–‡æœ¬æç¤ºï¼‰ã€‚
- å½»åº•é˜²ä¸²å°ï¼šå³ä½¿ TV å¿½ç•¥ dataset å‚æ•°ï¼Œä¹Ÿè¦é€šè¿‡ UI ç‚¹å‡»æŠŠæŒ‡æ•°åˆ‡å›æ­£ç¡®ç›®æ ‡ã€‚
- è¿”å›å­—æ®µï¼š{ ok, intent:"heatmap", index, region, sector?, caption, analysis, debug_report, image_base64 }ã€‚

ä¸€ã€ä¾èµ–
- å¢åŠ ä¾èµ–ï¼šä¼˜å…ˆ Playwrightï¼ˆæ›´ç¨³ï¼‰ï¼š`npm i playwright`ï¼›è‹¥å—é™åˆ™ç”¨ `puppeteer`.
- ç»Ÿä¸€å¯¼å‡ºä¸€ä¸ªå·¥å…·ï¼š`captureTvHeatmap({dataset, label, lang, sector})`.

äºŒã€æ˜ å°„ä¸æ ‡ç­¾
const INDEX_LABEL = {
  SPX500: "S&P 500 Index",
  NASDAQ100: "NASDAQ 100 Index",
  DJ30: "Dow Jones Industrial Average",
  NIKKEI225: "Nikkei 225 Index",
  IBEX35: "IBEX 35 Index",
  DAX40: "DAX 40 Index",
  CAC40: "CAC 40 Index",
  FTSE100: "FTSE 100 Index",
  EURO50: "EURO STOXX 50 Index",
  HSI: "Hang Seng Index",
  CSI300: "CSI 300 Index",
  NIFTY50: "NIFTY 50 Index"
};
const REGION_TO_INDEX = {US:"SPX500", JP:"NIKKEI225", ES:"IBEX35", DE:"DAX40", FR:"CAC40", UK:"FTSE100", EU:"EURO50", HK:"HSI", CN:"CSI300", IN:"NIFTY50"};

ä¸‰ã€è§£æ
æ²¿ç”¨ç°æœ‰ extract_heatmap_query(text)ï¼Œä½†ä¿è¯ï¼š
- ä¸€æ—¦ region è§£æåˆ°ä¸” index æœªæŒ‡å®š â†’ index = REGION_TO_INDEX[region]ã€‚
- â€œè¥¿ç­ç‰™/IBEXâ€å¼ºåˆ¶é”åœ¨æ‰€æœ‰å›é€€ä¹‹å‰æ‰§è¡Œï¼ˆåŒä½ ç°åœ¨çš„ hotfixï¼‰ã€‚
- è¿”å› {region, index, sector?, lang?("es-ES"|"ja-JP"|...)}ã€‚

å››ã€æ ¸å¿ƒå‡½æ•°ï¼ˆä¼ªä»£ç ï¼Œäº¤ç”±ä½ ç”¨ Playwright å®ç°ï¼‰
async function captureTvHeatmap({dataset, label, lang, sector}) {
  // 1) å¯åŠ¨æµè§ˆå™¨
  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext({
    locale: lang ? lang : undefined,
    userAgent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118 Safari/537.36"
  });
  const page = await context.newPage();

  // 2) è®¿é—® URLï¼ˆå¸¦ dataset ä½œä¸ºâ€œåˆå§‹æ„å›¾â€ï¼Œå³ä½¿TVä¸è®¤ä¹Ÿæ— æ‰€è°“ï¼‰
  const url = `https://www.tradingview.com/heatmap/stock/?color=change&dataset=${dataset}&group=sector&blockSize=market_cap&tileColor=change`;
  await page.goto(url, { waitUntil: "networkidle" });

  // 3) ç‚¹å¼€å·¦ä¸Šè§’æŒ‡æ•°é€‰æ‹©å™¨å¹¶å¼ºåˆ¶é€‰æ‹© label
  // é€‰æ‹©å™¨å…œåº•ï¼šæŒ‰é’®æ–‡æœ¬åŒ…å« "Index"|"Ãndice"|"æŒ‡æ•°"ï¼›æˆ– aria-label å« "Index"
  const openBtn = await firstVisible(page, [
    'button[aria-label*="Index"]',
    'button:has-text("Index")',
    'button:has-text("Ãndice")',
    'button:has-text("æŒ‡æ•°")'
  ]);
  if (openBtn) { await openBtn.click(); await page.waitForTimeout(200); }

  // æœç´¢æ¡†
  const searchBox = await firstVisible(page, [
    'input[type="search"]',
    'input[placeholder*="Search"]',
    'input[placeholder*="Buscar"]',
    'input[placeholder*="æœç´¢"]'
  ]);
  if (searchBox) {
    await searchBox.fill(label);
    await page.waitForTimeout(150);
    // é€‰é¦–æ¡ç»“æœ
    const firstItem = await firstVisible(page, ['ul li >> nth=0', '[role="listbox"] [role="option"] >> nth=0']);
    if (firstItem) { await firstItem.click(); }
  }

  // ç­‰å¾…æŒ‰é’®æ–‡æœ¬æ›´æ–°ä¸ºç›®æ ‡ labelï¼ˆæˆ–å›¾å½¢åŒºåŸŸåˆ·æ–°ï¼‰
  await page.waitForFunction(
    (text) => {
      const btns = Array.from(document.querySelectorAll('button'));
      return btns.some(b => (b.textContent||"").includes(text));
    },
    label,
    { timeout: 4000 }
  ).catch(()=>{});

  // 4) å¯é€‰ï¼šè¡Œä¸šèšç„¦ï¼ˆè‹¥ sector å­˜åœ¨ï¼Œå°½åŠ›ç‚¹å‡» Sector ä¸‹æ‹‰å¹¶é€‰æ‹©ï¼‰
  if (sector && sector !== "AUTO") {
    const sectorBtn = await firstVisible(page, [
      'button:has-text("Sector")',
      'button:has-text("è¡Œä¸š")',
      'button:has-text("Sector")'
    ]);
    if (sectorBtn) {
      await sectorBtn.click();
      await page.waitForTimeout(150);
      // åœ¨é¢æ¿ä¸­ç‚¹å‡»å¯¹åº”é¡¹ï¼ˆè‹±æ–‡é”®å€¼ï¼‰
      const map = {
        technology: ["Technology","TecnologÃ­a","ç§‘æŠ€"],
        financials: ["Financials","Financieros","é‡‘è"],
        healthcare: ["Health","Salud","åŒ»ç–—"],
        industrials: ["Industrial","Industriales","å·¥ä¸š"],
        energy: ["Energy","EnergÃ­a","èƒ½æº"],
        materials: ["Materials","Materiales","ææ–™"],
        consumer_discretionary: ["Consumer Discretionary","Consumo discrecional","å¯é€‰æ¶ˆè´¹"],
        consumer_staples: ["Consumer Staples","Consumo bÃ¡sico","å¿…éœ€æ¶ˆè´¹"],
        communication_services: ["Communication","Comunicaciones","é€šä¿¡"],
        utilities: ["Utilities","Servicios pÃºblicos","å…¬ç”¨äº‹ä¸š"],
        real_estate: ["Real Estate","Inmobiliario","æˆ¿åœ°äº§"]
      };
      const aliases = map[sector] || [];
      const target = await firstVisible(page, aliases.map(t => `text="${t}"`));
      if (target) { await target.click(); }
    }
  }

  // 5) ç­‰å¾…çƒ­åŠ›å›¾ç¨³å®š
  await page.waitForTimeout(900);

  // 6) æˆªå›¾ï¼ˆå…¨é¡µæˆ–ä¸»è¦åŒºåŸŸï¼‰
  const img = await page.screenshot({ type: "jpeg", quality: 85, fullPage: true });
  // 7) é‡‡é›†å¯è§çš„æŒ‡æ•°æŒ‰é’®æ–‡æœ¬ç”¨äºæ ¡éªŒ
  const visualIndex = await page.evaluate(() => {
    const btns = Array.from(document.querySelectorAll('button'));
    const b = btns.find(b => /Index|Ãndice|æŒ‡æ•°/.test(b.textContent||""));
    return b ? b.textContent.trim() : "";
  });

  await browser.close();
  return { image_base64: img.toString('base64'), visual_index_label: visualIndex };
}

// å·¥å…·ï¼šç¬¬ä¸€ä¸ªå­˜åœ¨ä¸”å¯è§çš„å…ƒç´ 
async function firstVisible(page, selectors) {
  for (const sel of selectors) {
    const el = await page.$(sel);
    if (el && await el.isVisible?.()) return el;
  }
  return null;
}

äº”ã€åœ¨ orchestrate çš„ heatmap åˆ†æ”¯é‡Œï¼š
- è§£æ {region,index,sector,lang} â†’ const label = INDEX_LABEL[index];
- è°ƒç”¨ const shot = await captureTvHeatmap({dataset:index, label, lang, sector});
- æ„é€ è¿”å›ï¼š
  {
    ok: true,
    intent: "heatmap",
    region, index, sector: sector || "AUTO",
    caption: `ğŸ“Š ${index} æ¿å—çƒ­åŠ›å›¾ï¼ˆTradingViewï¼‰` + (sector && sector!=="AUTO" ? ` Â·èšç„¦ï¼š${sector}` : ""),
    analysis: "<æŒ‰ä½ ç°æœ‰æ¨¡æ¿ç”Ÿæˆ 3-5 å¥çŸ­è¯„>",
    image_base64: shot.image_base64,
    debug_report: {
      url_used: url,
      expected_label: label,
      visual_index_label: shot.visual_index_label
    }
  }

å…­ã€è¶…æ—¶ä¸é‡è¯•
- capture è¶…æ—¶è®¾ 12sï¼›è‹¥å¤±è´¥ï¼ˆæˆ– visual_index ä¸ label ä¸ç¬¦ï¼‰â†’ é‡è¯•ä¸€æ¬¡ï¼šé‡æ–°æ‰“å¼€é¡µé¢å†ç‚¹å‡»ä¸€æ¬¡ã€‚
- ä¸¤æ¬¡å¤±è´¥åˆ™è¿”å›é”™è¯¯æè¿°ï¼Œä½†ç»ä¸å›é€€åˆ° SPX500 æˆªå›¾ã€‚

ä¸ƒã€æµ‹è¯•
- "æ—¥æœ¬å¤§ç›˜çƒ­åŠ›å›¾ #dbg" â†’ index=NIKKEI225ï¼Œdebug_report.visual_index_label åŒ…å« "Nikkei 225 Index"ã€‚
- "è¥¿ç­ç‰™çƒ­åŠ›å›¾ #dbg" â†’ IBEX35ã€‚
- "ç¾è‚¡çš„ç§‘æŠ€è‚¡çš„çƒ­åŠ›å›¾ #dbg" â†’ SPX500 + sector=technologyï¼ˆè‹¥è¡Œä¸šç‚¹å‡»å¤±è´¥ï¼Œä»è¿”å›å…¨å›¾å¹¶åœ¨ analysis è¯´æ˜â€œæœªèƒ½è‡ªåŠ¨èšç„¦è¡Œä¸šï¼Œå·²è¿”å›å…¨