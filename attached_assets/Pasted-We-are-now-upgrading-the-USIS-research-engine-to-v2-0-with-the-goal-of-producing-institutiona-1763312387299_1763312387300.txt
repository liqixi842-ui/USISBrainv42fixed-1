We are now upgrading the USIS research engine to **v2.0**, with the goal of producing **institutional-grade equity / index / ETF research reports**, comparable to Morgan Stanley / Goldman Sachs / J.P. Morgan-level professional reports.

The current v1 engine works, but is still template-level.  
v2.0 must introduce deep data, valuation models, financial forecasting, peer comparison, and multi-page PDF layout.

Below is the full implementation spec.

──────────────────────────────
0) GOAL
──────────────────────────────

Transform /v3/report into a **professional research engine**:

- Deep financial data (5-year history + 2-year forecast)
- Full valuation framework (PE / PS / EV/EBITDA / DCF-lite)
- Peer comparison table
- Segment analysis (for equities)
- Macro/industry trends (for indices/ETFs)
- Operating metrics
- Price targets based on valuation multiples (not %)
- Multi-page professional PDF layout
- Charts (price chart, moving averages, financial charts)
- Complete AI narrative based on real data

All symbols must follow the same engine logic.

──────────────────────────────
1) RESEARCHREPORT SCHEMA v2.0
──────────────────────────────

Upgrade the v1 schema to include the following new fields:

{
  symbol, name, asset_type, rating, horizon,

  price: {
    last, change_abs, change_pct,
    high_1d, low_1d,
    high_52w, low_52w,
    ytd_return_pct,
    beta,
    volume, avg_volume_3m
  },

  valuation: {
    market_cap,
    pe_ttm, pe_forward,
    ps_ttm,
    pb,
    ev_ebitda,
    peg_ratio,
    dividend_yield,
    historical_pe_5y: { high, median, low },
    historical_ps_5y: { high, median, low }
  },

  fundamentals: {
    revenue_5y: [...],      // array of 5 years revenue
    eps_5y: [...],          // 5 years EPS
    revenue_forecast_2y: [...],
    eps_forecast_2y: [...],
    gross_margin, operating_margin, net_margin,
    roe, roa, fcf_margin
  },

  segments: [
    { name, revenue, growth_yoy, margin }
  ],

  peers: [
    { symbol, name, price, pe_forward, ps_ttm, market_cap, rating_consensus }
  ],

  macros: {
    industry_growth,
    regulatory_factors,
    sector_performance_ytd
  },

  techs: {
    rsi_14, macd, ema_20, ema_50, ema_200,
    support_levels, resistance_levels
  },

  targets: {
    base: { price, upside_pct, horizon },
    bull: { price, upside_pct },
    bear: { price, downside_pct },
    methodology: "Forward EPS x PE multiple"
  },

  // AI-generated text
  summary_text,
  thesis_text,
  valuation_text,
  segment_text,
  macro_text,
  catalysts_text,
  risks_text,
  tech_view_text,
  action_text,

  meta: { generated_at, model, version }
}

──────────────────────────────
2) DATA REQUIREMENTS
──────────────────────────────

All new fields must use REAL DATA from Finnhub/Twelve Data or fallback APIs:
❗ No placeholders allowed.

You may:

- Use Finnhub "metric" & "financials" endpoints for 5-year data & forecasts
- Use Twelve Data / AlphaVantage for beta, volatility, historical prices
- Use marketstack or yahoo-finance2 if needed

Missing data → use null, NOT synthetic numbers.

──────────────────────────────
3) VALUATION MODEL (REAL)
──────────────────────────────

Replace the simple +15/+35/-15 model with a true valuation model:

Let:

EPS_fwd = next-year EPS forecast  
PE_target = historical_pe_5y.median * 1.05  // example premium  
Bear_PE = historical_pe_5y.low  
Bull_PE = historical_pe_5y.high

Then:

base.price = EPS_fwd * PE_target  
bull.price = EPS_fwd * Bull_PE  
bear.price = EPS_fwd * Bear_PE  

Calculate upside/downside relative to price.last.

Store in:

report.targets.base  
report.targets.bull  
report.targets.bear  

──────────────────────────────
4) PEER COMPARISON (REQUIRED)
──────────────────────────────

For equities, add a peer table:

Example for NVDA:

AMD, AVGO, AAPL, MSFT, META

Fields:

- symbol  
- price  
- market_cap  
- pe_forward  
- ps_ttm  
- eps_cagr_3y  
- rating_consensus (Finnhub provides this)

──────────────────────────────
5) AI TEXT GENERATION (INSTITUTIONAL STYLE)
──────────────────────────────

Upgrade all AI prompts:

- All text must be **symbol-specific**  
- Use the actual numeric values  
- Avoid generic “AI demand growing” empty phrases  
- Include business segments  
- Include competition  
- Use valuation model numbers  
- Use forecast numbers  

Prompts must explicitly include the full ResearchReport JSON so that the AI grounds its writing on the data.

──────────────────────────────
6) PROFESSIONAL PDF TEMPLATE (MULTI-PAGE)
──────────────────────────────

Upgrade HTML → PDF template:

PAGE 1 – Cover  
- Title  
- Rating badge  
- Base target & upside  
- Key stats (price, PE, PB, market cap, beta, vol)  
- 1-paragraph summary box  

PAGE 2 – Investment Thesis  
- thesis_text  
- segment_text  

PAGE 3 – Valuation  
- valuation table (real data)  
- peer comparison table  
- valuation_text  

PAGE 4 – Financials  
- 5-year revenue chart  
- 5-year EPS chart  
- forecast revenue/EPS table  
(Charts generated via QuickChart or similar)

PAGE 5 – Price Targets  
- base/bull/bear results  
- assumptions & methodology  

PAGE 6 – Catalysts & Risks  
- catalysts_text  
- risks_text  

PAGE 7 – Technicals  
- technical indicators  
- support/resistance  
- annotated chart (via QuickChart)  
- tech_view_text  

PAGE 8 – Action & Disclaimer  
- action_text  
- meta info  
- standard disclaimer  

All pages must read from the report JSON.  
No NVDA-specific strings.

──────────────────────────────
7) UNIVERSAL SUPPORT (ANY SYMBOL)
──────────────────────────────

After implementing v2.0, test:

/v3/report/NVDA?format=pdf  
/v3/report/AAPL?format=pdf  
/v3/report/MSFT?format=pdf  
/v3/report/TSLA?format=pdf  
/v3/report/SPX?format=pdf  
/v3/report/QQQ?format=pdf  

All must generate professional multi-page PDFs with:

- Real data  
- Professional text  
- Charts  
- Valuation model  
- Real price targets  

──────────────────────────────
8) VERIFICATION OUTPUT
──────────────────────────────

After implementation, please send back:

1. Full JSON output for NVDA (v2.0 schema)  
2. PDF for NVDA (v2.0 multi-page)  
3. PDF for AAPL (v2.0)  
4. Logs showing all API data retrieval  
5. Confirmation that no placeholder numeric values remain

This completes USIS Research Engine v2.0 institutional upgrade specifications.
