æˆ‘ä»¬ç°åœ¨ä¸“é—¨è§£å†³ä¸€ä¸ªç‚¹ï¼šGPT-4o Master Consolidation å¡æ­»å¯¼è‡´ /v3/report è¶…æ—¶/500 çš„é—®é¢˜ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹ï¼Œä¸è¦åŠ¨å…¶å®ƒéƒ¨åˆ†ï¼š

ã€1ã€‘å®šä½ Master Consolidation ä»£ç 

åœ¨ v3_dev/services è·¯å¾„ä¸‹ï¼Œç”¨ rg æœç´¢ï¼š

  rg "Master Consolidation" -n

æ‰¾åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼ˆç¤ºä¾‹ï¼‰ï¼š

  console.log('ğŸ¤– [v3.2] GPT-4o Master Consolidation...');
  const masterText = await callOpenAI(masterPrompt, 'gpt-4o'); // æˆ–ç±»ä¼¼åå­—

ã€2ã€‘å°è£…ä¸€ä¸ªå¸¦è¶…æ—¶çš„ Promise

åœ¨åŒä¸€ä¸ªæ–‡ä»¶é¡¶éƒ¨æˆ–è€… util åŒºåŸŸæ–°å¢ï¼š

  function withTimeout(promise, label = 'task', ms = 25000) {
    return Promise.race([
      promise,
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error(`${label} timeout after ${ms}ms`)), ms)
      )
    ]);
  }

ã€3ã€‘ä¿®æ”¹ Master Consolidation è°ƒç”¨ï¼Œå¼ºåˆ¶å¸¦è¶…æ—¶ + é™çº§ï¼Œä¸å†ç›´æ¥ await GPT-4o

æŠŠåŸæ¥çš„ï¼š

  const masterText = await callOpenAI(masterPrompt, 'gpt-4o');

æ”¹æˆç±»ä¼¼ï¼š

  let masterText;
  console.log('ğŸ¤– [v5.0] GPT-4o Master Consolidation...');
  try {
    masterText = await withTimeout(
      callOpenAI(masterPrompt, 'gpt-4o'),
      'GPT-4o Master Consolidation',
      25000   // æœ€å¤šç­‰ 25 ç§’
    );
    console.log('âœ… [v5.0] GPT-4o Master Consolidation OK');
  } catch (err) {
    console.error('âš ï¸ [v5.0] Master Consolidation fallback:', err.message);

    // ç”¨å·²å®Œæˆçš„å­æ¨¡å‹ç»“æœæ‹¼æ¥ä¸€ä¸ªç®€åŒ–ç‰ˆæ€»è®ºç‚¹ï¼Œé¿å…æ•´æ¡é“¾è·¯å¤±è´¥
    const parts = [];
    if (report.thesis_text) parts.push(report.thesis_text);
    if (report.overview_raw) parts.push(report.overview_raw);
    if (report.valuation_raw) parts.push(report.valuation_raw);
    if (report.industry_raw) parts.push(report.industry_raw);
    if (report.macro_raw) parts.push(report.macro_raw);

    masterText = parts.filter(Boolean).join('\n\n');

    if (!masterText || masterText.trim().length < 200) {
      masterText = 'Our view: NVIDIA offers a solid risk-reward profile driven by AI and data center growth, offset by competition, supply chain and regulatory risks. Despite model limitations, the directional conclusion of a constructive stance over the next 6â€“12 months remains intact.';
    }
  }

  // ç¡®ä¿ masterText ä¸€å®šæœ‰å€¼
  report.investment_thesis = masterText;
  report.thesis_text = masterText;

ã€4ã€‘éªŒè¯ï¼ˆå¿…é¡»ç»™å‡ºæ—¶é—´å’Œç»“æœï¼‰

åœ¨æœ¬åœ°è¿è¡Œï¼š

  node -e "const { buildResearchReportV5 } = require('./v3_dev/services/reportService'); (async () => { const t0 = Date.now(); const r = await buildResearchReportV5('NVDA', 'equity'); console.log('DONE in', Date.now() - t0, 'ms'); console.log('Thesis length:', (r.investment_thesis || '').length); })();"

æœŸæœ›ç»“æœï¼š
- æ§åˆ¶å°æ‰“å° "DONE in XXXX ms"ï¼Œä¸” XXXX < 30000
- Thesis length å¤§äº 800ï¼ˆè¯´æ˜æœ‰é•¿æ–‡ï¼‰
- å³ä½¿ GPT-4o ä¸å¯ç”¨ï¼Œä¹Ÿä¸ä¼šå¡æ­»ï¼ˆä¼šèµ° fallbackï¼‰

ç„¶åå†æ‰§è¡Œï¼š

  curl -s "http://localhost:3000/v3/report/NVDA?format=json" | head -c 400

ç¡®è®¤èƒ½åœ¨ 30 ç§’å†…è¿”å› JSONï¼Œä¸”åŒ…å«å®Œæ•´çš„ investment_thesis å†…å®¹ã€‚

å®Œæˆååªéœ€å›å¤ç±»ä¼¼ï¼š

"Master Consolidation timeout+fallback ç”Ÿæ•ˆï¼ŒbuildResearchReportV5('NVDA') ç”¨æ—¶ XXXXmsï¼Œ/v3/report/NVDA?format=json æ­£å¸¸è¿”å›ã€‚"
