å‘ç»™ Replit AI çš„æŒ‡ä»¤ï¼ˆç²˜è´´å³å¯ï¼‰

ä»»åŠ¡ï¼šåœ¨ v4.5ï¼ˆçº¯ SaaSï¼‰ä¸Šä¸º Telegram è½®è¯¢é›†æˆåŠ â€œé˜²å´©æºƒâ€ä¸â€œå•ä¾‹é˜²é‡å¯é£æš´â€ã€‚ä¸æ”¹ Screenshot æ ¸å¿ƒé€»è¾‘ã€‚
ç›®æ ‡ï¼šè¿›ç¨‹ä¸å†æ— æ—¥å¿—å´©æºƒï¼›æ‰€æœ‰å¼‚å¸¸å…¨éƒ¨è¢«æ•è·å¹¶æ‰“å°ï¼›å…³é—­æ—¶ä¼˜é›…é€€å‡ºã€‚

ä¿®æ”¹ç‚¹ï¼ˆæœ€å°é›†ï¼‰

åœ¨ index.jsï¼ˆæˆ–å…¥å£æ–‡ä»¶ï¼‰é¡¶å±‚åŠ å…¥å…¨å±€å…œåº•ï¼š

process.on('uncaughtException', (err) => {
  console.error('[FATAL] uncaughtException:', err?.stack || err);
});
process.on('unhandledRejection', (reason) => {
  console.error('[FATAL] unhandledRejection:', reason);
});


æ–°å»º/ä¿®æ”¹ telegram.jsï¼šä½¿ç”¨ Telegraf è½®è¯¢ + å•ä¾‹å®ˆæŠ¤ + é”™è¯¯æ•è·

import { Telegraf } from 'telegraf';

let botInstance = null;
export function startTelegramBot({ orchestrateUrl }) {
  if (botInstance) {
    console.log('[TG] bot already running, skip duplicate launch');
    return botInstance;
  }
  const token = process.env.TELEGRAM_BOT_TOKEN;
  if (!token) {
    console.warn('[TG] TELEGRAM_BOT_TOKEN missing, skip bot start');
    return null;
  }
  const bot = new Telegraf(token, {
    handlerTimeout: 25_000 // é¿å…é•¿ handler é˜»å¡
  });

  // ç»Ÿä¸€é”™è¯¯æ•è·
  bot.catch((err, ctx) => {
    console.error('[TG] bot.catch error:', err);
    try { ctx?.reply?.('âš ï¸ ç³»ç»Ÿç¹å¿™ï¼Œç¨åé‡è¯•'); } catch {}
  });

  // æ–‡æœ¬å¤„ç†ï¼šè½¬å‘åˆ° orchestrateï¼ˆä½¿ç”¨ä½ ç°æœ‰ HTTP å®¢æˆ·ç«¯ï¼‰
  bot.on('text', async (ctx) => {
    try {
      const text = ctx.message.text || '';
      const body = { text, user_id: `tg_${ctx.from?.id || 'na'}` };
      const res = await fetch(orchestrateUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        // 28s æ€»è¶…æ—¶ï¼šæœåŠ¡å™¨ç«¯è‹¥æ›´ä¹…åº”å…ˆè¿”å›æ–‡å­—ã€å›¾ç•™ç»™åç»­
        signal: AbortSignal.timeout(28_000)
      });
      const data = await res.json().catch(() => ({}));
      const caption = data?.text || 'å®Œæˆï¼Œä½†æ— æ­£æ–‡è¿”å›';
      const image = data?.image_url;
      if (image) {
        await ctx.replyWithPhoto(image, { caption: caption.slice(0, 900) });
      } else {
        await ctx.reply(caption);
      }
    } catch (e) {
      console.error('[TG] handler error:', e);
      await ctx.reply('ğŸ›¡ï¸ å®‰å…¨æ¨¡å¼ï¼šæˆ‘å·²è·³è¿‡å›¾ç‰‡å¹¶ä¿ä½è¿›ç¨‹ï¼Œè¯·ç¨åé‡è¯•');
    }
  });

  // ä»…å¯ç”¨è½®è¯¢ï¼ˆå…³é—­ webhookï¼‰ï¼Œé˜²æ­¢æ¨¡å¼å†²çª
  bot.launch({ dropPendingUpdates: true }).then(() => {
    console.log('[TG] bot launched (polling)');
  }).catch((e) => {
    console.error('[TG] launch failed:', e);
  });

  // ä¼˜é›…é€€å‡º
  const stop = async () => {
    try { await bot.stop('SIGTERM'); } catch {}
    console.log('[TG] bot stopped');
  };
  process.once('SIGINT',  stop);
  process.once('SIGTERM', stop);

  botInstance = bot;
  return bot;
}


åœ¨ index.js é‡Œå¼•ç”¨ï¼Œå¹¶ç¡®ä¿åªè°ƒç”¨ä¸€æ¬¡ï¼š

import { startTelegramBot } from './telegram.js';
// ä½ çš„ HTTP è·¯ç”±ä¸ /brain/orchestrate ä¿æŒåŸçŠ¶
startTelegramBot({ orchestrateUrl: process.env.ORCH_URL || 'https://<ä½ çš„åŸŸå>/brain/orchestrate' });
console.log('[BOOT] service ready');


è‹¥é¡¹ç›®æ›¾ç»è®¾ç½®è¿‡ Webhookï¼šåˆ é™¤æˆ–ç¦ç”¨ Webhookï¼Œä»…ä½¿ç”¨è½®è¯¢ã€‚

åŠ å…¥å­˜æ´»æ—¥å¿—ï¼ˆå¯é€‰ï¼‰ï¼š

setInterval(() => console.log('[HEARTBEAT]', Date.now()), 60_000);


éªŒè¯

å¯åŠ¨åæ—¥å¿—åº”çœ‹åˆ°ï¼š[TG] bot launched (polling) ä¸ [BOOT] service readyã€‚

æ‰‹åŠ¨ç»™ Bot å‘æ¶ˆæ¯ï¼šæ— è®ºæˆåŠŸ/å¤±è´¥ï¼Œè¿›ç¨‹ä¸åº”é€€å‡ºï¼›é”™è¯¯éœ€æ‰“å°åˆ°æ§åˆ¶å°ä¸”ç”¨æˆ·æ”¶åˆ°æç¤ºã€‚

Ctrl+C æˆ– Replit åœæ­¢æ—¶ï¼Œçœ‹åˆ° [TG] bot stoppedã€‚

æ³¨æ„

ä¿æŒ Screenshot 60s å†…éƒ¨è¶…æ—¶æ²¡é—®é¢˜ï¼›å¯¹å¤– Telegram handler ä»æ‰§è¡Œ 28s æ€»æ§ï¼Œè¶…æ—¶å³è¿”å›æ–‡å­—ã€‚

ä¸ä¿®æ”¹ screenshotProviders.jsã€runner.js çš„æ ¸å¿ƒé€»è¾‘ã€‚

åŒæ­¥ç»™ä½ ä¸€æ¡â€œå³åˆ»å¯æµ‹â€çš„ HTTP ç”¨ä¾‹ï¼ˆé€‰ B ä¹Ÿè¡Œï¼‰
curl -s -X POST "$ORCH_URL" \
 -H "Content-Type: application/json" \
 -d '{"text":"ç»™æˆ‘S&P500ç›˜å‰ç®€æŠ¥ï¼Œè‹¥æˆªå›¾è¶…æ—¶å°±åªè¿”æ–‡å­—","user_id":"qa"}'


æœŸæœ›ï¼šJSON é‡Œ ok:trueï¼›æœ‰ image_url å°±å›¾+æ–‡ï¼Œæ²¡æœ‰å°±æ–‡ï¼›æ—  500ã€æ— å´©æºƒã€‚