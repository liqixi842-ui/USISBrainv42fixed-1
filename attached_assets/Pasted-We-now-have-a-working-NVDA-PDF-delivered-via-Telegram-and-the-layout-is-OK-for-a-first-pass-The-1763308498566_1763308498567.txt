We now have a working NVDA PDF delivered via Telegram, and the layout is OK for a first pass.  
The next step is to evolve this into a **generic, Morgan-level research report engine** that works for *any* symbol or index, not just NVDA.

Please do the following refactor for v3-dev:

────────────────────────
1) Introduce a generic ResearchReport JSON schema (v1)
────────────────────────

In v3_dev/services/reportService.js, create a single function that builds a structured report object for any symbol:

async function buildResearchReport(symbol, assetType = "equity")

The return value should be a JSON object with this shape (v1 schema):

{
  symbol: "NVDA",
  name: "NVIDIA Corporation",
  asset_type: "equity",   // "equity" | "index" | "etf" | "crypto" etc.
  rating: "BUY",          // BUY / HOLD / SELL / OW / UW
  horizon: "3-12M",

  price: {
    last: number | null,
    change_abs: number | null,
    change_pct: number | null,
    high_1d: number | null,
    low_1d: number | null,
    high_52w: number | null,
    low_52w: number | null,
    ytd_return_pct: number | null,
    currency: string | null
  },

  valuation: {
    market_cap: number | null,
    pe_ttm: number | null,
    pe_forward: number | null,
    ps_ttm: number | null,
    pb: number | null,
    dividend_yield: number | null,
    ev_ebitda: number | null
  },

  growth: {
    revenue_cagr_3y: number | null,
    eps_cagr_3y: number | null,
    revenue_yoy_latest: number | null,
    eps_yoy_latest: number | null
  },

  fundamentals: {
    gross_margin: number | null,
    operating_margin: number | null,
    net_margin: number | null,
    roe: number | null,
    roa: number | null,
    fcf_margin: number | null
  },

  peer_comparison: [
    {
      symbol: string,
      name: string,
      market_cap: number | null,
      pe_forward: number | null,
      ps_ttm: number | null,
      eps_cagr_3y: number | null,
      rating_consensus: string | null   // e.g. "BUY", "HOLD"
    }
    // optional peers
  ],

  techs: {
    rsi_14: number | null,
    macd: number | null,
    ema_20: number | null,
    ema_50: number | null,
    ema_200: number | null,
    support_levels: number[] | null,
    resistance_levels: number[] | null
  },

  targets: {
    base: { price: number | null, upside_pct: number | null, horizon: string | null },
    bull: { price: number | null, upside_pct: number | null },
    bear: { price: number | null, downside_pct: number | null }
  },

  // Long-form text sections (generated by AI based on above fields)
  summary_text: string,
  thesis_text: string,
  valuation_text: string,
  catalysts_text: string,
  risks_text: string,
  tech_view_text: string,
  action_text: string,

  meta: {
    generated_at: string,     // ISO timestamp
    model: string,            // e.g. "gpt-4o-mini"
    version: "v3-dev"
  }
}

Implementation notes:

- Use existing data sources (Finnhub, Twelve Data, etc.) to populate the numeric fields where possible. If a field is not available, set it to null.
- Use AI (gpt-4o-mini, DeepSeek etc.) to generate the long-form texts based on this JSON object.
- The function **must be generic**: it should work for NVDA, AAPL, TSLA, SPX, QQQ, etc. Asset-type specific differences can be handled later by branching on assetType.

────────────────────────
2) Refactor HTML generator to consume ResearchReport v1
────────────────────────

Update the HTML template generator (currently used for NVDA) so that it takes the new ResearchReport object as input instead of ad-hoc fields.

Something like:

function buildHtmlFromReport(report) { ... }

The HTML should follow this structure for ANY symbol:

- Cover:
  - USIS 研究报告 / USIS Research Report
  - {symbol} – {name}
  - Rating badge (BUY/HOLD/SELL)
  - Horizon, last price, daily change line

- Section 1: Investment Summary
  - Use report.summary_text

- Section 2: Key Investment Thesis
  - Use report.thesis_text

- Section 3: Valuation & Financials
  - Use report.price, report.valuation, report.growth, report.fundamentals to build summary tables

- Section 4: Catalysts
  - Use report.catalysts_text

- Section 5: Key Risks
  - Use report.risks_text

- Section 6: Technical View
  - Use report.techs + report.tech_view_text

- Section 7: Action
  - Use report.action_text

- Footer: Generated time, model, version, standard disclaimer.

Keep the current clean layout (green BUY button, blue summary box, clean tables) but make sure **all labels and values are driven by the report JSON**, not hardcoded to NVDA.

────────────────────────
3) Make the pipeline generic in /v3/report routes
────────────────────────

In v3_dev/routes/report.js:

- For /v3/report/:symbol?format=html|pdf|json:

  1. Call buildResearchReport(symbol) to get the generic report object.
  2. For format=json → return this JSON.
  3. For format=html → call buildHtmlFromReport(report) and return the HTML.
  4. For format=pdf → use the existing DocRaptor pipeline on the HTML.

This way, NVDA is just one symbol; later we can call:

- /v3/report/AAPL?format=pdf
- /v3/report/SPX?format=pdf
- /v3/report/QQQ?format=pdf

and all of them will use the same layout and schema.

────────────────────────
4) Dev bot /report should also be generic
────────────────────────

In v3_dev/services/devBotHandler.js:

- When user sends `/report SYMBOL`:
  - Call the same buildResearchReport(symbol)
  - If DocRaptor PDF is successful, send PDF.
  - If PDF fails, send a Markdown/text version built from the same report JSON (summary + thesis + valuation + catalysts + risks + action).

No NVDA-specific code should remain in dev bot handlers.

────────────────────────
5) After refactor, run tests with at least 2 different symbols
────────────────────────

Please test in dev environment:

1. `/report NVDA`
2. `/report AAPL` (or another large-cap)
3. (optional) `/report SPX` if assetType "index" is already wired

For each, verify:

- JSON endpoint: /v3/report/SYMBOL?format=json
- HTML endpoint: /v3/report/SYMBOL?format=html
- PDF endpoint: /v3/report/SYMBOL?format=pdf
- Telegram dev bot: `/report SYMBOL` returns a PDF (or fallback text if PDF fails)

Then send me:

- The JSON for one symbol (NVDA)
- The HTML or PDF for two symbols (NVDA + AAPL or SPX)
- Any key logs about errors or missing data
