ã€Send this whole block to Replit exactly as-isã€‘
ğŸ¯ FINAL INSTITUTIONAL TEMPLATE v1.0 â€“ ONE-TIME IMPLEMENTATION

We now have a working v3.2 multi-model research engine and a rich ResearchReport JSON.  
The remaining work is to build a **fixed, professional, Morgan-style PDF template** and wire it to v3.2.

This is a **one-time, final template**. After this, we do NOT want to keep changing the layout.  
All future changes should only adjust content, not the structure.

Please do ONLY what is described below.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0) HIGH-LEVEL REQUIREMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Implement a **single, fixed, institutional-quality HTML template** (Final Template v1.0) for all equity/index reports.
2. The template should produce a **clean, balanced 20â€“24 page PDF**:
   - No pure blank pages.
   - No large empty areas.
   - No duplicated content across pages.
3. The template must be **layout-stable**:
   - Same number and order of pages every time.
   - Same section order, same CSS, same page-break pattern.
   - Each section has a fixed place; content is slotted in.
4. Use the **existing v3.2 ResearchReport JSON** as the data source.
5. Do NOT change the v3.2 multi-model pipeline logic.
   - Only replace the HTML template & wiring.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) DEFINE FINAL TEMPLATE FUNCTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1.1 Create a new function in `v3_dev/services/reportService.js`:

```js
function buildFinalInstitutionalHtml(report) {
  // returns a single HTML string for the entire report
}

1.2 This function must:


Take the full v3.2 ResearchReport object (including all text sections & data).


Produce a single HTML document representing the entire report.


Use a fixed structure as described in section 2.


Use minimal, controlled page-break-before so there are NO stray blank pages.


Use the existing CSS theme as a base (or refine it), but keep it consistent.


1.3 After implementing buildFinalInstitutionalHtml, update:


buildHtmlFromReport(report) to simply call and return buildFinalInstitutionalHtml(report):
function buildHtmlFromReport(report) {
  return buildFinalInstitutionalHtml(report);
}



This ensures all PDF generation and HTML routes use the final template.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2) FIXED TEMPLATE STRUCTURE (NO MORE LAYOUT CHANGES)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Implement the HTML layout as a fixed sequence of pages. Below is the target structure.
You can approximate exact margins / fonts, but the structure and content slots must match.
Each "PAGE" below must correspond to exactly one printed page. Use CSS page-break-after: always; at the end of each page container.
Use a wrapper like:
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
    .page { width: 100%; height: 100vh; box-sizing: border-box; padding: 40px 50px; position: relative; }
    .page { page-break-after: always; }
    /* define standard fonts, colors, headings, tables, etc. */
    h1, h2, h3 { margin: 0 0 12px 0; font-weight: 600; }
    p { margin: 4px 0 8px 0; line-height: 1.4; font-size: 11pt; }
    .section-title { font-size: 16pt; border-bottom: 1px solid #ddd; margin-bottom: 10px; padding-bottom: 4px; font-weight: 600; }
    .small { font-size: 9pt; color: #777; }
    .kpi-row { display: flex; gap: 16px; margin-top: 12px; }
    .kpi-box { flex: 1; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px 10px; }
    .footer { position: absolute; bottom: 20px; left: 50px; right: 50px; font-size: 8pt; color: #999; border-top: 1px solid #eee; padding-top: 5px; display: flex; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 8px; }
    th, td { border: 1px solid #e0e0e0; padding: 4px 6px; text-align: left; }
    th { background: #f5f5f5; font-weight: 600; }
    .tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 9pt; font-weight: 600; }
    .tag-buy { background: #007b5e; color: #fff; }
    .tag-hold { background: #f0a500; color: #fff; }
    .tag-sell { background: #c0392b; color: #fff; }
    /* etcâ€¦ */
  </style>
</head>
<body>
  <!-- pages inserted here -->
</body>
</html>

2.1 PAGE 1 â€“ COVER


Large title: USIS Research Report


Subtitle: {report.symbol} â€“ {report.name}


Tag showing report.rating (BUY / HOLD / SELL) as a colored pill.


Show:


Latest Price: report.price.last and Change (abs & %)


Target Price (Base) and Upside % from report.targets.base


Horizon from report.horizon


Market Cap (or â€œN/Aâ€ if null)




At bottom: Generated: {report.meta.generated_at}, Model: {report.meta.model}, Version: {report.meta.version}.


No huge empty hero area. Use a clean, balanced cover similar to Morgan: about 1/3 top for title, 2â€“3 lines of key stats, and a thin footer.


No content from other pages here (no duplication of what will appear on Page 2).


2.2 PAGE 2 â€“ KEY TAKEAWAYS


Title: Key Takeaways (section-title).


Left column: Key Messages â€“ 4â€“5 bullets from report.summary_text (split into bullet points if needed).


Right column: Key Risks â€“ 4â€“5 bullets from report.risks_text.


Below: a compact KPI row showing:


PE (TTM), PE (Fwd), P/S, Beta, 52W High/Low.




Use a two-column layout with display: flex; gap: 24px;.


Fill the whole page with text + small tables so there is no large empty block.


2.3 PAGE 3 â€“ INVESTMENT THESIS


Title: Investment Thesis.


Use report.thesis_text broken into 3â€“4 paragraphs.


Underneath, add a small 2-column table labeled Our View vs Consensus:


Left: Our EPS growth, ROE, rating summary


Right: Consensus rating, consensus target (if not in data, just say â€œN/Aâ€).




2.4 PAGE 4 â€“ COMPANY & SEGMENTS OVERVIEW


Title: Company & Segment Overview.


Upper half: 2â€“3 paragraphs summarizing the business model using report.thesis_text and report.segments array.


Lower half: Business Segment Breakdown table:


Columns: Segment, Revenue %, Growth, Margin, Comment.


Use report.segments if available; if empty, use standard approximations from current HTML (e.g. Data Center ~60%, Gaming ~25%, etc.), but the structure must always be filled (no missing rows).




2.5 PAGE 5 â€“ INDUSTRY & MACRO


Title: Industry & Macro Environment.


Two columns:


Left: Industry Trends â€“ use report.catalysts_text filtered for industry-level items + AI from report.macro_text.


Right: Macro Factors â€“ inflation, rates, policy from report.macro_text.




Fill the page with text (paragraphs + short bullets). No large empty space.


2.6 PAGE 6 â€“ VALUATION SNAPSHOT


Title: Valuation Snapshot.


Show:


A table with: Price, 52W Range, PE TTM, PE Fwd, PS, PB, Dividend Yield, EV/EBITDA from report.valuation.




Below, a short paragraph commentary from report.valuation_text, emphasizing:


how current multiples compare to history and peers.




2.7 PAGE 7 â€“ VALUATION DETAIL & SENSITIVITY


Title: Valuation Framework.


First table: Historical Valuation:


Headers: Metric | Current | 5Y Low | 5Y High


Rows for PE, PS, EV/EBITDA (or show â€œN/Aâ€ if missing).




Second table: Scenario Targets using report.targets:


Columns: Scenario, Target Price, Upside / Downside, Assumptions.




Under each table, 1â€“2 paragraphs of explanation from report.valuation_text.


2.8 PAGE 8 â€“ PEER COMPARISON


Title: Peer Comparison.


Table with columns: Name, Ticker, Market Cap, PE Fwd, P/S, ROE, Comment.


Fill from report.peer_comparison or equivalent field. If fewer than 6 peers, still show at least 4 rows (fill with â€œN/Aâ€ if needed).


Below table: short comparison commentary (1â€“2 paragraphs) using valuation_text.


2.9 PAGE 9 â€“ FINANCIALS OVERVIEW


Title: Financial Overview.


Table with key financial metrics:


Revenue (TTM), Revenue 3Y CAGR, EPS (TTM & 3Y CAGR), Gross Margin, Operating Margin, Net Margin, ROE, ROA.




Below: paragraph summarizing financial health using report.fundamentals and valuation_text.


2.10 PAGE 10 â€“ FINANCIAL TRENDS (CHART PLACEHOLDERS)


Title: Financial Trends.


Use 2 fixed chart slots (even if you cannot load images, you can keep them as labeled grey boxes or inline img with data: or placeholder).


Chart 1: Revenue Last 5 Years.


Chart 2: EPS Last 5 Years.




Ensure the layout fills the page even if charts are static or use placeholder div blocks.


2.11 PAGE 11 â€“ CATALYSTS


Title: Key Catalysts.


Use report.catalysts_text split into 6â€“8 bullet points.


Each bullet: Short title â€“ 1â€“2 lines of description (truncate if needed).


Fill the entire page with these bullets; if less than 6 items, repeat or add standard â€œExecution of strategyâ€, â€œProduct rollout milestonesâ€, etc., but do not leave large blanks.


2.12 PAGE 12 â€“ RISKS


Title: Key Risks.


Same structure as Catalysts, but using report.risks_text.


Ensure exactly 6â€“8 items visible.


2.13 PAGE 13 â€“ TECHNICAL ANALYSIS


Title: Technical Analysis.


Upper half: text from report.tech_view_text split into 2â€“3 paragraphs: trend, momentum, levels.


Lower half: one chart area labeled â€œPrice & Volume (Last 12M)â€ (placeholder div or image).


Make sure the page is visually full (no big empty block).


2.14 PAGE 14 â€“ ACTION PLAN


Title: Investment Strategy.


Table with three strategy profiles:


Aggressive, Balanced, Conservative.


Columns: Entry Range, Target, Stop, Position Size, Notes.




Fill values from report.action_text by extracting ranges, or if not parseable, use standard default language (â€œUse pullbacks below Xâ€, â€œMaintain core holdingâ€, etc.).


2.15 PAGE 15 â€“ APPENDIX: KEY METRICS TABLE


Title: Appendix â€“ Detailed Metrics.


Table listing all metrics in report.valuation, price, fundamentals, techs.


This page is mainly numeric, used to fill space. No need for AI text here.


2.16 PAGE 16 â€“ APPENDIX: METHODOLOGY & MODEL NOTES


Title: Appendix â€“ Methodology & Model Notes.


3â€“4 paragraphs explaining:


Data sources (Finnhub, Twelve Data, etc.)


Multi-model approach (without exposing specific providers).


High-level description of valuation model.




This text can be mostly static, with a few dynamic inserts (e.g. asset_type, symbol).


2.17 PAGE 17 â€“ DISCLOSURES & DISCLAIMERS


Title: Disclaimers.


Use detailed, static legal text (can re-use and expand your current disclaimer).


Fill the whole page (no blank area).


2.18 OPTIONAL PAGES (IF NEEDED TO REACH 20â€“24 PAGES)
If needed to reach a consistent page count (e.g. 20 or 22 pages), you can add:


Appendix: Historical Events Timeline â€“ static template with a generic timeline layout and 4â€“5 items from thesis_text and catalysts_text.


Appendix: Glossary â€“ static glossary of AI/tech terms.


Important:
Whatever final page count you choose (e.g. 20 or 22 or 24), it must be constant across all reports, and there must be no pure blank pages.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6) WIRING & VERIFICATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6.1 Wire to v3.2 build:


Ensure buildResearchReport(symbol, assetType) returns the full v3.2 JSON (with multi-model content).


Ensure buildHtmlFromReport(report) uses buildFinalInstitutionalHtml(report).


6.2 Wire routes:


/v3/report/:symbol?format=html


Call buildResearchReport(symbol, assetType)


Return buildHtmlFromReport(report) as HTML.




/v3/report/:symbol?format=pdf


Call buildResearchReport(symbol, assetType)


const html = buildHtmlFromReport(report);


Use existing DocRaptor integration to generate PDF (test mode if needed).


Return the PDF.




6.3 Wire Telegram dev bot /report SYMBOL:


For /report SYMBOL:


Call buildResearchReport(symbol, assetType) (v3.2, multi-model).


Generate PDF using the final template.


Send the PDF to the user (no extra text needed except a short caption).




6.4 Verification (REQUIRED):
After implementing the Final Template v1.0:


Generate and inspect:


/v3/report/NVDA?format=pdf


/v3/report/AAPL?format=pdf


/v3/report/SPX?format=pdf




Confirm that:


All PDFs have the same fixed page count (e.g. 20 or 22 pages).


There are no pure blank pages.


Page 1 and 2 look like a professional Morgan-style cover + summary (no weird duplication).


All major sections described above are present, in order.


Tables and charts are visually aligned and fill the pages.


Do NOT modify v3.2 data logic from this template task.
Focus on making a fixed, institutional-grade layout that is stable and reusable.
Once done, please confirm and provide:


Page count and screenshot of pages 1â€“3 and a middle section page (e.g. Valuation, Financials, Risks).


Confirmation that /v3/report/NVDA?format=pdf and Telegram /report NVDA both use the new Final Template v1.0.



::contentReference[oaicite:0]{index=0}
