# 🚀 USIS Brain v6.0 - 生产环境部署指南

## 📋 部署类型：Reserved VM Deployment

**为什么选择Reserved VM？**
- ✅ **24/7运行**：唯一支持长时间运行Telegram Bot的方案
- ✅ **自动重启**：进程崩溃时自动恢复
- ✅ **开发/生产隔离**：发布创建代码快照，不影响开发环境
- ✅ **企业级稳定性**：适合金融分析系统的可靠性要求

---

## 🎯 一键部署步骤（5分钟）

### 1. 准备工作（已完成✅）
- [x] 生产启动脚本：`start_production.sh`
- [x] 健康检查端点：`/health`
- [x] 自动重启机制：内置进程监督
- [x] 崩溃日志：`/tmp/usis_crashes.log`

### 2. 发布到Reserved VM

#### 步骤1：打开部署界面
1. 点击Replit界面右上角的 **"Deploy"** 按钮
2. 选择 **"Reserved VM"** 部署类型

#### 步骤2：配置部署
```yaml
部署设置：
  类型: Reserved VM
  启动命令: bash start_production.sh
  端口: 5000
  健康检查: /health
  自动重启: 启用
```

#### 步骤3：环境变量（自动继承）
以下Secrets会自动从开发环境继承：
- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY`
- `GOOGLE_API_KEY`
- `TELEGRAM_BOT_TOKEN`
- `FINNHUB_API_KEY`
- `TWELVE_DATA_API_KEY`
- `DATABASE_URL`（独立的生产数据库）
- 其他所有在Secrets中配置的API密钥

#### 步骤4：发布
1. 点击 **"Deploy"** 按钮
2. 等待部署完成（约2-3分钟）
3. 获得生产URL：`https://your-app.replit.app`

---

## ✅ 部署验证

### 健康检查
```bash
curl https://your-app.replit.app/health
```

**预期响应**：
```json
{
  "ok": true,
  "status": "ok",
  "ts": 1234567890,
  "n8n": {
    "ok": true,
    "workflowCount": 6
  }
}
```

### Telegram Bot测试
在Telegram中发送消息给Bot：
```
/start
```

**预期响应**：
```
👋 欢迎使用USIS Brain v6.0！

🎯 我能做什么：
• 📊 实时股票分析（支持全球150+股票）
• 📈 K线图表+AI解读
• 🗺️ 市场热力图
• 💡 持仓操作建议

💬 直接说出你的需求，我来帮你分析！
```

---

## 📊 监控和日志

### 查看实时日志
在Replit部署界面：
1. 点击已部署的应用
2. 进入 **"Logs"** 标签页
3. 实时查看应用输出

### 崩溃日志
如果应用崩溃，会自动记录到：
```
/tmp/usis_crashes.log
```

### 进程监督
启动脚本内置进程监督：
- 每30秒检查进程状态
- 每30秒执行健康检查
- 自动重启崩溃的进程
- 记录所有崩溃日志

---

## 🔄 更新生产环境

### 方式1：重新部署（推荐）
1. 在开发环境修改代码并测试
2. 点击 **"Redeploy"** 按钮
3. 选择 **"Create new deployment"**
4. 新版本独立运行，可随时回滚

### 方式2：版本回滚
如果新版本有问题：
1. 进入部署历史
2. 选择之前的稳定版本
3. 点击 **"Rollback"** 恢复

---

## 🔒 开发/生产环境隔离

### 完全独立的两个世界

```
┌──────────────────────┐         ┌──────────────────────┐
│   开发环境            │         │   生产环境            │
│   (Workspace)        │         │   (Deployment)       │
├──────────────────────┤         ├──────────────────────┤
│ • 实时代码            │         │ • 代码快照           │
│ • *.replit.dev       │         │ • *.replit.app       │
│ • 开发数据库          │  独立   │ • 生产数据库         │
│ • 可随时修改          │ ─────→ │ • 稳定运行           │
│ • 测试新功能          │         │ • 服务用户           │
└──────────────────────┘         └──────────────────────┘
         ↓                                ↑
    修改代码                        点击"Redeploy"
         ↓                           创建新快照
    立即生效（仅开发）                     ↑
                                   生产环境更新
```

### 保证机制
- ❌ 开发环境的修改**永远不会**自动影响生产
- ✅ 只有点击"Redeploy"才会更新生产环境
- ✅ 两个环境使用独立的数据库
- ✅ 可以同时运行，互不干扰

---

## ⚙️ 高级配置

### 自定义域名
1. 进入部署设置
2. 点击 **"Custom Domain"**
3. 添加域名：`api.your-domain.com`
4. 配置DNS CNAME记录
5. 等待SSL证书生成（自动）

### 扩展资源
如需更多CPU/内存：
1. 升级Replit订阅计划
2. Reserved VM会自动分配更多资源

### 数据库备份
生产数据库自动备份：
- 每日自动备份
- 保留7天历史
- 在部署界面可手动触发

---

## 🐛 故障排查

### 问题1：部署失败
**症状**：点击Deploy后失败
**解决**：
```bash
# 检查start_production.sh语法
bash -n start_production.sh

# 检查index.js语法
node -c index.js
```

### 问题2：健康检查失败
**症状**：部署成功但标记为不健康
**解决**：
1. 查看部署日志
2. 检查端口5000是否正确监听
3. 确认`/health`端点返回200状态

### 问题3：Telegram Bot无响应
**症状**：Bot不回复消息
**解决**：
1. 检查`TELEGRAM_BOT_TOKEN`环境变量
2. 验证Bot在Telegram中启用
3. 查看日志中的Telegram轮询状态

### 问题4：频繁重启
**症状**：进程不断重启
**解决**：
1. 查看崩溃日志：`/tmp/usis_crashes.log`
2. 检查内存使用情况
3. 验证所有环境变量已正确设置

---

## 📞 技术支持

### 日志位置
- 应用日志：`/tmp/usis_production.log`
- 崩溃日志：`/tmp/usis_crashes.log`
- 进程监督日志：内置在主日志

### 关键指标
监控这些端点：
- `GET /health` - 整体健康状态
- `GET /brain/memory` - 系统记忆状态
- PostgreSQL连接数

### 性能优化
- 开启数据库连接池（已配置）
- 使用缓存减少API调用（已实现）
- N8N工作流按需加载（已优化）

---

## ✅ 部署检查清单

部署前确认：
- [ ] 所有环境变量已在Secrets中配置
- [ ] 数据库连接正常（开发环境测试通过）
- [ ] Telegram Bot Token有效
- [ ] 所有API密钥有效且有足够配额
- [ ] `start_production.sh`有执行权限

部署后验证：
- [ ] 健康检查返回200 OK
- [ ] Telegram Bot响应`/start`命令
- [ ] 可以查询股票信息
- [ ] 日志输出正常
- [ ] 无崩溃重启

---

**🎉 恭喜！您的USIS Brain v6.0已成功部署到生产环境！**

现在您可以：
- ✅ 继续在开发环境测试新功能
- ✅ 生产环境稳定服务用户
- ✅ 随时更新而不影响线上服务
- ✅ 享受企业级的可靠性和稳定性
